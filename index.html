<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>CIO DIGITAL ‚Äî Mesa de Opera√ß√µes</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
/* ================================================================
   CIO DIGITAL v2.1 ‚Äî Apple Liquid Glass Design System
   Fontes grandes, glassmorphism profundo, mobile-first
   ================================================================ */

@import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

:root {
  /* Espa√ßo profundo com gradiente vivo */
  --bg:      #050810;
  --bg2:     #080c18;
  --bg3:     #0c1220;

  /* Liquid Glass surfaces */
  --glass-1: rgba(255,255,255,.055);
  --glass-2: rgba(255,255,255,.09);
  --glass-3: rgba(255,255,255,.03);
  --border:  rgba(255,255,255,.11);
  --border-hi: rgba(255,255,255,.22);

  /* Typography */
  --t1: rgba(255,255,255,.97);
  --t2: rgba(255,255,255,.60);
  --t3: rgba(255,255,255,.30);

  /* Brand accents */
  --blue:   #3b9fff;
  --blue2:  #0a84ff;
  --green:  #32d74b;
  --red:    #ff453a;
  --amber:  #ffd60a;
  --purple: #bf5af2;
  --teal:   #5ac8fa;

  /* Glows */
  --glow-blue:   rgba(59,159,255,.22);
  --glow-green:  rgba(50,215,75,.18);
  --glow-red:    rgba(255,69,58,.18);
  --glow-amber:  rgba(255,214,10,.15);
  --glow-purple: rgba(191,90,242,.18);

  /* Radii */
  --r2:  8px;
  --r3:  14px;
  --r4:  20px;
  --r5:  28px;

  /* Transitions */
  --ease: cubic-bezier(.4,0,.2,1);
}

/* ---- RESET ---- */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }

body {
  font-family: 'Sora', -apple-system, sans-serif;
  font-size: 15px;
  line-height: 1.65;
  color: var(--t1);
  background: var(--bg);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* Ambient glow background */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 900px 600px at 10% 20%,  rgba(59,159,255,.09)  0%, transparent 70%),
    radial-gradient(ellipse 700px 500px at 90% 75%,  rgba(191,90,242,.07)  0%, transparent 65%),
    radial-gradient(ellipse 600px 400px at 50% 100%, rgba(50,215,75,.04)   0%, transparent 60%);
}

#app { position: relative; z-index: 1; }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,.12); border-radius: 4px; }

input,select,button,textarea { font-family: inherit; }

/* ================================================================
   LAYOUT
   ================================================================ */
.app { display: flex; min-height: 100vh; }

/* ================================================================
   SIDEBAR
   ================================================================ */
.sidebar {
  width: 260px;
  position: fixed; inset-block: 0; left: 0;
  z-index: 200;
  display: flex; flex-direction: column;
  overflow-y: auto;
  background: rgba(5,8,16,.88);
  backdrop-filter: blur(48px) saturate(180%);
  -webkit-backdrop-filter: blur(48px) saturate(180%);
  border-right: 1px solid var(--border);
  transition: transform .32s var(--ease);
}

.sidebar-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.55); backdrop-filter: blur(5px);
  z-index: 199;
}

.main { margin-left: 260px; flex: 1; padding: 40px 44px; min-height: 100vh; }

/* Hamburger */
.hamburger {
  display: none; position: fixed; top: 16px; left: 16px; z-index: 201;
  width: 46px; height: 46px;
  background: rgba(8,12,24,.85);
  border: 1px solid var(--border);
  border-radius: var(--r3); backdrop-filter: blur(24px);
  cursor: pointer; flex-direction: column; align-items: center;
  justify-content: center; gap: 6px; padding: 13px;
}
.hamburger span { display: block; width: 100%; height: 2px; background: var(--t2); border-radius: 2px; transition: all .2s; }

/* ================================================================
   SIDEBAR LOGO
   ================================================================ */
.sb-logo {
  padding: 26px 22px 20px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(59,159,255,.04) 0%, transparent 100%);
}

.sb-name {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 20px; font-weight: 700; letter-spacing: 5px; line-height: 1;
  background: linear-gradient(135deg, #fff 20%, var(--blue) 60%, var(--purple) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.sb-ver { font-size: 10px; color: var(--t3); letter-spacing: 2px; text-transform: uppercase; margin-top: 4px; font-weight: 500; }

.sb-aistat {
  display: flex; align-items: center; gap: 8px;
  margin-top: 12px; padding: 8px 12px;
  background: var(--glass-3); border: 1px solid var(--border);
  border-radius: var(--r2);
}

.ai-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.ai-dot.on  { background: var(--green); animation: dot-pulse 2.5s ease-in-out infinite; }
.ai-dot.off { background: var(--red); }

@keyframes dot-pulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(50,215,75,.6); }
  50%      { box-shadow: 0 0 0 5px rgba(50,215,75,0); }
}

.ai-label { font-size: 12px; color: var(--t2); font-weight: 500; }

/* ================================================================
   NAV
   ================================================================ */
.sb-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
.nav-section { margin-bottom: 6px; }
.nav-title {
  font-size: 9px; font-weight: 700; letter-spacing: 2.5px;
  text-transform: uppercase; color: var(--t3);
  padding: 10px 22px 4px;
}
.nav-item {
  display: flex; align-items: center; gap: 12px;
  margin: 2px 10px; padding: 11px 14px;
  border-radius: var(--r3); cursor: pointer;
  color: var(--t2); font-size: 14px; font-weight: 500;
  transition: all .15s var(--ease); user-select: none;
}
.nav-item:hover { background: var(--glass-1); color: var(--t1); }
.nav-item.active {
  background: rgba(59,159,255,.12); color: var(--blue);
  box-shadow: inset 0 0 0 1px rgba(59,159,255,.25);
}
.nav-icon { font-size: 17px; flex-shrink: 0; width: 22px; text-align: center; }

/* ================================================================
   SIDEBAR BOTTOM
   ================================================================ */
.sb-bottom { padding: 14px; border-top: 1px solid var(--border); }

.nokey-badge {
  padding: 11px 14px; margin-bottom: 10px; cursor: pointer; transition: all .15s;
  background: rgba(255,69,58,.09); border: 1px solid rgba(255,69,58,.25); border-radius: var(--r3);
}
.nokey-badge:hover { background: rgba(255,69,58,.15); }
.nokey-title { font-size: 12px; color: var(--red); font-weight: 700; margin-bottom: 2px; }
.nokey-sub   { font-size: 11px; color: var(--t3); }

.key-ok-badge {
  padding: 9px 12px; margin-bottom: 10px;
  background: var(--glow-green); border: 1px solid rgba(50,215,75,.22); border-radius: var(--r3);
  display: flex; align-items: center; gap: 8px;
}

.user-area {
  display: flex; align-items: center; gap: 11px; margin-bottom: 10px;
  padding: 10px 12px; background: var(--glass-3);
  border: 1px solid var(--border); border-radius: var(--r3);
}
.user-av {
  width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;
  background: linear-gradient(135deg, var(--blue2), var(--purple));
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; color: #fff;
}
.user-name { font-size: 14px; font-weight: 600; color: var(--t1); }
.user-role { font-size: 10px; color: var(--t3); letter-spacing: .5px; }

.btn-logout {
  width: 100%; padding: 10px; background: transparent;
  border: 1px solid var(--border); border-radius: var(--r2);
  color: var(--t3); font-size: 13px; font-weight: 500; cursor: pointer;
  transition: all .15s;
}
.btn-logout:hover { border-color: var(--red); color: var(--red); background: rgba(255,69,58,.06); }

/* ================================================================
   PAGE HEADER
   ================================================================ */
.page-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 32px; gap: 18px; flex-wrap: wrap;
}
.page-title {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 32px; font-weight: 700; letter-spacing: -.5px; color: var(--t1); line-height: 1;
}
.page-sub { font-size: 14px; color: var(--t2); margin-top: 5px; font-weight: 400; }

/* ================================================================
   GLASS CARDS
   ================================================================ */
.card {
  background: var(--glass-1);
  border: 1px solid var(--border);
  border-radius: var(--r4);
  padding: 26px;
  position: relative; overflow: hidden;
  margin-bottom: 18px;
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  transition: border-color .2s, box-shadow .2s;
}
.card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.18) 50%, transparent 100%);
}
.card:hover { border-color: var(--border-hi); box-shadow: 0 12px 56px rgba(0,0,0,.35); }

/* Accent strips */
.card-blue::after   { content:''; position:absolute; top:0; left:24px; width:60px; height:2px; background:var(--blue);   border-radius:0 0 2px 2px; opacity:.8; }
.card-gold::after   { content:''; position:absolute; top:0; left:24px; width:60px; height:2px; background:var(--amber);  border-radius:0 0 2px 2px; opacity:.8; }
.card-green::after  { content:''; position:absolute; top:0; left:24px; width:60px; height:2px; background:var(--green);  border-radius:0 0 2px 2px; opacity:.8; }
.card-red::after    { content:''; position:absolute; top:0; left:24px; width:60px; height:2px; background:var(--red);    border-radius:0 0 2px 2px; opacity:.8; }
.card-purple::after { content:''; position:absolute; top:0; left:24px; width:60px; height:2px; background:var(--purple); border-radius:0 0 2px 2px; opacity:.8; }

.card-title {
  font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
  color: var(--t3); display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
}
.card-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--t3);
  background: var(--glass-3); padding: 3px 9px; border-radius: 6px; border: 1px solid var(--border);
}

/* ================================================================
   GRID
   ================================================================ */
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
.col2  { grid-column: 1 / -1; }

/* ================================================================
   BUTTONS
   ================================================================ */
.btn {
  padding: 12px 24px; border: none; border-radius: var(--r3);
  font-weight: 600; font-size: 15px; cursor: pointer;
  transition: all .2s var(--ease); display: inline-flex;
  align-items: center; gap: 8px; white-space: nowrap; letter-spacing: .1px;
}
.btn-primary {
  background: linear-gradient(135deg, var(--blue2) 0%, #007aff 100%);
  color: #fff; box-shadow: 0 4px 24px var(--glow-blue);
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 32px var(--glow-blue); }

.btn-green {
  background: linear-gradient(135deg, var(--green) 0%, #28a745 100%);
  color: #fff; box-shadow: 0 4px 24px var(--glow-green);
}
.btn-green:hover { transform: translateY(-1px); box-shadow: 0 8px 32px var(--glow-green); }

.btn-secondary {
  background: var(--glass-1); border: 1px solid var(--border);
  color: var(--t2); padding: 10px 20px; font-size: 14px;
  backdrop-filter: blur(12px);
}
.btn-secondary:hover { background: var(--glass-2); color: var(--t1); border-color: var(--border-hi); }
.btn:disabled { opacity: .38; cursor: not-allowed; transform: none !important; }

/* ================================================================
   BANNERS
   ================================================================ */
.banner {
  padding: 14px 18px; border-radius: var(--r3); font-size: 14px;
  margin-bottom: 18px; display: flex; align-items: center;
  gap: 10px; font-weight: 500; backdrop-filter: blur(12px);
}
.banner-warn { background: var(--glow-amber); border: 1px solid rgba(255,214,10,.22); color: var(--amber); }
.banner-err  { background: var(--glow-red);   border: 1px solid rgba(255,69,58,.22);  color: var(--red);   }
.banner-ok   { background: var(--glow-green); border: 1px solid rgba(50,215,75,.22);  color: var(--green); }

/* ================================================================
   FORMS
   ================================================================ */
.fg { margin-bottom: 20px; }
.fg label {
  display: block; font-size: 11px; font-weight: 700; letter-spacing: 1.8px;
  text-transform: uppercase; color: var(--t3); margin-bottom: 8px;
}
.input {
  width: 100%; padding: 14px 18px;
  background: rgba(255,255,255,.055); border: 1px solid var(--border);
  border-radius: var(--r3); color: var(--t1);
  font-family: 'JetBrains Mono', monospace; font-size: 15px;
  outline: none; transition: all .2s;
}
.input:focus { border-color: var(--blue); background: rgba(59,159,255,.06); box-shadow: 0 0 0 4px rgba(59,159,255,.12); }
.input.valid   { border-color: var(--green); }
.input.invalid { border-color: var(--red); }

.select {
  width: 100%; padding: 14px 18px;
  background: rgba(255,255,255,.055); border: 1px solid var(--border);
  border-radius: var(--r3); color: var(--t1); font-size: 15px;
  outline: none; cursor: pointer;
}
.hint { font-size: 12px; color: var(--t3); margin-top: 6px; }

/* ================================================================
   PROFILE BUTTONS (dashboard)
   ================================================================ */
.profile-row { display: flex; gap: 8px; flex-wrap: wrap; }
.pbtn {
  padding: 9px 18px; border-radius: 50px; font-size: 13px; font-weight: 600;
  cursor: pointer; border: 1px solid var(--border); background: var(--glass-3); color: var(--t2);
  transition: all .15s;
}
.pbtn.C.on { border-color: var(--green);  color: var(--green);  background: var(--glow-green);  box-shadow: 0 0 16px var(--glow-green); }
.pbtn.S.on { border-color: var(--amber);  color: var(--amber);  background: var(--glow-amber);  box-shadow: 0 0 16px var(--glow-amber); }
.pbtn.A.on { border-color: var(--red);    color: var(--red);    background: var(--glow-red);    box-shadow: 0 0 16px var(--glow-red); }

/* ================================================================
   PIPELINE TOGGLE
   ================================================================ */
.pipe-toggle {
  display: flex; background: var(--glass-3); border: 1px solid var(--border);
  border-radius: var(--r3); overflow: hidden; width: fit-content;
}
.pipe-btn {
  padding: 10px 20px; font-size: 14px; font-weight: 600;
  cursor: pointer; border: none; background: transparent; color: var(--t2); transition: all .15s;
}
.pipe-btn.on { background: linear-gradient(135deg, var(--blue2), #007aff); color: #fff; }

/* ================================================================
   TAB BAR
   ================================================================ */
.tab-bar {
  display: flex; background: var(--glass-3); border: 1px solid var(--border);
  border-radius: var(--r3); overflow: hidden; width: fit-content; margin-bottom: 22px;
}
.tab-btn {
  padding: 10px 20px; font-size: 14px; font-weight: 600;
  cursor: pointer; border: none; background: transparent; color: var(--t2); transition: all .15s;
}
.tab-btn.on { background: linear-gradient(135deg, var(--blue2), #007aff); color: #fff; }

/* ================================================================
   SPINNER / LOADING
   ================================================================ */
.spinner-wrap { display: flex; flex-direction: column; align-items: center; padding: 90px 24px; }
.spinner {
  width: 52px; height: 52px;
  border: 2.5px solid var(--border); border-top-color: var(--blue);
  border-radius: 50%; animation: spin .75s linear infinite; margin-bottom: 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.prog-item { display: flex; align-items: center; gap: 11px; padding: 6px 0; font-size: 15px; font-weight: 500; }
.prog-item.done    { color: var(--green); }
.prog-item.running { color: var(--blue);  }
.prog-item.pending { color: var(--t3);    }

/* ================================================================
   EMPTY STATE
   ================================================================ */
.empty-state { text-align: center; padding: 90px 24px; }
.empty-icon  { font-size: 56px; margin-bottom: 18px; opacity: .2; }
.empty-title { font-size: 20px; color: var(--t2); margin-bottom: 8px; font-weight: 600; }
.empty-sub   { font-size: 15px; color: var(--t3); max-width: 360px; margin: 0 auto; line-height: 1.7; }

/* ================================================================
   SNAPSHOT BAR
   ================================================================ */
.snap-bar {
  background: var(--glass-3); border: 1px solid var(--border);
  border-radius: var(--r4); padding: 18px 22px; margin-bottom: 26px;
  backdrop-filter: blur(24px);
}
.snap-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.snap-lbl    { font-size: 10px; color: var(--t3); letter-spacing: 2px; text-transform: uppercase; font-weight: 700; }
.snap-grid   { display: flex; gap: 10px; flex-wrap: wrap; }
.snap-item {
  background: var(--glass-1); border: 1px solid var(--border);
  border-radius: var(--r3); padding: 14px 18px; min-width: 120px;
}
.snap-sym { font-size: 10px; color: var(--t3); letter-spacing: 1.2px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
.snap-val { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; }
.snap-chg { font-size: 12px; font-family: 'JetBrains Mono', monospace; margin-top: 3px; font-weight: 600; }
.pos { color: var(--green); }
.neg { color: var(--red);   }

/* ================================================================
   OPPORTUNITY CARDS
   ================================================================ */
.opp-card {
  background: var(--glass-3); border: 1px solid var(--border);
  border-radius: var(--r4); padding: 22px; margin-bottom: 14px;
  transition: all .2s; backdrop-filter: blur(14px);
}
.opp-card:hover { background: var(--glass-1); border-color: var(--border-hi); transform: translateY(-1px); }

.opp-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.opp-cls { font-size: 11px; color: var(--blue); font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; }
.opp-act { padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; letter-spacing: .4px; }
.act-mon { background: var(--glow-amber); color: var(--amber); border: 1px solid rgba(255,214,10,.25); }
.act-sim { background: var(--glow-blue);  color: var(--blue);  border: 1px solid rgba(59,159,255,.28); }

.opp-thesis  { font-size: 16px; font-weight: 500; margin-bottom: 12px; line-height: 1.55; }
.opp-detail  { font-size: 13px; color: var(--t2); margin-bottom: 6px; }
.opp-detail strong { font-size: 9px; color: var(--t3); letter-spacing: 1px; text-transform: uppercase; display: block; margin-bottom: 2px; }
.opp-risks   { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
.risk-tag    { padding: 3px 10px; background: rgba(255,69,58,.08); border: 1px solid rgba(255,69,58,.22); border-radius: 50px; font-size: 12px; color: var(--red); font-weight: 500; }
.conf-badge  { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; margin-top: 10px; }
.conf-high   { background: var(--glow-green);  color: var(--green);  border: 1px solid rgba(50,215,75,.25); }
.conf-med    { background: var(--glow-amber);  color: var(--amber);  border: 1px solid rgba(255,214,10,.25); }
.conf-low    { background: var(--glow-red);    color: var(--red);    border: 1px solid rgba(255,69,58,.25); }

/* ================================================================
   SEMAFORO
   ================================================================ */
.sema { display: flex; align-items: center; gap: 9px; margin-bottom: 18px; }
.sema-dot { width: 15px; height: 15px; border-radius: 50%; opacity: .16; transition: all .4s; }
.sema-dot.on { opacity: 1; }
.verde    { background: var(--green);  }
.verde.on   { box-shadow: 0 0 14px var(--green),  0 0 28px var(--glow-green); }
.amarelo  { background: var(--amber);  }
.amarelo.on { box-shadow: 0 0 14px var(--amber),  0 0 28px var(--glow-amber); }
.vermelho { background: var(--red);    }
.vermelho.on{ box-shadow: 0 0 14px var(--red),    0 0 28px var(--glow-red);   }
.sema-label { font-size: 15px; font-weight: 700; margin-left: 4px; }

.thermo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.thermo-item { background: var(--glass-3); border: 1px solid var(--border); border-radius: var(--r3); padding: 15px; }
.thermo-lbl  { font-size: 10px; color: var(--t3); letter-spacing: 1.2px; text-transform: uppercase; margin-bottom: 7px; font-weight: 700; }
.thermo-val  { font-size: 17px; font-weight: 700; }

/* ================================================================
   CHECKLIST
   ================================================================ */
.check-grid  { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
.check-title { font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 12px; color: var(--t3); }
.check-item  {
  display: flex; align-items: flex-start; gap: 9px;
  padding: 9px 0; font-size: 14px; color: var(--t2);
  border-bottom: 1px solid rgba(255,255,255,.04);
}
.check-item:last-child { border-bottom: none; }

/* ================================================================
   PLAN GRID
   ================================================================ */
.plan-grid   { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 12px; }
.plan-card   { background: var(--glass-3); border: 1px solid var(--border); border-radius: var(--r3); padding: 16px; }
.plan-cls    { font-size: 11px; color: var(--blue); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.plan-posture{ padding: 3px 10px; border-radius: 50px; font-size: 10px; font-weight: 700; float: right; }
.plan-def    { background: rgba(255,69,58,.12);  color: var(--red);   border: 1px solid rgba(255,69,58,.22); }
.plan-neu    { background: var(--glow-amber);    color: var(--amber); border: 1px solid rgba(255,214,10,.22); }
.plan-ofe    { background: var(--glow-green);    color: var(--green); border: 1px solid rgba(50,215,75,.22); }

/* ================================================================
   DATA TABLE
   ================================================================ */
.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  text-align: left; padding: 12px 16px;
  font-size: 11px; color: var(--t3); letter-spacing: 1.5px;
  text-transform: uppercase; border-bottom: 1px solid var(--border); font-weight: 700;
}
.data-table td {
  padding: 14px 16px; font-size: 14px; color: var(--t2);
  border-bottom: 1px solid rgba(255,255,255,.04);
  font-family: 'JetBrains Mono', monospace;
}
.data-table tr:hover td { background: rgba(255,255,255,.02); }

/* ================================================================
   AGENTS
   ================================================================ */
.agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px,1fr)); gap: 18px; }
.agent-card { background: var(--glass-1); border: 1px solid var(--border); border-radius: var(--r4); padding: 22px; backdrop-filter: blur(24px); transition: all .2s; }
.agent-card:hover { border-color: var(--border-hi); box-shadow: 0 10px 48px rgba(0,0,0,.35); }
.agent-name  { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; color: var(--blue); margin-bottom: 4px; }
.agent-ver   { font-size: 11px; color: var(--t3); margin-bottom: 9px; }
.agent-desc  { font-size: 14px; color: var(--t2); line-height: 1.65; margin-bottom: 12px; }
.agent-style { padding: 4px 10px; border-radius: 50px; font-size: 12px; background: var(--glow-purple); border: 1px solid rgba(191,90,242,.2); color: var(--purple); margin-right: 4px; margin-bottom: 4px; display: inline-block; font-weight: 500; }
.ptag        { padding: 4px 10px; border-radius: 50px; font-size: 11px; font-weight: 700; display: inline-block; margin-right: 4px; }
.ptag-d      { background: var(--glow-blue);   color: var(--blue);   border: 1px solid rgba(59,159,255,.22); }
.ptag-dd     { background: var(--glow-purple);  color: var(--purple); border: 1px solid rgba(191,90,242,.22); }
.agent-result{ margin-top: 14px; padding: 12px 14px; background: rgba(0,0,0,.38); border: 1px solid var(--border); border-radius: 12px; font-size: 12px; color: var(--t2); font-family: 'JetBrains Mono', monospace; line-height: 1.65; max-height: 130px; overflow-y: auto; }

/* ================================================================
   PORTFOLIO
   ================================================================ */
.slider-row { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
.slider-row label { font-size: 15px; color: var(--t2); width: 155px; flex-shrink: 0; font-weight: 500; }
.slider-row input[type=range] { flex: 1; accent-color: var(--blue); height: 4px; cursor: pointer; }
.slider-val  { font-family: 'JetBrains Mono', monospace; font-size: 15px; color: var(--blue); width: 52px; text-align: right; font-weight: 600; }

.alloc-grid  { display: grid; grid-template-columns: repeat(auto-fill, minmax(148px,1fr)); gap: 12px; margin-top: 22px; }
.alloc-card  { background: var(--glass-3); border: 1px solid var(--border); border-radius: var(--r4); padding: 18px; backdrop-filter: blur(12px); }
.alloc-cls   { font-size: 11px; color: var(--t3); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 7px; font-weight: 700; }
.alloc-pct   { font-family: 'JetBrains Mono', monospace; font-size: 30px; font-weight: 700; color: var(--blue); line-height: 1; }
.alloc-bar   { height: 3px; background: rgba(255,255,255,.07); border-radius: 2px; margin-top: 12px; overflow: hidden; }
.alloc-fill  { height: 100%; background: linear-gradient(90deg, var(--blue2), var(--purple)); border-radius: 2px; transition: width .5s var(--ease); }

/* ================================================================
   MISC
   ================================================================ */
.disclaimer {
  background: rgba(255,214,10,.04); border: 1px solid rgba(255,214,10,.1);
  border-radius: var(--r3); padding: 15px 18px; font-size: 13px;
  color: rgba(255,214,10,.65); line-height: 1.7; margin-top: 28px;
}

.sql-block {
  background: rgba(0,0,0,.45); border: 1px solid var(--border); border-radius: var(--r3);
  padding: 18px; font-family: 'JetBrains Mono', monospace; font-size: 12px;
  color: var(--t2); line-height: 1.9; overflow: auto; white-space: pre; max-height: 300px;
}
.copy-btn {
  padding: 7px 15px; font-size: 12px; font-weight: 600;
  background: var(--glass-1); border: 1px solid var(--border);
  color: var(--t2); border-radius: 10px; cursor: pointer; transition: all .15s;
}
.copy-btn:hover { background: var(--glass-2); color: var(--t1); border-color: var(--blue); }

.tag { padding: 3px 10px; border-radius: 50px; font-size: 12px; background: var(--glass-1); border: 1px solid var(--border); color: var(--t3); font-weight: 500; }

/* ================================================================
   KEY HERO
   ================================================================ */
.key-hero {
  text-align: center; padding: 48px 32px 40px;
  background: var(--glass-3); border: 1px solid var(--border);
  border-radius: var(--r5); margin-bottom: 24px; position: relative; overflow: hidden;
}
.key-hero::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse 70% 60% at 50% -10%, rgba(59,159,255,.14), transparent 65%); pointer-events:none; }
.key-hero-icon  { font-size: 58px; margin-bottom: 16px; }
.key-hero-title { font-family: 'Space Grotesk', sans-serif; font-size: 30px; font-weight: 700; color: var(--t1); margin-bottom: 10px; letter-spacing: -.3px; }
.key-hero-sub   { font-size: 15px; color: var(--t2); max-width: 460px; margin: 0 auto; line-height: 1.7; }

/* ================================================================
   PROVIDERS
   ================================================================ */
.prov-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 20px; }
.prov-card { background: var(--glass-3); border: 2px solid var(--border); border-radius: var(--r4); padding: 20px; cursor: pointer; transition: all .2s; }
.prov-card:hover { background: var(--glass-1); border-color: var(--border-hi); }
.prov-card.on { border-color: var(--blue); background: rgba(59,159,255,.08); box-shadow: 0 0 24px rgba(59,159,255,.14); }
.prov-logo  { font-size: 28px; margin-bottom: 11px; }
.prov-name  { font-size: 15px; font-weight: 700; color: var(--t1); margin-bottom: 5px; }
.prov-desc  { font-size: 12px; color: var(--t3); line-height: 1.65; }

.key-steps  { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 14px; margin-bottom: 20px; }
.key-step   { background: var(--glass-3); border: 1px solid var(--border); border-radius: var(--r4); padding: 20px; }
.ks-num     { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; color: var(--blue); margin-bottom: 8px; line-height: 1; }
.ks-title   { font-size: 15px; font-weight: 700; color: var(--t1); margin-bottom: 6px; }
.ks-desc    { font-size: 13px; color: var(--t3); line-height: 1.7; }
.ks-link    { font-size: 13px; color: var(--blue); text-decoration: none; display: inline-block; margin-top: 7px; font-weight: 500; }
.ks-link:hover { text-decoration: underline; }

.key-input-wrap { position: relative; }
.key-input-wrap .input { padding-right: 52px; }
.key-eye { position:absolute; right:16px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--t3); cursor:pointer; font-size:18px; padding:0; transition: color .15s; }
.key-eye:hover { color: var(--t1); }

/* ================================================================
   LOGIN
   ================================================================ */
.login-wrap {
  display: flex; align-items: center; justify-content: center;
  min-height: 100vh; padding: 24px;
}
.login-card {
  width: 100%; max-width: 430px;
  padding: 56px 48px;
  background: rgba(5,8,16,.86); border: 1px solid var(--border);
  border-radius: var(--r5);
  box-shadow: 0 0 120px rgba(59,159,255,.07), 0 48px 120px rgba(0,0,0,.7);
  backdrop-filter: blur(60px); position: relative; overflow: hidden;
}
.login-card::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent); }
.login-card::after  { content:''; position:absolute; inset:0; background:radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59,159,255,.1), transparent 70%); pointer-events:none; z-index:0; }
.login-card > * { position: relative; z-index: 1; }

.login-logo { text-align: center; margin-bottom: 42px; }
.login-name {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 46px; font-weight: 700; letter-spacing: 8px; line-height: 1;
  background: linear-gradient(135deg, #fff 10%, var(--blue) 55%, var(--purple) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.login-line { width: 72px; height: 1px; background: linear-gradient(90deg, transparent, var(--blue), transparent); margin: 12px auto; }
.login-sub  { font-size: 11px; color: var(--t3); letter-spacing: 3.5px; text-transform: uppercase; font-weight: 600; }

.login-fg { margin-bottom: 18px; }
.login-fg label { display: block; font-size: 11px; color: var(--t3); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
.login-fg input {
  width: 100%; padding: 15px 18px;
  background: rgba(255,255,255,.055); border: 1px solid var(--border);
  border-radius: var(--r3); color: var(--t1);
  font-family: 'JetBrains Mono', monospace; font-size: 16px; outline: none; transition: all .2s;
}
.login-fg input:focus { border-color: var(--blue); box-shadow: 0 0 0 4px rgba(59,159,255,.13); background: rgba(59,159,255,.05); }

.login-btn {
  width: 100%; padding: 17px;
  background: linear-gradient(135deg, var(--blue2), #007aff);
  color: #fff; border: none; border-radius: var(--r3);
  font-size: 16px; font-weight: 700; cursor: pointer;
  transition: all .2s; box-shadow: 0 6px 28px var(--glow-blue); letter-spacing: .2px;
}
.login-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 36px var(--glow-blue); }
.login-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }
.login-err  { color: var(--red); font-size: 14px; margin-top: 10px; text-align: center; min-height: 20px; }
.login-note { margin-top: 22px; padding: 13px 17px; background: rgba(255,214,10,.04); border: 1px solid rgba(255,214,10,.1); border-radius: var(--r3); font-size: 12px; color: rgba(255,255,255,.3); line-height: 1.7; text-align: center; }

/* ================================================================
   DB STATUS / INFO
   ================================================================ */
.db-status { display: flex; align-items: center; gap: 10px; padding: 13px 18px; border-radius: var(--r3); margin-bottom: 18px; font-size: 14px; font-weight: 500; }
.db-ok  { background: var(--glow-green); border: 1px solid rgba(50,215,75,.22);  color: var(--green); }
.db-err { background: var(--glow-red);   border: 1px solid rgba(255,69,58,.22);  color: var(--red);   }
.db-off { background: var(--glass-3);    border: 1px solid var(--border);        color: var(--t3);    }

.info-row   { display: flex; justify-content: space-between; align-items: center; padding: 13px 0; border-bottom: 1px solid rgba(255,255,255,.05); }
.info-label { font-size: 15px; color: var(--t2); font-weight: 500; }
.info-val   { font-size: 14px; color: var(--blue); font-family: 'JetBrains Mono', monospace; font-weight: 500; }

.filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 24px; }
.filter-btn { padding: 8px 18px; border-radius: 50px; font-size: 14px; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: var(--glass-3); color: var(--t2); transition: all .15s; }
.filter-btn.on { border-color: var(--blue); color: var(--blue); background: var(--glow-blue); }

.profile-cards { display: grid; grid-template-columns: repeat(3,1fr); gap: 18px; }
.profile-card  { background: var(--glass-1); border: 2px solid var(--border); border-radius: var(--r4); padding: 26px; cursor: pointer; transition: all .22s; backdrop-filter: blur(24px); }
.profile-card:hover { transform: translateY(-2px); box-shadow: 0 16px 56px rgba(0,0,0,.4); border-color: var(--border-hi); }

/* ================================================================
   MOBILE BOTTOM NAV
   ================================================================ */
.mobile-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(5,8,16,.94);
  backdrop-filter: blur(36px) saturate(200%);
  border-top: 1px solid var(--border);
  padding: 10px 4px calc(10px + env(safe-area-inset-bottom));
  z-index: 300; justify-content: space-around;
}
.mnav-item {
  display: flex; flex-direction: column; align-items: center;
  gap: 4px; padding: 6px 10px; cursor: pointer;
  border-radius: 12px; transition: all .15s; min-width: 54px;
}
.mnav-item.active { background: rgba(59,159,255,.14); }
.mnav-icon  { font-size: 22px; }
.mnav-label { font-size: 10px; color: var(--t3); font-weight: 700; letter-spacing: .3px; text-transform: uppercase; }
.mnav-item.active .mnav-label { color: var(--blue); }

/* ================================================================
   RESPONSIVE ‚Äî TABLET 1024px
   ================================================================ */
@media (max-width: 1100px) {
  .sidebar { width: 238px; }
  .main { margin-left: 238px; padding: 32px 28px; }
  .prov-grid { grid-template-columns: 1fr 1fr; }
}

/* ================================================================
   RESPONSIVE ‚Äî MOBILE 768px
   ================================================================ */
@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); width: 285px; box-shadow: none; }
  .sidebar.open { transform: translateX(0); box-shadow: 20px 0 60px rgba(0,0,0,.7); }
  .sidebar-overlay.show { display: block; }
  .hamburger { display: flex; }

  .main { margin-left: 0; padding: 76px 18px 100px; }

  .page-title { font-size: 26px; }
  .page-sub   { font-size: 13px; }
  .page-header { flex-direction: column; align-items: flex-start; gap: 14px; margin-bottom: 22px; }
  .page-header > div:last-child { width: 100%; align-items: flex-start !important; }

  .pbtn      { padding: 8px 14px; font-size: 12px; }
  .pipe-toggle { width: 100%; }
  .pipe-btn    { flex: 1; text-align: center; font-size: 13px; }

  .grid2 { grid-template-columns: 1fr; gap: 14px; }
  .col2  { grid-column: 1; }

  .check-grid   { grid-template-columns: 1fr; gap: 14px; }
  .thermo-grid  { grid-template-columns: 1fr 1fr; }

  .card { padding: 18px; border-radius: 18px; }

  .snap-item { min-width: 95px; padding: 11px 13px; }
  .snap-val  { font-size: 16px; }

  .profile-cards { grid-template-columns: 1fr; }
  .prov-grid     { grid-template-columns: 1fr; }
  .agent-grid    { grid-template-columns: 1fr; }
  .plan-grid     { grid-template-columns: 1fr 1fr; }
  .alloc-grid    { grid-template-columns: repeat(2,1fr); }

  .slider-row label { width: 110px; font-size: 14px; }
  .key-steps { grid-template-columns: 1fr 1fr; }

  .login-card { padding: 40px 26px; }
  .login-name { font-size: 40px; letter-spacing: 5px; }

  .tab-bar { width: 100%; }
  .tab-btn { flex: 1; text-align: center; font-size: 13px; padding: 10px 6px; }

  .mobile-nav { display: flex; }

  .btn { font-size: 14px; padding: 12px 20px; }
  .btn-secondary { font-size: 13px; padding: 10px 16px; }

  .data-table th, .data-table td { padding: 11px 12px; font-size: 13px; }
}

@media (max-width: 400px) {
  .key-steps     { grid-template-columns: 1fr; }
  .plan-grid     { grid-template-columns: 1fr; }
  .main          { padding: 76px 14px 100px; }
}


/* ---- MARKET SIGNAL HIGHLIGHT ---- */
.signal-buy  { background: rgba(50,215,75,.12); border: 2px solid rgba(50,215,75,.4); }
.signal-sell { background: rgba(255,69,58,.12);  border: 2px solid rgba(255,69,58,.4); }
.signal-wait { background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.12); }
.action-chip {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 14px; border-radius: 50px; font-size: 13px; font-weight: 800;
  letter-spacing: .5px; margin-bottom: 8px;
}
.chip-buy    { background: rgba(50,215,75,.18);  color: #32d74b; border: 1px solid rgba(50,215,75,.4); }
.chip-sell   { background: rgba(255,69,58,.18);  color: #ff453a; border: 1px solid rgba(255,69,58,.4); }
.chip-wait   { background: rgba(255,255,255,.06); color: rgba(255,255,255,.55); border: 1px solid rgba(255,255,255,.15); }
.chip-hold   { background: rgba(255,214,10,.12); color: #ffd60a; border: 1px solid rgba(255,214,10,.3); }
.mkt-card {
  background: rgba(255,255,255,.055);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 18px; padding: 18px 20px;
  transition: all .2s; position: relative; overflow: hidden;
}
.mkt-card:hover { background: rgba(255,255,255,.09); transform: translateY(-1px); }
.mkt-price { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 700; color: var(--t1); line-height: 1; margin: 8px 0 4px; }
.mkt-change-pos { font-size: 13px; font-weight: 700; color: #32d74b; }
.mkt-change-neg { font-size: 13px; font-weight: 700; color: #ff453a; }
.mkt-change-neu { font-size: 13px; font-weight: 600; color: rgba(255,255,255,.4); }
.mkt-name { font-size: 13px; font-weight: 600; color: rgba(255,255,255,.7); line-height: 1.3; }
.mkt-icon { font-size: 24px; margin-bottom: 6px; display: block; }
.mkt-source { font-size: 9px; color: rgba(255,255,255,.25); position: absolute; top: 10px; right: 12px; }
.mkt-signal-bar {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,.07);
}
.hero-action {
  background: linear-gradient(135deg, rgba(10,132,255,.15), rgba(191,90,242,.1));
  border: 1px solid rgba(59,159,255,.3); border-radius: 20px;
  padding: 24px 28px; margin-bottom: 20px; position: relative; overflow: hidden;
}
.hero-action::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, var(--blue2), var(--purple));
}
.big-signal { font-size: 18px; font-weight: 800; }
.pulse-green { animation: pulse-green .8s ease-in-out 3; }
@keyframes pulse-green {
  0%,100% { box-shadow: 0 0 0 0 rgba(50,215,75,.4); }
  50% { box-shadow: 0 0 0 12px rgba(50,215,75,0); }
}

</style>
</head>
<body>
<div id="app"></div>
<script>
// ================================================================
// CIO DIGITAL v3.0 - MESA DE OPERACOES - DADOS REAIS
// ================================================================
var APP_VERSION = '3.0.0';

// ================================================================
// PERFIS DE RISCO
// ================================================================
var RISK_PROFILES = {
  CONSERVADOR: {
    label: 'Conservador', color: '#32d74b', short: 'C',
    allowed: ['Renda Fixa','Tesouro','LCI/LCA','CDB'],
    blocked: ['Cripto','Alavancagem','Acoes especulativas'],
    max_risk: 'baixo', min_conf: 'alta', mode: 'ESPERAR',
    desc: 'Prioridade: nao perder dinheiro. So entra em ativo seguro.'
  },
  SEGURO: {
    label: 'Moderado', color: '#ffd60a', short: 'M',
    allowed: ['Renda Fixa','FIIs','Acoes grandes','Dolar'],
    blocked: ['Cripto','Alavancagem'],
    max_risk: 'medio', min_conf: 'media', mode: 'MONITORAR',
    desc: 'Equilibrio entre seguran√ßa e crescimento.'
  },
  ARROJADO: {
    label: 'Arrojado', color: '#ff453a', short: 'A',
    allowed: ['Acoes','FIIs','Cripto','Dolar','Commodities'],
    blocked: [],
    max_risk: 'alto', min_conf: 'baixa', mode: 'OPERAR',
    desc: 'Busca retorno alto. Aceita volatilidade com disciplina.'
  }
};

var DAILY_PIPELINE = ['MACRO_ORACLE','RISK_SHIELD','DERIVATIVES_HEDGE','ORCHESTRATOR_CIO'];
var DEEP_PIPELINE = ['MACRO_ORACLE','BRASIL_ANALYST','QUANT_SIGNAL','EQUITY_STOCK_MASTER',
  'REAL_ASSETS_CREDIT','RISK_SHIELD','DERIVATIVES_HEDGE','EXECUTION_DESK',
  'LEGAL_TAX_OPTIMIZER','ORCHESTRATOR_CIO'];

var AGENTS = {
  MACRO_ORACLE: { desc: 'Analisa o cenario global ‚Äî juros, dolar, commodities.', styles: ['Druckenmiller','Dalio','Soros'], pipeline: ['daily','deep'] },
  BRASIL_ANALYST: { desc: 'Analisa Selic, inflacao e economia brasileira.', styles: ['Fraga','Arida','Resende'], pipeline: ['deep'] },
  QUANT_SIGNAL: { desc: 'Sinais matematicos: tendencia, forca, volatilidade.', styles: ['Simons','Asness','Lopez de Prado'], pipeline: ['deep'] },
  EQUITY_STOCK_MASTER: { desc: 'Analisa setores da bolsa ‚Äî onde ha oportunidade.', styles: ['Lynch','Fisher','Smith'], pipeline: ['deep'] },
  REAL_ASSETS_CREDIT: { desc: 'FIIs, imoveis, credito privado, CRI e CRA.', styles: ['Zell','Schwarzman','Flatt'], pipeline: ['deep'] },
  RISK_SHIELD: { desc: 'Chefe de risco: aponta o que pode dar errado.', styles: ['Howard Marks','Aaron Brown','Bookstaber'], pipeline: ['daily','deep'] },
  DERIVATIVES_HEDGE: { desc: 'Estrategias de protecao para sua carteira.', styles: ['Taleb','Spitznagel','Weinstein'], pipeline: ['daily','deep'] },
  EXECUTION_DESK: { desc: 'Como executar ordens: timing, tamanho, custo.', styles: ['Citadel','Virtu','Jane Street'], pipeline: ['deep'] },
  LEGAL_TAX_OPTIMIZER: { desc: 'Impostos e regulacao. Nao substitui advogado.', styles: ['Big4','Baker McKenzie','Withers'], pipeline: ['deep'] },
  ORCHESTRATOR_CIO: { desc: 'Diretor Geral: junta tudo e entrega o plano do dia.', styles: ['Dalio','Paul Tudor Jones','Soros'], pipeline: ['daily','deep'] }
};

// ================================================================
// STATE
// ================================================================
var ST = {
  page: 'dashboard',
  logged: false,
  user: null,
  riskProfile: 'SEGURO',
  pipeline: 'daily',
  brief: null,
  generating: false,
  progress: [],
  agentOutputs: {},
  snapshot: null,
  snapshotLoading: false,
  portfolio: storeGet('cio_portfolio', { 'Renda Fixa': 40, 'Acoes': 25, 'FIIs': 20, 'Dolar': 10, 'Cripto': 5 }),
  logs: [],
  config: storeGet('cio_config', { dsUrl: '', horizon: 'medio' }),
  sbCfg: storeGet('cio_sb', { url: '', anonKey: '', enabled: false }),
  aiCfg: storeGet('cio_ai_cfg', { provider: 'anthropic', model: 'claude-sonnet-4-20250514' }),
  dbStatus: null,
  sbClient: null,
  keyInput: '',
  showKey: false,
  sbBriefs: [],
  sbTab: 'config',
  histSelected: null,
  eventsFilter: 'Todos'
};

function setState(partial) { Object.assign(ST, partial); render(); }
function stateSet(partial) { Object.assign(ST, partial); }

// ================================================================
// STORAGE
// ================================================================
function storeGet(k, def) { try { var v=localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch(e) { return def; } }
function storeSet(k, v)   { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }
function storeGetStr(k, def) { try { return localStorage.getItem(k) || def || ''; } catch(e) { return def || ''; } }
function storeSetStr(k, v)   { try { localStorage.setItem(k, v); } catch(e) {} }

// ================================================================
// AI KEY
// ================================================================
var AIKEY = {
  get: function()  { return storeGetStr('cio_ai_key', ''); },
  set: function(k) { storeSetStr('cio_ai_key', k); },
  clear: function(){ try { localStorage.removeItem('cio_ai_key'); } catch(e) {} }
};

// ================================================================
// MARKET DATA ‚Äî FONTES REAIS PUBLICAS
// ================================================================

// Tabela de labels amigaveis para leigos
var ASSET_LABELS = {
  BTCUSDT:  { name: 'Bitcoin (BTC)',      icon: '‚Çø',   cat: 'Cripto',      unit: 'USD' },
  ETHUSDT:  { name: 'Ethereum (ETH)',     icon: '‚ü†',   cat: 'Cripto',      unit: 'USD' },
  BNBUSDT:  { name: 'BNB Binance',        icon: 'üü°',  cat: 'Cripto',      unit: 'USD' },
  SOLUSDT:  { name: 'Solana (SOL)',       icon: '‚óé',   cat: 'Cripto',      unit: 'USD' },
  XRPUSDT:  { name: 'XRP (Ripple)',       icon: 'üíß',  cat: 'Cripto',      unit: 'USD' },
  USDBRL:   { name: 'D√≥lar Americano',   icon: 'üíµ',  cat: 'C√¢mbio',      unit: 'BRL' },
  EURBRL:   { name: 'Euro',              icon: 'üí∂',  cat: 'C√¢mbio',      unit: 'BRL' },
  XAUUSD:   { name: 'Ouro (por oz)',     icon: 'ü•á',  cat: 'Commodity',   unit: 'USD' },
  XAGUSD:   { name: 'Prata (por oz)',    icon: 'ü•à',  cat: 'Commodity',   unit: 'USD' },
  CLUSD:    { name: 'Petr√≥leo WTI',     icon: 'üõ¢Ô∏è',  cat: 'Commodity',   unit: 'USD' },
  IBOV:     { name: 'Ibovespa',          icon: 'üáßüá∑', cat: 'Bolsa BR',    unit: 'pts' },
  SPX:      { name: 'S&P 500 (EUA)',     icon: 'üá∫üá∏', cat: 'Bolsa EUA',   unit: 'USD' },
  NDX:      { name: 'Nasdaq (Techs)',    icon: 'üíª',  cat: 'Bolsa EUA',   unit: 'USD' },
  DXY:      { name: '√çndice do D√≥lar',  icon: 'üìä',  cat: 'Macro',       unit: 'pts' },
  BTC_DOM:  { name: 'Domin√¢ncia BTC',    icon: 'üìà',  cat: 'Cripto',      unit: '%'   }
};

// Fetch cota√ß√µes Binance (cripto em tempo real)
function fetchBinance() {
  var symbols = ['BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT'];
  var queries = symbols.map(function(s) {
    return fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=' + s)
      .then(function(r) { return r.json(); })
      .then(function(d) {
        return {
          symbol: s,
          last: parseFloat(d.lastPrice),
          chg24h_pct: parseFloat(d.priceChangePercent),
          volume: parseFloat(d.quoteVolume),
          high: parseFloat(d.highPrice),
          low: parseFloat(d.lowPrice)
        };
      }).catch(function() { return null; });
  });
  return Promise.all(queries);
}

// Fetch cambio via ExchangeRate-API (gratuita, sem auth)
function fetchCambio() {
  return fetch('https://api.exchangerate-api.com/v4/latest/USD')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      var brl = d.rates && d.rates.BRL ? d.rates.BRL : null;
      var eur = d.rates && d.rates.EUR ? d.rates.EUR : null;
      var results = [];
      if (brl) results.push({ symbol: 'USDBRL', last: brl, chg24h_pct: null, source: 'exchangerate' });
      if (brl && eur) results.push({ symbol: 'EURBRL', last: brl / eur, chg24h_pct: null, source: 'exchangerate' });
      return results;
    }).catch(function() { return []; });
}

// Fetch metais e commodities via Metals-API (fallback: dados estimados com timestamp)
function fetchMetals() {
  // Usando frankfurter para EUR/USD como proxy, e GoldAPI para metais
  return fetch('https://api.metals.live/v1/spot/gold,silver')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      var results = [];
      if (d && d.price && d[0]) {
        // metals.live retorna array
        d.forEach(function(m) {
          if (m.gold) results.push({ symbol: 'XAUUSD', last: m.gold, chg24h_pct: null, source: 'metals.live' });
          if (m.silver) results.push({ symbol: 'XAGUSD', last: m.silver, chg24h_pct: null, source: 'metals.live' });
        });
      }
      return results;
    }).catch(function() {
      // fallback: fetch gold price via alternative
      return fetch('https://api.gold-api.com/price/XAU')
        .then(function(r) { return r.json(); })
        .then(function(d) {
          var results = [];
          if (d && d.price) results.push({ symbol: 'XAUUSD', last: d.price, chg24h_pct: d.chp || null, source: 'gold-api' });
          return results;
        }).catch(function() { return []; });
    });
}

// Macro BR via BCB PTAX (oficial)
function fetchMacroBR() {
  var hoje = new Date();
  var d2 = hoje.toLocaleDateString('pt-BR').replace(/\//g, '-');
  // PTAX d√≥lar
  var ptaxUrl = 'https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarDia(dataCotacao=@dataCotacao)?@dataCotacao=' + "'" + d2 + "'" + '&$format=json&$select=cotacaoCompra,cotacaoVenda,dataHoraCotacao';
  return fetch(ptaxUrl)
    .then(function(r) { return r.json(); })
    .then(function(d) {
      var row = d.value && d.value[0];
      if (!row) return null;
      return {
        ptax_compra: row.cotacaoCompra,
        ptax_venda: row.cotacaoVenda,
        ptax_ts: row.dataHoraCotacao,
        source: 'BCB PTAX'
      };
    }).catch(function() { return null; });
}

// Selic meta via BCB
function fetchSelic() {
  return fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.4390/dados/ultimos/1?formato=json')
    .then(function(r) { return r.json(); })
    .then(function(d) { return d && d[0] ? parseFloat(d[0].valor) : null; })
    .catch(function() { return null; });
}

// Fetch CoinGecko dominance BTC
function fetchDominance() {
  return fetch('https://api.coingecko.com/api/v3/global')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      var dom = d.data && d.data.market_cap_percentage && d.data.market_cap_percentage.btc;
      return dom ? { symbol: 'BTC_DOM', last: parseFloat(dom.toFixed(1)), chg24h_pct: null, source: 'CoinGecko' } : null;
    }).catch(function() { return null; });
}

// Cotacao do boi gordo via CEPEA (HTMLparse nao possivel via CORS, usa proxy publico ou fallback)
// Usamos IBGE/CONAB como fallback para commodities agro

// MASTER FETCH ‚Äî busca tudo em paralelo
function fetchAllMarketData() {
  stateSet({ snapshotLoading: true });

  return Promise.all([
    fetchBinance(),
    fetchCambio(),
    fetchMetals(),
    fetchMacroBR(),
    fetchSelic(),
    fetchDominance()
  ]).then(function(results) {
    var binance   = results[0] || [];
    var cambio    = results[1] || [];
    var metals    = results[2] || [];
    var macroBR   = results[3];
    var selic     = results[4];
    var dominance = results[5];

    var prices = {};
    var sources = [];

    // Cripto Binance
    binance.forEach(function(b) {
      if (b) { prices[b.symbol] = b; sources.push('Binance'); }
    });

    // Cambio
    cambio.forEach(function(c) {
      if (!prices[c.symbol]) { prices[c.symbol] = c; sources.push('ExchangeRate'); }
    });

    // Metais
    metals.forEach(function(m) {
      if (m) { prices[m.symbol] = m; sources.push(m.source || 'Metals'); }
    });

    // Dominancia
    if (dominance) { prices['BTC_DOM'] = dominance; sources.push('CoinGecko'); }

    // PTAX como cotacao do dolar se Exchange rate nao pegou
    if (macroBR && macroBR.ptax_venda && !prices['USDBRL']) {
      prices['USDBRL'] = { symbol: 'USDBRL', last: macroBR.ptax_venda, chg24h_pct: null, source: 'BCB PTAX' };
    }

    // Contar fontes bem sucedidas
    var successCount = Object.keys(prices).length;
    var uniqueSources = sources.filter(function(s, i, a) { return a.indexOf(s) === i; });

    var snap = {
      ts: new Date().toISOString(),
      prices: prices,
      macro_br: {
        selic: selic,
        ptax_compra: macroBR ? macroBR.ptax_compra : null,
        ptax_venda: macroBR ? macroBR.ptax_venda : null,
        source_ptax: macroBR ? macroBR.source : null
      },
      events: [],
      news: [],
      quality: {
        source: uniqueSources.join(', ') || 'cache',
        partial: successCount < 3,
        assets_found: successCount,
        fetched_at: new Date().toLocaleTimeString('pt-BR')
      }
    };

    stateSet({ snapshot: snap, snapshotLoading: false });
    return snap;
  }).catch(function(e) {
    stateSet({ snapshotLoading: false });
    // Retorna snapshot com precos em cache / zerados para nao quebrar
    return {
      ts: new Date().toISOString(),
      prices: {},
      macro_br: {},
      events: [],
      news: [],
      quality: { source: 'erro:' + e.message, partial: true, assets_found: 0 }
    };
  });
}

// ================================================================
// AI API
// ================================================================
function callAI(system, userMsg, maxTokens) {
  maxTokens = maxTokens || 1800;
  var key = AIKEY.get();
  if (!key) return Promise.reject(new Error('API_KEY_MISSING'));
  var cfg = ST.aiCfg;

  if (cfg.provider === 'gemini') {
    var model = cfg.model || 'gemini-2.0-flash';
    var url = 'https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + key;
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ role: 'user', parts: [{ text: system + '\n\n' + userMsg }] }],
        generationConfig: { maxOutputTokens: maxTokens, temperature: 0.3 }
      })
    }).then(function(r) {
      if (!r.ok) return r.json().then(function(e) { throw new Error(e.error && e.error.message ? e.error.message : 'HTTP ' + r.status); });
      return r.json();
    }).then(function(d) {
      var t = d.candidates && d.candidates[0] && d.candidates[0].content && d.candidates[0].content.parts
        ? d.candidates[0].content.parts.map(function(pp) { return pp.text || ''; }).join('') : '';
      try { return JSON.parse(t.replace(/```json|```/g, '').trim()); } catch(e) { return { raw: t, parse_error: true }; }
    });
  }

  if (cfg.provider === 'openai') {
    return fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
      body: JSON.stringify({
        model: cfg.model || 'gpt-4o', max_tokens: maxTokens,
        messages: [{ role: 'system', content: system }, { role: 'user', content: userMsg }]
      })
    }).then(function(r) {
      if (!r.ok) return r.json().then(function(e) { throw new Error(e.error && e.error.message ? e.error.message : 'HTTP ' + r.status); });
      return r.json();
    }).then(function(d) {
      var t = d.choices && d.choices[0] && d.choices[0].message ? d.choices[0].message.content : '';
      try { return JSON.parse(t.replace(/```json|```/g, '').trim()); } catch(e) { return { raw: t, parse_error: true }; }
    });
  }

  // Anthropic (default)
  return fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': key,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: cfg.model || 'claude-sonnet-4-20250514',
      max_tokens: maxTokens,
      system: system,
      messages: [{ role: 'user', content: userMsg }]
    })
  }).then(function(r) {
    if (!r.ok) return r.json().then(function(e) {
      if (r.status === 401) throw new Error('Chave invalida (401).');
      if (r.status === 429) throw new Error('Limite de requisicoes atingido (429). Aguarde.');
      throw new Error(e.error && e.error.message ? e.error.message : 'HTTP ' + r.status);
    });
    return r.json();
  }).then(function(d) {
    var t = d.content && d.content[0] ? d.content[0].text : '';
    try { return JSON.parse(t.replace(/```json|```/g, '').trim()); } catch(e) { return { raw: t, parse_error: true }; }
  });
}

// ================================================================
// SUPABASE
// ================================================================
function createSB(url, anonKey) {
  if (!url || !anonKey) return null;
  var h = { 'Content-Type': 'application/json', 'apikey': anonKey, 'Authorization': 'Bearer ' + anonKey };
  function rpc(path, method, body) {
    method = method || 'GET';
    var headers = Object.assign({}, h, { 'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal' });
    return fetch(url + '/rest/v1' + path, { method: method, headers: headers, body: body ? JSON.stringify(body) : undefined })
      .then(function(r) {
        if (!r.ok) return r.text().then(function(e) { throw new Error('SB ' + r.status + ': ' + e); });
        return r.text().then(function(t) { return t ? JSON.parse(t) : null; });
      });
  }
  return {
    saveBrief:    function(d) { return rpc('/morning_briefs', 'POST', d); },
    getBriefs:    function(n) { return rpc('/morning_briefs?order=created_at.desc&limit=' + (n||20)); },
    savePortfolio:function(d) { return rpc('/portfolio_snapshots', 'POST', d); },
    saveLog:      function(d) { return rpc('/audit_logs', 'POST', d); },
    getLogs:      function(n) { return rpc('/audit_logs?order=created_at.desc&limit=' + (n||80)); },
    upsertConfig: function(k, v) {
      return rpc('/app_config?key=eq.' + k).then(function(ex) {
        if (ex && ex.length) return rpc('/app_config?key=eq.' + k, 'PATCH', { value: JSON.stringify(v) });
        return rpc('/app_config', 'POST', { key: k, value: JSON.stringify(v) });
      });
    },
    ping: function() { return rpc('/morning_briefs?limit=1'); }
  };
}

function initSupabase() {
  var cfg = ST.sbCfg;
  if (!cfg.enabled || !cfg.url || !cfg.anonKey) { stateSet({ sbClient: null, dbStatus: null }); return Promise.resolve(); }
  var client = createSB(cfg.url, cfg.anonKey);
  stateSet({ sbClient: client, dbStatus: 'syncing' });
  return client.ping().then(function() {
    stateSet({ dbStatus: 'ok' });
  }).catch(function() { stateSet({ dbStatus: 'error' }); });
}

function addLog(action, status, notes) {
  var entry = { id: Date.now(), ts: new Date().toISOString(), user: ST.user ? ST.user.username : 'sys', action: action, status: status, notes: notes || '' };
  ST.logs = [entry].concat(ST.logs.slice(0, 99));
  if (ST.sbClient) ST.sbClient.saveLog({ username: entry.user, action: action, status: status, notes: notes || '' }).catch(function() {});
}

// ================================================================
// RISK POLICY ENGINE
// ================================================================
function applyPolicy(opps, profile) {
  var cfg = RISK_PROFILES[profile];
  if (!opps || !opps.length) return [];
  return opps.filter(function(o) {
    if (cfg.blocked.some(function(b) { return (o.classe||'').indexOf(b)>=0; })) return false;
    if (cfg.max_risk === 'baixo' && (o.risco_nivel === 'alto' || o.risco_nivel === 'medio')) return false;
    if (cfg.min_conf === 'alta' && o.confianca !== 'alta') return false;
    if (cfg.min_conf === 'media' && o.confianca === 'baixa') return false;
    return true;
  }).map(function(o) { return Object.assign({}, o, { acao: o.acao || cfg.mode }); });
}

// ================================================================
// BUILD PROMPTS ‚Äî ULTRA CLAROS PARA LEIGOS
// ================================================================
function buildPrompt(agentId, snap, profile, horizon, prev) {
  var base = 'Voce e um assessor financeiro especialista respondendo a um investidor leigo brasileiro. Retorne SOMENTE JSON valido. Sem markdown, sem explicacoes fora do JSON. Use linguagem simples e direta.';

  // Formata precos para incluir no prompt
  var precosStr = '';
  var priceKeys = Object.keys(snap.prices || {});
  priceKeys.forEach(function(k) {
    var p = snap.prices[k];
    var lbl = ASSET_LABELS[k] ? ASSET_LABELS[k].name : k;
    var chgStr = p.chg24h_pct != null ? ' (' + (p.chg24h_pct >= 0 ? '+' : '') + p.chg24h_pct.toFixed(2) + '% 24h)' : '';
    precosStr += lbl + ': ' + (p.last || 0).toLocaleString('pt-BR') + chgStr + ' | ';
  });
  if (snap.macro_br && snap.macro_br.selic) precosStr += 'Selic: ' + snap.macro_br.selic + '% | ';
  if (snap.macro_br && snap.macro_br.ptax_venda) precosStr += 'PTAX BCB: ' + snap.macro_br.ptax_venda + ' BRL/USD | ';

  var inp = 'PRECOS_ATUAIS: ' + precosStr + ' PERFIL: ' + profile + ' HORIZONTE: ' + horizon;

  var ORCH_SCHEMA = '{"agent":"ORCHESTRATOR_CIO","morning_brief":{"resumo_executivo":"Em 2-3 frases simples explique o cenario de hoje para um leigo","semaforo":"verde|amarelo|vermelho","semaforo_motivo":"Por que este semaforo?","acoes_imediatas":[{"ativo":"Nome do ativo claro ex: Bitcoin, Dolar, Ibovespa","acao":"COMPRAR|VENDER|ESPERAR|PROTEGER","urgencia":"AGORA|ESTA_SEMANA|PROXIMO_MES","motivo_simples":"1 frase clara explicando POR QUE para leigo","quanto_risco":"baixo|medio|alto","para_quem":"todos|moderado|arrojado"}],"nao_faca_hoje":["Lista do que EVITAR hoje com motivo simples"],"mercado_cripto":{"btc_sinal":"COMPRAR|VENDER|ESPERAR","btc_motivo":"","eth_sinal":"COMPRAR|VENDER|ESPERAR","outros":""},"mercado_cambio":{"dolar_sinal":"COMPRAR|VENDER|ESPERAR","dolar_motivo":"","ouro_sinal":"COMPRAR|VENDER|ESPERAR","ouro_motivo":""},"mercado_br":{"bolsa_sinal":"COMPRAR|VENDER|ESPERAR","bolsa_motivo":"","renda_fixa_sinal":"MANTER|AUMENTAR|REDUZIR","renda_fixa_motivo":""},"resumo_leigo":"Escreva como se fosse uma mensagem de texto para um amigo que nao entende de financas. Direto, claro, sem jargao. Max 3 frases.","opportunities_cards":[{"classe":"","tese":"Uma frase simples: POR QUE este ativo esta interessante","gatilho":"O que precisa acontecer para entrar","invalidacao":"O que significa que errou","riscos":[""],"confianca":"alta|media|baixa","risco_nivel":"baixo|medio|alto","acao":"COMPRAR|VENDER|ESPERAR|PROTEGER"}],"risks_top5":["Risco 1 em linguagem simples","Risco 2","Risco 3","Risco 4","Risco 5"],"checklist":{"fazer":["Acao concreta 1","Acao concreta 2","Acao concreta 3"],"evitar":["O que nao fazer 1","O que nao fazer 2","O que nao fazer 3"]}},"disclaimer":"Este conteudo e educacional e nao constitui recomendacao individual."}';

  var MACRO_SCHEMA = '{"agent":"MACRO_ORACLE","regime":"risk-on|risk-off|transicao|incerto","thesis":["frase simples 1","frase simples 2","frase simples 3"],"alerts":["alerta 1","alerta 2"],"by_class":{"renda_fixa":["observacao"],"acoes":["observacao"],"cripto":["observacao"],"cambio":["observacao"]}}';

  var prompts = {
    MACRO_ORACLE: {
      sys: base + ' Foco: cenario global e impacto no Brasil.',
      usr: inp + ' Analise o cenario macro e retorne: ' + MACRO_SCHEMA
    },
    BRASIL_ANALYST: {
      sys: base + ' Foco: economia brasileira, Selic, inflacao, real.',
      usr: inp + ' Analise economia BR e retorne: {"agent":"BRASIL_ANALYST","thesis":["","",""],"alerts":["",""],"selic_outlook":"alta|estavel|queda","impacto_renda_fixa":"positivo|neutro|negativo","impacto_acoes":"positivo|neutro|negativo"}'
    },
    QUANT_SIGNAL: {
      sys: base + ' Foco: sinais tecnicos e quantitativos.',
      usr: inp + ' Retorne sinais: {"agent":"QUANT_SIGNAL","tendencia_geral":"alta|baixa|lateral","volatilidade":"baixa|media|alta","sinais":[{"ativo":"","sinal":"COMPRAR|VENDER|ESPERAR","forca":0,"motivo":""}],"guardrails":[""]}'
    },
    EQUITY_STOCK_MASTER: {
      sys: base + ' Foco: bolsa brasileira e acoes.',
      usr: inp + ' Retorne: {"agent":"EQUITY_STOCK_MASTER","bolsa_tendencia":"alta|baixa|lateral","setores_bons":[""],"setores_ruins":[""],"thesis":["","",""],"alerts":["",""]}'
    },
    REAL_ASSETS_CREDIT: {
      sys: base + ' Foco: FIIs, imoveis e credito privado.',
      usr: inp + ' Retorne: {"agent":"REAL_ASSETS_CREDIT","fiis_outlook":"positivo|neutro|negativo","thesis":["","",""],"alerts":["",""]}'
    },
    RISK_SHIELD: {
      sys: base + ' Foco: riscos. Seja conservador. Em duvida, diga que ha risco.',
      usr: inp + ' Aponte riscos: {"agent":"RISK_SHIELD","nivel_risco_geral":"baixo|medio|alto|critico","thesis":["","",""],"risks":[{"risco":"descricao simples","prob":"baixa|media|alta","o_que_fazer":""}],"go_no_go":"go|cautela|no_go"}'
    },
    DERIVATIVES_HEDGE: {
      sys: base + ' Foco: como proteger a carteira.',
      usr: inp + ' Retorne: {"agent":"DERIVATIVES_HEDGE","thesis":["","",""],"protecoes_sugeridas":[{"tipo":"","motivo":"","para_quem":"todos|moderado|arrojado"}],"anti_ruin_rules":[""]}'
    },
    EXECUTION_DESK: {
      sys: base + ' Foco: como e quando executar operacoes.',
      usr: inp + ' Retorne: {"agent":"EXECUTION_DESK","thesis":["","",""],"quando_operar":"manha|tarde|qualquer","timing_cripto":"24h","conselhos_execucao":[""]}'
    },
    LEGAL_TAX_OPTIMIZER: {
      sys: base + ' Foco: impostos e compliance. Alerte sobre IR e declaracao.',
      usr: inp + ' Retorne: {"agent":"LEGAL_TAX_OPTIMIZER","alertas_ir":[""],"checklist_compliance":[""],"observacao":"Nao substitui contador."}'
    },
    ORCHESTRATOR_CIO: {
      sys: base + ' Voce e o CIO. Sintetize TUDO em linguagem que qualquer pessoa entende. Seja DIRETO: diga COMPRAR, VENDER ou ESPERAR. Explique POR QUE em 1 frase. Pense como um assessor que quer o melhor para o cliente.',
      usr: 'BUNDLE_AGENTES:' + JSON.stringify(prev) + ' ' + inp + ' RETORNE:' + ORCH_SCHEMA
    }
  };

  var p = prompts[agentId];
  if (!p) return { sys: base, usr: agentId + ' analise e retorne JSON. ' + inp };
  return p;
}

// ================================================================
// PIPELINE RUNNER
// ================================================================
function runPipeline() {
  if (!AIKEY.get()) { setState({ page: 'ai_key' }); return; }
  stateSet({ generating: true, brief: null, agentOutputs: {}, progress: [] });
  render();

  var pipeline = ST.pipeline === 'daily' ? DAILY_PIPELINE : DEEP_PIPELINE;

  // Sempre busca dados de mercado atuais
  var step0 = [{ label: 'üåê Buscando dados de mercado em tempo real...', status: 'running' }];
  stateSet({ progress: step0 }); render();

  fetchAllMarketData().then(function(snap) {
    stateSet({ snapshot: snap });
    var prog = [{ label: '‚úì Dados de mercado recebidos (' + (snap.quality.assets_found || 0) + ' ativos de ' + (snap.quality.source || 'cache') + ')', status: 'done' }];
    addLog('FETCH_MARKET', 'ok', snap.quality.source);

    var bundle = {};
    var idx = 0;

    function runNext() {
      if (idx >= pipeline.length) {
        var cio = bundle['ORCHESTRATOR_CIO'];
        var brief = null;
        if (cio && cio.morning_brief) {
          brief = cio.morning_brief;
          if (brief.opportunities_cards) {
            brief.opportunities_cards = applyPolicy(brief.opportunities_cards, ST.riskProfile);
          }
          if (ST.sbClient) {
            ST.sbClient.saveBrief({
              risk_profile: ST.riskProfile, pipeline_mode: ST.pipeline,
              brief_json: brief, snapshot_json: snap, agent_bundle: bundle,
              username: ST.user ? ST.user.username : 'admin'
            }).catch(function() {});
          }
        } else {
          brief = { _error: true, _raw: cio };
        }
        addLog('GENERATE_BRIEF', 'ok', 'mode:' + ST.pipeline + ' profile:' + ST.riskProfile);
        setState({ generating: false, brief: brief });
        return;
      }

      var agId = pipeline[idx];
      prog.push({ label: '‚öôÔ∏è ' + agId + ' analisando...', status: 'running' });
      stateSet({ progress: prog.slice() }); render();

      var prev = {};
      Object.keys(bundle).forEach(function(k) {
        prev[k] = { thesis: bundle[k].thesis, alerts: bundle[k].alerts, regime: bundle[k].regime };
      });
      if (agId === 'ORCHESTRATOR_CIO') prev = bundle;

      var prompt = buildPrompt(agId, snap, ST.riskProfile, ST.config.horizon || 'medio', prev);

      callAI(prompt.sys, prompt.usr, 1800).then(function(result) {
        bundle[agId] = result;
        ST.agentOutputs[agId] = result;
        addLog('AGENT_' + agId, result.parse_error ? 'warn' : 'ok', '');
        prog[prog.length - 1] = { label: '‚úì ' + agId + ' completo', status: 'done' };
        stateSet({ progress: prog.slice() });
        idx++;
        setTimeout(runNext, 120);
      }).catch(function(e) {
        bundle[agId] = { agent: agId, error: e.message };
        addLog('AGENT_' + agId, 'fail', e.message);
        prog[prog.length - 1] = { label: '‚úó ' + agId + ': ' + e.message.slice(0,50), status: 'done' };
        stateSet({ progress: prog.slice() }); idx++;
        setTimeout(runNext, 120);
      });
    }

    runNext();
  });
}

// ================================================================
// DOM HELPERS
// ================================================================
function el(tag, attrs, children) {
  var e = document.createElement(tag);
  if (attrs) Object.keys(attrs).forEach(function(k) {
    var v = attrs[k];
    if (v === null || v === undefined || v === false) return;
    if (k === 'class' || k === 'className') { e.className = v; return; }
    if (k === 'style' && typeof v === 'object') { Object.assign(e.style, v); return; }
    if (k.slice(0,2) === 'on') { e.addEventListener(k.slice(2).toLowerCase(), v); return; }
    if (k === 'disabled' && v) { e.disabled = true; return; }
    e.setAttribute(k, v);
  });
  if (children !== undefined && children !== null) {
    if (typeof children === 'string') { e.textContent = children; }
    else if (Array.isArray(children)) {
      children.forEach(function(c) {
        if (c === null || c === undefined) return;
        if (typeof c === 'string') { e.appendChild(document.createTextNode(c)); return; }
        e.appendChild(c);
      });
    } else if (typeof children === 'object' && children.nodeType) { e.appendChild(children); }
  }
  return e;
}
function div(cls, children, style) {
  var attrs = {};
  if (cls) attrs['class'] = cls;
  if (style) attrs['style'] = style;
  return el('div', attrs, children);
}
function p(cls, text) { return el('p', cls ? { 'class': cls } : {}, text); }
function span(cls, text) { return el('span', cls ? { 'class': cls } : {}, text); }
function btn(cls, text, onClick, disabled) {
  var attrs = { 'class': 'btn ' + (cls || '') };
  if (onClick) attrs['onClick'] = onClick;
  if (disabled) attrs['disabled'] = true;
  return el('button', attrs, text);
}
function append(parent) {
  var args = Array.prototype.slice.call(arguments, 1);
  args.forEach(function(c) { if (c) parent.appendChild(c); });
  return parent;
}
function setHTML(e, html) { e.innerHTML = html; return e; }

// ================================================================
// RENDER ENGINE
// ================================================================
function render() {
  var root = document.getElementById('app');
  root.innerHTML = '';
  if (!ST.logged) { root.appendChild(renderLogin()); return; }

  var sidebar = renderSidebar();
  var overlay = div('sidebar-overlay');
  overlay.addEventListener('click', function() {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  });

  var hamburger = div('hamburger');
  hamburger.innerHTML = '<span></span><span></span><span></span>';
  hamburger.addEventListener('click', function() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('show');
  });

  var mainEl = div('main', [renderPage()]);
  var mobileNav = renderMobileNav();
  var app = div('app', [overlay, sidebar, mainEl]);
  root.appendChild(app);
  root.appendChild(hamburger);
  root.appendChild(mobileNav);
}

function renderMobileNav() {
  var items = [
    { id: 'dashboard',  icon: '‚ö°', label: 'Brief' },
    { id: 'mercado',    icon: 'üìä', label: 'Mercado' },
    { id: 'opportunities', icon: 'üéØ', label: 'Acoes' },
    { id: 'portfolio',  icon: 'üíº', label: 'Carteira' },
    { id: 'ai_key',     icon: 'üîë', label: 'IA' }
  ];
  var nav = div('mobile-nav');
  items.forEach(function(item) {
    var mi = div('mnav-item' + (ST.page === item.id ? ' active' : ''));
    mi.innerHTML = '<span class="mnav-icon">' + item.icon + '</span><span class="mnav-label">' + item.label + '</span>';
    mi.addEventListener('click', function() { setState({ page: item.id }); });
    nav.appendChild(mi);
  });
  return nav;
}

// ================================================================
// LOGIN
// ================================================================
function renderLogin() {
  var uVal = '', pVal = '';
  var wrap = div('login-wrap');
  var card = div('login-card');

  var logo = div('login-logo');
  logo.innerHTML = '<div class="login-name">CIO DIGITAL</div><div class="login-line"></div><div class="login-sub">Mesa de Operacoes &middot; Dados Reais</div>';

  var errEl = div('login-err', '');

  var uInput = el('input', { type:'text', class:'input', autocomplete:'username',
    oninput: function(e) { uVal = e.target.value; },
    onkeydown: function(e) { if (e.key==='Enter') loginBtn.click(); }
  });
  var pInput = el('input', { type:'password', class:'input', autocomplete:'current-password',
    oninput: function(e) { pVal = e.target.value; },
    onkeydown: function(e) { if (e.key==='Enter') loginBtn.click(); }
  });

  var loginBtn = el('button', { class:'login-btn', onclick: function() {
    loginBtn.disabled = true; loginBtn.textContent = 'Entrando...';
    setTimeout(function() {
      if (uVal === 'diogobrasileiro' && pVal === 'dbsa1981') {
        stateSet({ logged: true, user: { username: uVal, role: 'admin' } });
        initSupabase().then(function() {
          // Auto-fetch market on login
          fetchAllMarketData().then(function() { render(); });
        });
      } else {
        errEl.textContent = 'Usuario ou senha incorretos.';
        loginBtn.disabled = false; loginBtn.textContent = 'Entrar';
      }
    }, 400);
  }}, 'Entrar');

  var uf = div('login-fg', [el('label',{},'Usuario'), uInput]);
  var pf = div('login-fg', [el('label',{},'Senha'), pInput]);
  var note = div('login-note');
  note.textContent = 'Dados de mercado ao vivo via Binance, BCB e outras fontes. Conteudo educacional ‚Äî nao constitui recomendacao individual.';

  append(card, logo, uf, pf, loginBtn, errEl, note);
  append(wrap, card);
  return wrap;
}

// ================================================================
// SIDEBAR
// ================================================================
function renderSidebar() {
  var hasKey = !!AIKEY.get();

  var logo = div('sb-logo');
  var nameEl = div('sb-name', 'CIO DIGITAL');
  var verEl = div('sb-ver', 'v' + APP_VERSION + ' ‚Ä¢ Dados Reais');
  var aiDot = div('sb-aistat', [
    el('span', { class:'ai-dot ' + (hasKey ? 'on' : 'off') }),
    el('span', { class:'ai-label' }, hasKey ? 'IA Ativa ‚Äî ' + (ST.aiCfg.provider === 'gemini' ? 'Gemini Free' : ST.aiCfg.provider === 'openai' ? 'OpenAI' : 'Anthropic') : 'IA nao configurada')
  ]);
  append(logo, nameEl, verEl, aiDot);

  if (ST.sbClient) {
    var dbStat = ST.dbStatus;
    logo.appendChild(div('sb-aistat', [
      el('span', { class:'ai-dot ' + (dbStat==='ok' ? 'on' : 'off') }),
      el('span', { class:'ai-label' }, dbStat==='ok' ? 'Supabase Online' : 'DB Offline')
    ]));
  }

  var NAV_SECTIONS = [
    { title: 'Painel', items: [
      { id:'dashboard',      icon:'‚ö°', label:'Morning Brief' },
      { id:'mercado',        icon:'üìä', label:'Cotacoes ao Vivo' },
      { id:'opportunities',  icon:'üéØ', label:'O que Fazer Agora' },
      { id:'portfolio',      icon:'üíº', label:'Minha Carteira' }
    ]},
    { title: 'Analise', items: [
      { id:'agents',         icon:'ü§ñ', label:'Agentes IA' },
      { id:'agent_outputs',  icon:'üß†', label:'Outputs IA' }
    ]},
    { title: 'Configurar', items: [
      { id:'ai_key',         icon:'üîë', label:'IA & API Key' },
      { id:'profiles',       icon:'üõ°Ô∏è', label:'Meu Perfil' },
      { id:'supabase',       icon:'üóÑÔ∏è', label:'Banco de Dados' },
      { id:'ai_costs',       icon:'üí°', label:'Pipeline & IA' }
    ]},
    { title: 'Sistema', items: [
      { id:'logs',           icon:'üìã', label:'Historico' },
      { id:'settings',       icon:'‚öôÔ∏è', label:'Ajustes' }
    ]}
  ];

  var nav = div('sb-nav');
  NAV_SECTIONS.forEach(function(sec) {
    var secEl = div('nav-section');
    secEl.appendChild(div('nav-title', sec.title));
    sec.items.forEach(function(item) {
      var ni = div('nav-item' + (ST.page === item.id ? ' active' : ''));
      ni.innerHTML = '<span class="nav-icon">' + item.icon + '</span>' + item.label;
      ni.addEventListener('click', function() { setState({ page: item.id }); });
      secEl.appendChild(ni);
    });
    nav.appendChild(secEl);
  });

  var bottom = div('sb-bottom');
  if (!hasKey) {
    var nokey = div('nokey-badge');
    nokey.appendChild(div('nokey-title', 'üîë Configure sua IA'));
    nokey.appendChild(div('nokey-sub', 'Gemini e gratuito ‚Äî clique aqui'));
    nokey.addEventListener('click', function() { setState({ page:'ai_key' }); });
    bottom.appendChild(nokey);
  } else {
    var keyok = div('key-ok-badge');
    keyok.innerHTML = '<span class="ai-dot on"></span><span class="ai-label">IA Pronta</span>';
    bottom.appendChild(keyok);
  }

  var userArea = div('user-area');
  var av = div('user-av', ST.user ? ST.user.username[0].toUpperCase() : 'A');
  var info = div('');
  info.appendChild(div('user-name', ST.user ? ST.user.username : ''));
  info.appendChild(div('user-role', 'ADMIN'));
  append(userArea, av, info);
  bottom.appendChild(userArea);
  bottom.appendChild(el('button', { class:'btn-logout', onclick: function() {
    setState({ logged:false, user:null, brief:null, snapshot:null, sbClient:null, dbStatus:null, page:'dashboard' });
  }}, 'Sair'));

  var sb = div('sidebar');
  append(sb, logo, nav, bottom);
  return sb;
}

// ================================================================
// PAGE ROUTER
// ================================================================
function renderPage() {
  var pages = {
    dashboard:      renderDashboard,
    mercado:        renderMercado,
    opportunities:  renderOpportunities,
    portfolio:      renderPortfolio,
    agents:         renderAgents,
    agent_outputs:  renderAgentOutputs,
    ai_key:         renderAIKey,
    profiles:       renderProfiles,
    supabase:       renderSupabase,
    ai_costs:       renderAICosts,
    logs:           renderLogs,
    settings:       renderSettings
  };
  var fn = pages[ST.page] || renderDashboard;
  return fn();
}

// ================================================================
// DASHBOARD (Morning Brief)
// ================================================================
function renderDashboard() {
  var hasKey = !!AIKEY.get();
  var wrap = div('');
  var today = new Date().toLocaleDateString('pt-BR', { weekday:'long', day:'numeric', month:'long' });

  var hdr = div('page-header');
  var titleSide = div('');
  titleSide.appendChild(div('page-title', '‚ö° PLANO DO DIA'));
  titleSide.appendChild(div('page-sub', today + ' ¬∑ Perfil: ' + RISK_PROFILES[ST.riskProfile].label));

  var ctrlSide = div('', null, { display:'flex', flexDirection:'column', alignItems:'flex-end', gap:'10px' });

  var profRow = div('profile-row');
  ['CONSERVADOR','SEGURO','ARROJADO'].forEach(function(k) {
    var pb = el('button', { class:'pbtn ' + RISK_PROFILES[k].short + (ST.riskProfile===k ? ' on':''),
      onclick: function() { setState({ riskProfile:k }); }
    }, RISK_PROFILES[k].label);
    profRow.appendChild(pb);
  });
  ctrlSide.appendChild(profRow);

  var pipeToggle = div('pipe-toggle');
  append(pipeToggle,
    el('button', { class:'pipe-btn'+(ST.pipeline==='daily'?' on':''), onclick:function(){setState({pipeline:'daily'});} }, '‚ö° Rapido (4 agentes)'),
    el('button', { class:'pipe-btn'+(ST.pipeline==='deep'?' on':''), onclick:function(){setState({pipeline:'deep'});} }, 'üî¨ Completo (10 agentes)')
  );
  ctrlSide.appendChild(pipeToggle);

  var actRow = div('', null, { display:'flex', gap:'8px', flexWrap:'wrap' });
  if (ST.brief && !ST.brief._error) {
    actRow.appendChild(btn('btn-secondary', 'üì° Atualizar Cotacoes', function() {
      fetchAllMarketData().then(function() { render(); });
    }));
    actRow.appendChild(btn('btn-secondary', '‚¨á Exportar', function() {
      var blob = new Blob([JSON.stringify({ brief:ST.brief, snapshot:ST.snapshot, ts:new Date().toISOString() }, null, 2)], { type:'application/json' });
      var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'cio-brief-' + new Date().toISOString().slice(0,10) + '.json'; a.click();
    }));
  }
  actRow.appendChild(btn('btn-primary', ST.generating ? '‚öôÔ∏è Analisando...' : '‚ö° Gerar Plano do Dia', function() {
    if (!ST.generating) runPipeline();
  }, ST.generating));
  ctrlSide.appendChild(actRow);
  append(hdr, titleSide, ctrlSide);
  wrap.appendChild(hdr);

  if (!hasKey) {
    var kb = div('banner banner-err'); kb.style.cursor='pointer';
    kb.textContent = 'üîë Configure sua API Key de IA para gerar o plano. Gemini e GRATUITO!';
    kb.addEventListener('click', function(){ setState({page:'ai_key'}); });
    wrap.appendChild(kb);
  }

  // Snapshot ao vivo
  var snap = ST.snapshot;
  if (snap) wrap.appendChild(renderSnapshotBar(snap));
  else {
    var fetchBtn = div('banner banner-warn', null, { cursor:'pointer' });
    fetchBtn.innerHTML = ST.snapshotLoading ? 'üåê Buscando cotacoes em tempo real...' : 'üì° Clique para carregar cotacoes ao vivo';
    fetchBtn.style.cursor = 'pointer';
    if (!ST.snapshotLoading) fetchBtn.addEventListener('click', function() {
      stateSet({ snapshotLoading: true }); render();
      fetchAllMarketData().then(function() { render(); });
    });
    wrap.appendChild(fetchBtn);
  }

  if (ST.generating) {
    var sw = div('spinner-wrap');
    sw.appendChild(div('spinner'));
    var progTitle = p(''); progTitle.style.cssText = 'font-size:16px;color:var(--t2);margin-bottom:18px;font-weight:500';
    progTitle.textContent = 'Agentes IA analisando o mercado...';
    sw.appendChild(progTitle);
    var pl = div('');
    ST.progress.forEach(function(prog) {
      sw.appendChild(div('prog-item ' + prog.status, prog.label));
    });
    sw.appendChild(pl);
    wrap.appendChild(sw);
    return wrap;
  }

  if (!ST.brief) {
    var em = div('empty-state');
    em.innerHTML = '<div class="empty-icon">‚ö°</div><div class="empty-title">Pronto para analisar</div><div class="empty-sub">Selecione seu perfil acima e clique em "Gerar Plano do Dia" para receber instrucoes claras: o que comprar, vender ou esperar hoje.</div>';
    wrap.appendChild(em);
    wrap.appendChild(renderDisclaimer());
    return wrap;
  }

  if (ST.brief._error) {
    wrap.appendChild(div('banner banner-err', '‚ö† Erro ao processar resposta da IA. Tente novamente ou verifique "Outputs IA".'));
    wrap.appendChild(renderDisclaimer());
    return wrap;
  }

  var mb = ST.brief;
  var grid = div('grid2');

  // ---- BLOCO PRINCIPAL: O QUE FAZER AGORA ----
  var acoes = mb.acoes_imediatas || [];
  var b0 = div('card card-blue col2');
  var b0title = div('card-title'); b0title.innerHTML = 'üéØ O QUE FAZER AGORA';
  b0.appendChild(b0title);

  // Resumo leigo ‚Äî destaque principal
  if (mb.resumo_leigo) {
    var rl = div('');
    rl.style.cssText = 'background:rgba(59,159,255,.07);border:1px solid rgba(59,159,255,.2);border-radius:14px;padding:18px 22px;margin-bottom:20px;position:relative;overflow:hidden';
    var rlIcon = span(''); rlIcon.style.cssText = 'font-size:28px;display:block;margin-bottom:8px';
    rlIcon.textContent = getSemaforoEmoji(mb.semaforo);
    var rlText = p('');
    rlText.style.cssText = 'font-size:17px;line-height:1.7;color:var(--t1);font-weight:400';
    rlText.textContent = mb.resumo_leigo;
    append(rl, rlIcon, rlText);
    b0.appendChild(rl);
  }

  // Acoes imediatas ‚Äî cards grandes e coloridos
  if (acoes.length) {
    var acGrid = div('');
    acGrid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-bottom:4px';
    acoes.forEach(function(ac) {
      var acCard = renderAcaoCard(ac);
      acGrid.appendChild(acCard);
    });
    b0.appendChild(acGrid);
  }
  grid.appendChild(b0);

  // ---- SEMAFORO ----
  var semaCard = div('card card-gold');
  var semTitle = div('card-title'); semTitle.innerHTML = 'üö¶ SEMAFORO DO DIA';
  semaCard.appendChild(semTitle);

  var semColor = { verde: 'var(--green)', amarelo: 'var(--amber)', vermelho: 'var(--red)' };
  var semEmoji = { verde: 'üü¢', amarelo: 'üü°', vermelho: 'üî¥' };
  var semLabel = { verde: 'TUDO BEM ‚Äî Bom momento para operar', amarelo: 'ATENCAO ‚Äî Opere com cautela', vermelho: 'PERIGO ‚Äî Reduza exposicao' };
  var semVal = mb.semaforo || 'amarelo';

  var semCircle = div('');
  semCircle.style.cssText = 'text-align:center;padding:20px 0';
  var semEmojiEl = p(''); semEmojiEl.style.cssText = 'font-size:52px;line-height:1;margin-bottom:10px';
  semEmojiEl.textContent = semEmoji[semVal] || 'üü°';
  var semLabelEl = p(''); semLabelEl.style.cssText = 'font-size:15px;font-weight:700;color:' + (semColor[semVal] || 'var(--amber)');
  semLabelEl.textContent = semLabel[semVal] || semVal.toUpperCase();
  var semMotivo = p(''); semMotivo.style.cssText = 'font-size:13px;color:var(--t2);margin-top:8px;line-height:1.5';
  semMotivo.textContent = mb.semaforo_motivo || '';
  append(semCircle, semEmojiEl, semLabelEl, semMotivo);
  semaCard.appendChild(semCircle);
  grid.appendChild(semaCard);

  // ---- RESUMO EXECUTIVO ----
  var b1 = div('card card-blue');
  b1.appendChild(div('card-title', 'üìã RESUMO DO CENARIO'));
  var resumoEl = p('');
  resumoEl.style.cssText = 'font-size:15px;line-height:1.75;color:var(--t1)';
  resumoEl.textContent = mb.resumo_executivo || '‚Äî';
  b1.appendChild(resumoEl);
  grid.appendChild(b1);

  // ---- CRIPTO ----
  var cripto = mb.mercado_cripto || {};
  if (Object.keys(cripto).length) {
    var cCard = div('card card-purple');
    cCard.appendChild(div('card-title', '‚Çø CRIPTO'));
    cCard.appendChild(renderSinalMercado('Bitcoin (BTC)', cripto.btc_sinal, cripto.btc_motivo));
    cCard.appendChild(renderSinalMercado('Ethereum (ETH)', cripto.eth_sinal, cripto.eth_motivo));
    if (cripto.outros) {
      var outrosEl = p(''); outrosEl.style.cssText = 'font-size:13px;color:var(--t3);margin-top:8px';
      outrosEl.textContent = cripto.outros;
      cCard.appendChild(outrosEl);
    }
    grid.appendChild(cCard);
  }

  // ---- CAMBIO E METAIS ----
  var cambio = mb.mercado_cambio || {};
  if (Object.keys(cambio).length) {
    var camCard = div('card card-gold');
    camCard.appendChild(div('card-title', 'üíµ DOLAR E OURO'));
    camCard.appendChild(renderSinalMercado('Dolar (USD/BRL)', cambio.dolar_sinal, cambio.dolar_motivo));
    camCard.appendChild(renderSinalMercado('Ouro', cambio.ouro_sinal, cambio.ouro_motivo));
    grid.appendChild(camCard);
  }

  // ---- MERCADO BRASILEIRO ----
  var mbr = mb.mercado_br || {};
  if (Object.keys(mbr).length) {
    var mbrCard = div('card card-green');
    mbrCard.appendChild(div('card-title', 'üáßüá∑ BOLSA E RENDA FIXA'));
    mbrCard.appendChild(renderSinalMercado('Bolsa Brasileira (IBOV)', mbr.bolsa_sinal, mbr.bolsa_motivo));
    mbrCard.appendChild(renderSinalMercado('Renda Fixa (CDB/Tesouro)', mbr.renda_fixa_sinal, mbr.renda_fixa_motivo));
    grid.appendChild(mbrCard);
  }

  // ---- NAO FACA HOJE ----
  var naoFaca = mb.nao_faca_hoje || [];
  if (naoFaca.length) {
    var nfCard = div('card card-red col2');
    nfCard.appendChild(div('card-title', '‚õî NAO FACA HOJE'));
    naoFaca.forEach(function(item) {
      var r = div('');
      r.style.cssText = 'display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:14px;color:var(--t2)';
      var ic = span(''); ic.style.cssText = 'color:var(--red);flex-shrink:0;font-size:16px';
      ic.textContent = '‚úó';
      var tx = document.createTextNode(' ' + item);
      append(r, ic, tx);
      nfCard.appendChild(r);
    });
    grid.appendChild(nfCard);
  }

  // ---- OPORTUNIDADES ----
  var opps = mb.opportunities_cards || [];
  if (opps.length) {
    var oppCard = div('card card-green col2');
    oppCard.appendChild(div('card-title', 'üéØ OPORTUNIDADES ‚Äî PERFIL: ' + RISK_PROFILES[ST.riskProfile].label.toUpperCase()));
    opps.forEach(function(o) { oppCard.appendChild(renderOppCard(o)); });
    grid.appendChild(oppCard);
  }

  // ---- RISCOS ----
  var risks = mb.risks_top5 || [];
  if (risks.length) {
    var riskCard = div('card card-red');
    riskCard.appendChild(div('card-title', '‚ö†Ô∏è RISCOS DO DIA'));
    risks.forEach(function(r, i) {
      var row = div('');
      row.style.cssText = 'display:flex;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:14px;color:var(--t2)';
      var num = span(''); num.style.cssText = 'color:var(--red);font-size:11px;font-family:JetBrains Mono,monospace;flex-shrink:0;padding-top:2px';
      num.textContent = (i+1) + '.';
      var tx = document.createTextNode(r);
      append(row, num, tx);
      riskCard.appendChild(row);
    });
    grid.appendChild(riskCard);
  }

  // ---- CHECKLIST ----
  var cl = mb.checklist || {};
  if ((cl.fazer && cl.fazer.length) || (cl.evitar && cl.evitar.length)) {
    var clCard = div('card card-blue col2');
    clCard.appendChild(div('card-title', '‚úÖ CHECKLIST DO DIA'));
    var clGrid = div('check-grid');
    var fazCol = div('');
    fazCol.appendChild(div('check-title', '‚úÖ FAZER'));
    (cl.fazer||[]).forEach(function(item) {
      var ci = div('check-item');
      var mk = span(''); mk.style.color='var(--green)'; mk.textContent='‚Ä∫';
      append(ci, mk, document.createTextNode(' ' + item));
      fazCol.appendChild(ci);
    });
    var evCol = div('');
    evCol.appendChild(div('check-title', '‚õî EVITAR'));
    (cl.evitar||[]).forEach(function(item) {
      var ci = div('check-item');
      var mk = span(''); mk.style.color='var(--red)'; mk.textContent='‚Ä∫';
      append(ci, mk, document.createTextNode(' ' + item));
      evCol.appendChild(ci);
    });
    append(clGrid, fazCol, evCol);
    clCard.appendChild(clGrid);
    grid.appendChild(clCard);
  }

  wrap.appendChild(grid);
  wrap.appendChild(renderDisclaimer());
  return wrap;
}

function getSemaforoEmoji(s) {
  if (s === 'verde') return 'üü¢';
  if (s === 'vermelho') return 'üî¥';
  return 'üü°';
}

// Card de acao (COMPRAR/VENDER/ESPERAR)
function renderAcaoCard(ac) {
  var acao = (ac.acao || 'ESPERAR').toUpperCase();
  var colors = {
    COMPRAR: { bg: 'rgba(50,215,75,.1)', border: 'rgba(50,215,75,.3)', color: 'var(--green)', icon: 'üìà COMPRAR' },
    VENDER:  { bg: 'rgba(255,69,58,.1)',  border: 'rgba(255,69,58,.3)',  color: 'var(--red)',   icon: 'üìâ VENDER' },
    ESPERAR: { bg: 'rgba(255,255,255,.05)', border: 'rgba(255,255,255,.12)', color: 'var(--t2)', icon: '‚è∏ ESPERAR' },
    PROTEGER:{ bg: 'rgba(255,214,10,.08)', border: 'rgba(255,214,10,.25)', color: 'var(--amber)', icon: 'üõ° PROTEGER' }
  };
  var style = colors[acao] || colors['ESPERAR'];

  var card = div('');
  card.style.cssText = 'background:' + style.bg + ';border:2px solid ' + style.border + ';border-radius:16px;padding:18px;transition:all .2s';

  var topRow = div('');
  topRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:10px';
  var acaoLabel = span('');
  acaoLabel.style.cssText = 'font-size:12px;font-weight:800;color:' + style.color + ';letter-spacing:1px';
  acaoLabel.textContent = style.icon;

  var urgIcon = span('');
  var urgColors = { AGORA:'var(--red)', ESTA_SEMANA:'var(--amber)', PROXIMO_MES:'var(--t3)' };
  var urgText = { AGORA:'üî• AGORA', ESTA_SEMANA:'üìÖ ESTA SEMANA', PROXIMO_MES:'üìÜ PROXIMO MES' };
  urgIcon.style.cssText = 'font-size:10px;font-weight:700;color:' + (urgColors[ac.urgencia] || 'var(--t3)');
  urgIcon.textContent = urgText[ac.urgencia] || '';
  append(topRow, acaoLabel, urgIcon);
  card.appendChild(topRow);

  var ativoEl = p('');
  ativoEl.style.cssText = 'font-size:16px;font-weight:700;color:var(--t1);margin-bottom:6px;line-height:1.3';
  ativoEl.textContent = ac.ativo || '';
  card.appendChild(ativoEl);

  var motivoEl = p('');
  motivoEl.style.cssText = 'font-size:13px;color:var(--t2);line-height:1.55';
  motivoEl.textContent = ac.motivo_simples || '';
  card.appendChild(motivoEl);

  var risco = (ac.quanto_risco || '').toLowerCase();
  var riscoColors = { baixo:'var(--green)', medio:'var(--amber)', alto:'var(--red)' };
  if (risco) {
    var riscoEl = span('');
    riscoEl.style.cssText = 'font-size:10px;font-weight:700;color:' + (riscoColors[risco]||'var(--t3)') + ';display:inline-block;margin-top:8px';
    riscoEl.textContent = '‚Ä¢ Risco: ' + risco.toUpperCase();
    card.appendChild(riscoEl);
  }
  return card;
}

// Card de sinal de mercado (linha compacta)
function renderSinalMercado(nome, sinal, motivo) {
  var s = (sinal||'ESPERAR').toUpperCase();
  var sColors = { COMPRAR:'var(--green)', VENDER:'var(--red)', ESPERAR:'var(--t3)', MANTER:'var(--t2)', AUMENTAR:'var(--green)', REDUZIR:'var(--red)' };
  var sIcons  = { COMPRAR:'üìà', VENDER:'üìâ', ESPERAR:'‚è∏', MANTER:'‚è∏', AUMENTAR:'‚¨Ü', REDUZIR:'‚¨á' };

  var row = div('');
  row.style.cssText = 'display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05)';
  row.style.flexWrap = 'nowrap';

  var sinalBadge = span('');
  sinalBadge.style.cssText = 'min-width:90px;padding:5px 10px;border-radius:20px;font-size:11px;font-weight:800;text-align:center;flex-shrink:0;background:' +
    (s==='COMPRAR'||s==='AUMENTAR' ? 'rgba(50,215,75,.12)' : s==='VENDER'||s==='REDUZIR' ? 'rgba(255,69,58,.12)' : 'rgba(255,255,255,.05)') +
    ';color:' + (sColors[s]||'var(--t3)') + ';border:1px solid ' +
    (s==='COMPRAR'||s==='AUMENTAR' ? 'rgba(50,215,75,.3)' : s==='VENDER'||s==='REDUZIR' ? 'rgba(255,69,58,.3)' : 'var(--border)');
  sinalBadge.textContent = (sIcons[s]||'') + ' ' + s;

  var info = div('');
  var nomeEl = p(''); nomeEl.style.cssText = 'font-size:14px;font-weight:600;color:var(--t1);margin-bottom:3px';
  nomeEl.textContent = nome;
  var motivoEl = p(''); motivoEl.style.cssText = 'font-size:12px;color:var(--t2);line-height:1.5';
  motivoEl.textContent = motivo || '';
  append(info, nomeEl, motivoEl);
  append(row, sinalBadge, info);
  return row;
}

// ================================================================
// MERCADO AO VIVO
// ================================================================
function renderMercado() {
  var wrap = div('');
  var hdr = div('page-header');
  var titleSide = div('');
  titleSide.appendChild(div('page-title', 'üìä COTACOES AO VIVO'));
  var sub = div('page-sub');
  sub.textContent = ST.snapshot ? 'Atualizado: ' + (ST.snapshot.quality.fetched_at || '') + ' ‚Ä¢ Fontes: ' + (ST.snapshot.quality.source || '') : 'Nao carregado';
  titleSide.appendChild(sub);
  hdr.appendChild(titleSide);
  var refreshBtn = btn('btn-primary', ST.snapshotLoading ? '‚öôÔ∏è Buscando...' : 'üîÑ Atualizar Agora', function() {
    if (!ST.snapshotLoading) { stateSet({ snapshotLoading: true }); render(); fetchAllMarketData().then(function() { render(); }); }
  }, ST.snapshotLoading);
  hdr.appendChild(refreshBtn);
  wrap.appendChild(hdr);

  if (!ST.snapshot || !Object.keys(ST.snapshot.prices || {}).length) {
    var em = div('empty-state');
    em.innerHTML = '<div class="empty-icon">üì°</div><div class="empty-title">Nenhum dado carregado</div><div class="empty-sub">Clique em "Atualizar Agora" para buscar cotacoes de Binance, BCB e outras fontes.</div>';
    wrap.appendChild(em);
    return wrap;
  }

  var snap = ST.snapshot;
  var pricesByCategory = {};

  Object.keys(snap.prices).forEach(function(sym) {
    var info = ASSET_LABELS[sym] || { name: sym, icon: '‚Ä¢', cat: 'Outros', unit: '' };
    if (!pricesByCategory[info.cat]) pricesByCategory[info.cat] = [];
    pricesByCategory[info.cat].push({ sym: sym, info: info, data: snap.prices[sym] });
  });

  var catIcons = { 'Cripto':'‚Çø', 'C√¢mbio':'üíµ', 'Commodity':'ü•á', 'Bolsa BR':'üáßüá∑', 'Bolsa EUA':'üá∫üá∏', 'Macro':'üìä', 'Outros':'‚Ä¢' };
  var catOrder = ['Cripto','C√¢mbio','Commodity','Bolsa BR','Bolsa EUA','Macro','Outros'];

  catOrder.forEach(function(cat) {
    if (!pricesByCategory[cat]) return;
    var catCard = div('card card-blue');
    var catTitle = div('card-title');
    catTitle.innerHTML = '<span>' + (catIcons[cat]||'‚Ä¢') + '</span> ' + cat.toUpperCase();
    catCard.appendChild(catTitle);
    var grid = div('');
    grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px';

    pricesByCategory[cat].forEach(function(item) {
      var d = item.data;
      var info = item.info;
      var chg = d.chg24h_pct;
      var iUp = chg != null && chg > 0;
      var isDn = chg != null && chg < 0;

      var card = div('');
      card.style.cssText = 'background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:16px;position:relative;overflow:hidden';

      // Topo com icone e nome
      var topR = div('');
      topR.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:10px';
      var iconEl = span(''); iconEl.style.cssText = 'font-size:20px'; iconEl.textContent = info.icon;
      var nameEl = p(''); nameEl.style.cssText = 'font-size:12px;font-weight:600;color:var(--t2);line-height:1.3';
      nameEl.textContent = info.name;
      append(topR, iconEl, nameEl);
      card.appendChild(topR);

      // Preco principal
      var priceEl = p('');
      priceEl.style.cssText = 'font-family:JetBrains Mono,monospace;font-size:20px;font-weight:700;color:var(--t1);margin-bottom:5px;line-height:1';
      var val = d.last;
      if (info.unit === 'BRL') priceEl.textContent = 'R$ ' + (val||0).toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:4 });
      else if (info.unit === 'USD') priceEl.textContent = '$ ' + (val||0).toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 });
      else if (info.unit === '%') priceEl.textContent = (val||0).toFixed(1) + '%';
      else priceEl.textContent = (val||0).toLocaleString('pt-BR');
      card.appendChild(priceEl);

      // Variacao 24h
      if (chg != null) {
        var chgEl = span('');
        chgEl.style.cssText = 'font-size:13px;font-weight:700;font-family:JetBrains Mono,monospace;color:' + (iUp?'var(--green)':isDn?'var(--red)':'var(--t3)');
        chgEl.textContent = (iUp?'‚ñ≤ +':isDn?'‚ñº ':' ') + chg.toFixed(2) + '% hoje';
        card.appendChild(chgEl);
      }

      // Mini sinal visual
      var sinalSimples = getSinalSimples(chg, cat);
      if (sinalSimples) {
        var ss = span('');
        ss.style.cssText = 'font-size:10px;font-weight:700;display:block;margin-top:7px;padding:3px 8px;border-radius:20px;width:fit-content;' + sinalSimples.style;
        ss.textContent = sinalSimples.text;
        card.appendChild(ss);
      }

      // Source
      if (d.source) {
        var srcEl = span('');
        srcEl.style.cssText = 'font-size:9px;color:var(--t3);position:absolute;top:10px;right:12px';
        srcEl.textContent = d.source;
        card.appendChild(srcEl);
      }

      grid.appendChild(card);
    });

    catCard.appendChild(grid);
    wrap.appendChild(catCard);
  });

  // Macro BCB
  if (snap.macro_br) {
    var macroCard = div('card card-green');
    macroCard.appendChild(div('card-title', 'üèõÔ∏è DADOS MACRO BRASIL (BCB)'));
    var macro = snap.macro_br;
    var macroGrid = div('');
    macroGrid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px';
    var macroItems = [
      { label:'SELIC Meta', value: macro.selic ? macro.selic + '%' : 'N/D', desc:'Taxa basica de juros BR' },
      { label:'PTAX Venda (BCB)', value: macro.ptax_venda ? 'R$ ' + macro.ptax_venda.toFixed(4) : 'N/D', desc:'Cotacao oficial do BCB' },
      { label:'PTAX Compra (BCB)', value: macro.ptax_compra ? 'R$ ' + macro.ptax_compra.toFixed(4) : 'N/D', desc:'Cotacao oficial do BCB' }
    ];
    macroItems.forEach(function(mi) {
      var mc = div('');
      mc.style.cssText = 'background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px';
      var lb = p(''); lb.style.cssText = 'font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;font-weight:700';
      lb.textContent = mi.label;
      var vl = p(''); vl.style.cssText = 'font-size:20px;font-weight:700;color:var(--t1);font-family:JetBrains Mono,monospace;margin-bottom:3px';
      vl.textContent = mi.value;
      var dc = p(''); dc.style.cssText = 'font-size:11px;color:var(--t3)';
      dc.textContent = mi.desc;
      append(mc, lb, vl, dc);
      macroGrid.appendChild(mc);
    });
    macroCard.appendChild(macroGrid);
    wrap.appendChild(macroCard);
  }

  wrap.appendChild(renderDisclaimer());
  return wrap;
}

// Gera sinal simples baseado em variacao do dia
function getSinalSimples(chg, cat) {
  if (chg == null) return null;
  if (chg > 3) return { text:'üî• Alta forte', style:'background:rgba(50,215,75,.12);color:var(--green);border:1px solid rgba(50,215,75,.25)' };
  if (chg > 1) return { text:'üìà Subindo', style:'background:rgba(50,215,75,.08);color:var(--green);border:1px solid rgba(50,215,75,.15)' };
  if (chg < -3) return { text:'üîª Queda forte', style:'background:rgba(255,69,58,.12);color:var(--red);border:1px solid rgba(255,69,58,.25)' };
  if (chg < -1) return { text:'üìâ Caindo', style:'background:rgba(255,69,58,.08);color:var(--red);border:1px solid rgba(255,69,58,.15)' };
  return { text:'‚û° Estavel', style:'background:rgba(255,255,255,.04);color:var(--t3);border:1px solid rgba(255,255,255,.08)' };
}

// ================================================================
// SNAPSHOT BAR (dashboard compacto)
// ================================================================
function renderSnapshotBar(snap) {
  var bar = div('snap-bar');
  var hdr = div('snap-header');
  hdr.appendChild(span('snap-lbl', 'üì° MERCADO AO VIVO'));
  var quality = div('');
  quality.style.cssText = 'display:flex;align-items:center;gap:8px';
  var qualBadge = span('tag');
  qualBadge.style.color = snap.quality.partial ? 'var(--amber)' : 'var(--green)';
  qualBadge.textContent = (snap.quality.partial ? '‚ö† Parcial' : '‚úì Completo') + ' ‚Äî ' + (snap.quality.fetched_at || '');
  quality.appendChild(qualBadge);
  var refreshMini = btn('btn-secondary', 'üîÑ', function() {
    fetchAllMarketData().then(function() { render(); });
  });
  refreshMini.style.cssText = 'padding:4px 10px;font-size:12px;min-width:unset';
  quality.appendChild(refreshMini);
  hdr.appendChild(quality);
  bar.appendChild(hdr);

  var grid = div('snap-grid');
  // Mostra os principais
  var priority = ['BTCUSDT','ETHUSDT','USDBRL','XAUUSD','IBOV','SPX'];
  var shown = [];
  priority.forEach(function(sym) { if (snap.prices[sym]) shown.push(sym); });
  Object.keys(snap.prices).forEach(function(sym) { if (shown.indexOf(sym) < 0) shown.push(sym); });

  shown.slice(0, 10).forEach(function(sym) {
    var d = snap.prices[sym];
    if (!d) return;
    var info = ASSET_LABELS[sym] || { name: sym, icon: '‚Ä¢', unit: '' };
    var item = div('snap-item');
    var symEl = div('snap-sym'); symEl.textContent = info.icon + ' ' + sym.replace('USDT','');
    var valEl = div('snap-val');
    var val = d.last || 0;
    if (info.unit === 'BRL') valEl.textContent = 'R$' + val.toLocaleString('pt-BR', { maximumFractionDigits:2 });
    else if (info.unit === 'USD') valEl.textContent = '$' + val.toLocaleString('en-US', { minimumFractionDigits:0, maximumFractionDigits:0 });
    else if (info.unit === '%') valEl.textContent = val.toFixed(1) + '%';
    else valEl.textContent = val.toLocaleString('pt-BR');

    item.appendChild(symEl);
    item.appendChild(valEl);

    if (d.chg24h_pct != null) {
      var chgEl = div('snap-chg ' + (d.chg24h_pct >= 0 ? 'pos' : 'neg'));
      chgEl.textContent = (d.chg24h_pct >= 0 ? '+' : '') + d.chg24h_pct.toFixed(2) + '%';
      item.appendChild(chgEl);
    }
    grid.appendChild(item);
  });
  bar.appendChild(grid);
  return bar;
}

// ================================================================
// OPPORTUNITIES
// ================================================================
function renderOpportunities() {
  var opps = ST.brief ? (ST.brief.opportunities_cards || []) : [];
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'üéØ O QUE FAZER AGORA'));
  t.appendChild(div('page-sub', 'Acoes recomendadas ‚Äî Perfil: ' + RISK_PROFILES[ST.riskProfile].label));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  // Acoes imediatas (destaque)
  var acoes = ST.brief ? (ST.brief.acoes_imediatas || []) : [];
  if (acoes.length) {
    var acCard = div('card card-blue');
    acCard.appendChild(div('card-title', '‚ö° ACOES IMEDIATAS'));
    var acGrid = div('');
    acGrid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px';
    acoes.forEach(function(ac) { acGrid.appendChild(renderAcaoCard(ac)); });
    acCard.appendChild(acGrid);
    wrap.appendChild(acCard);
  }

  if (!opps.length) {
    var em = div('empty-state');
    em.innerHTML = '<div class="empty-icon">üéØ</div><div class="empty-title">Gere o Plano do Dia primeiro</div><div class="empty-sub">Va em "Morning Brief" e clique em "Gerar Plano do Dia" para receber instrucoes personalizadas.</div>';
    wrap.appendChild(em);
  } else {
    var oppTitle = div('card-title');
    oppTitle.innerHTML = 'üìã OPORTUNIDADES FILTRADAS ‚Äî ' + RISK_PROFILES[ST.riskProfile].label.toUpperCase();
    oppTitle.style.marginBottom = '14px';
    wrap.appendChild(oppTitle);
    opps.forEach(function(o) { wrap.appendChild(renderOppCard(o)); });
  }
  wrap.appendChild(renderDisclaimer());
  return wrap;
}

// ================================================================
// OPP CARD
// ================================================================
function renderOppCard(o) {
  var acao = (o.acao || 'ESPERAR').toUpperCase();
  var acColors = {
    COMPRAR:'rgba(50,215,75,.12)', VENDER:'rgba(255,69,58,.12)',
    ESPERAR:'rgba(255,255,255,.04)', PROTEGER:'rgba(255,214,10,.08)'
  };
  var card = div('opp-card');
  card.style.background = acColors[acao] || acColors['ESPERAR'];

  var top = div('opp-top');
  top.appendChild(span('opp-cls', o.classe || ''));
  var actEl = span('opp-act ' + (acao==='COMPRAR'?'act-sim':acao==='VENDER'?'act-mon':'act-mon'));
  actEl.textContent = acao;
  top.appendChild(actEl);
  card.appendChild(top);
  card.appendChild(div('opp-thesis', o.tese || o.thesis || ''));

  if (o.gatilho) {
    var gd = div('opp-detail');
    gd.innerHTML = '<strong>QUANDO ENTRAR</strong>';
    gd.appendChild(document.createTextNode(o.gatilho));
    card.appendChild(gd);
  }
  if (o.invalidacao) {
    var id2 = div('opp-detail');
    id2.innerHTML = '<strong>QUANDO SAIR / SE ERROU</strong>';
    id2.appendChild(document.createTextNode(o.invalidacao));
    card.appendChild(id2);
  }
  if (o.riscos && o.riscos.length) {
    var rr = div('opp-risks');
    o.riscos.forEach(function(r) { rr.appendChild(span('risk-tag', r)); });
    card.appendChild(rr);
  }
  var confCls = o.confianca==='alta' ? 'conf-high' : o.confianca==='media' ? 'conf-med' : 'conf-low';
  card.appendChild(span('conf-badge ' + confCls, (o.confianca||'').toUpperCase() + ' CONFIANCA'));
  return card;
}

function renderDisclaimer() {
  var d = div('disclaimer');
  d.innerHTML = '‚ö†Ô∏è <strong>Conteudo educacional.</strong> Nao constitui recomendacao individual. Todo investimento tem risco. Decisoes sao de exclusiva responsabilidade do investidor.';
  return d;
}

// ================================================================
// PORTFOLIO
// ================================================================
function renderPortfolio() {
  var total = Object.values(ST.portfolio).reduce(function(a,b){return a+b;},0);
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'üíº MINHA CARTEIRA'));
  t.appendChild(div('page-sub', 'Alocacao atual ‚Äî Soma: ' + total + '%'));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  var card = div('card card-blue');
  card.appendChild(div('card-title', 'AJUSTE SUA ALOCACAO (%)'));
  var hint = p(''); hint.style.cssText = 'font-size:14px;color:var(--t2);margin-bottom:18px';
  hint.textContent = 'Arraste os controles para ajustar quanto deseja em cada tipo de ativo:';
  card.appendChild(hint);

  Object.keys(ST.portfolio).forEach(function(cls) {
    var row = div('slider-row');
    var lbl = el('label', {}, cls);
    var slider = el('input', { type:'range', min:'0', max:'100' });
    slider.value = String(ST.portfolio[cls]);
    var valEl = div('slider-val', ST.portfolio[cls] + '%');
    slider.addEventListener('input', function(e) {
      var newPct = parseInt(e.target.value);
      ST.portfolio[cls] = newPct;
      valEl.textContent = newPct + '%';
      storeSet('cio_portfolio', ST.portfolio);
    });
    append(row, lbl, slider, valEl);
    card.appendChild(row);
  });

  if (total !== 100) {
    var warn = p(''); warn.style.cssText = 'font-size:13px;color:var(--amber);margin-top:8px;font-weight:500';
    warn.textContent = '‚ö†Ô∏è Total: ' + total + '% (ideal: 100%)';
    card.appendChild(warn);
  }
  wrap.appendChild(card);

  var allocGrid = div('alloc-grid');
  Object.keys(ST.portfolio).forEach(function(cls) {
    var v = ST.portfolio[cls];
    var ac = div('alloc-card');
    ac.appendChild(div('alloc-cls', cls));
    ac.appendChild(div('alloc-pct', v + '%'));
    var bar = div('alloc-bar');
    var fill = div('alloc-fill'); fill.style.width = v + '%';
    bar.appendChild(fill);
    ac.appendChild(bar);
    allocGrid.appendChild(ac);
  });
  wrap.appendChild(allocGrid);
  return wrap;
}

// ================================================================
// AGENTS
// ================================================================
function renderAgents() {
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'ü§ñ AGENTES IA'));
  t.appendChild(div('page-sub', Object.keys(AGENTS).length + ' especialistas financeiros'));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  var grid = div('agent-grid');
  Object.keys(AGENTS).forEach(function(id) {
    var ag = AGENTS[id];
    var card = div('agent-card');
    card.appendChild(div('agent-name', id));
    card.appendChild(div('agent-ver', 'v3.0'));
    card.appendChild(div('agent-desc', ag.desc));
    var stylesWrap = div(''); stylesWrap.style.marginBottom = '8px';
    ag.styles.forEach(function(s) { stylesWrap.appendChild(span('agent-style', s)); });
    card.appendChild(stylesWrap);
    var pipesWrap = div(''); pipesWrap.style.marginBottom = '12px';
    if (ag.pipeline.indexOf('daily')>=0) pipesWrap.appendChild(span('ptag ptag-d', '‚ö° Rapido'));
    if (ag.pipeline.indexOf('deep')>=0) pipesWrap.appendChild(span('ptag ptag-dd', 'üî¨ Completo'));
    card.appendChild(pipesWrap);
    var resultEl = div('');
    var testBtn = btn('btn-secondary', '‚ñ∂ Testar', function() {
      if (!AIKEY.get()) { alert('Configure a API Key primeiro.'); return; }
      testBtn.disabled = true; testBtn.textContent = 'Analisando...';
      var snap = ST.snapshot || { prices: {}, macro_br: {}, events: [], news: [], quality: { source:'test' } };
      var prompt = buildPrompt(id, snap, ST.riskProfile, ST.config.horizon || 'medio', {});
      callAI(prompt.sys, prompt.usr, 500).then(function(result) {
        resultEl.className = 'agent-result';
        var preview = result.thesis ? result.thesis.slice(0,2).join(' | ') : JSON.stringify(result).slice(0,200);
        resultEl.textContent = preview + '...';
        addLog('TEST_' + id, 'ok', '');
      }).catch(function(e) {
        resultEl.className = 'agent-result';
        resultEl.style.color = 'var(--red)';
        resultEl.textContent = 'Erro: ' + e.message;
      }).then(function() { testBtn.disabled = false; testBtn.textContent = '‚ñ∂ Testar'; });
    });
    append(card, resultEl, testBtn);
    grid.appendChild(card);
  });
  wrap.appendChild(grid);
  return wrap;
}

// ================================================================
// AGENT OUTPUTS
// ================================================================
function renderAgentOutputs() {
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'üß† OUTPUTS IA'));
  t.appendChild(div('page-sub', 'Resultado bruto do ultimo pipeline'));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  var outputs = ST.agentOutputs;
  if (!Object.keys(outputs).length) {
    var em = div('empty-state');
    em.innerHTML = '<div class="empty-icon">üß†</div><div class="empty-title">Nada ainda</div><div class="empty-sub">Gere um Plano do Dia para ver os outputs de cada agente.</div>';
    wrap.appendChild(em);
    return wrap;
  }

  var pipeline = ST.pipeline === 'daily' ? DAILY_PIPELINE : DEEP_PIPELINE;
  var grid = div('agent-grid');
  pipeline.filter(function(id) { return outputs[id]; }).forEach(function(id) {
    var out = outputs[id];
    var expanded = false;
    var detailEl = div('');
    var card = div('');
    card.style.cssText = 'background:var(--glass-1);border:1px solid var(--border);border-radius:16px;padding:18px;cursor:pointer;transition:all .2s';
    var topRow = div('');
    topRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:10px';
    var nameEl = span(''); nameEl.style.cssText = 'font-family:JetBrains Mono,monospace;font-size:13px;color:var(--blue);font-weight:600';
    nameEl.textContent = id;
    var stEl = span(''); stEl.style.cssText = 'font-size:10px;font-weight:700;color:' + (out.parse_error ? 'var(--red)' : 'var(--green)');
    stEl.textContent = out.parse_error ? '‚ö† ERRO' : '‚úì OK';
    append(topRow, nameEl, stEl);
    card.appendChild(topRow);
    (out.thesis || []).slice(0,2).forEach(function(th) {
      var tp = p(''); tp.style.cssText = 'font-size:13px;color:var(--t2);line-height:1.5;padding:2px 0';
      tp.textContent = '‚Ä∫ ' + th;
      card.appendChild(tp);
    });
    card.appendChild(detailEl);
    card.addEventListener('click', function() {
      expanded = !expanded; detailEl.innerHTML = '';
      if (expanded) {
        var pre = el('pre', { style:{ background:'rgba(0,0,0,.4)', border:'1px solid var(--border)', borderRadius:'10px', padding:'12px', fontSize:'11px', color:'var(--t2)', lineHeight:'1.6', overflow:'auto', maxHeight:'220px', marginTop:'12px', whiteSpace:'pre-wrap' } });
        pre.textContent = JSON.stringify(out, null, 2);
        detailEl.appendChild(pre);
      }
    });
    grid.appendChild(card);
  });
  wrap.appendChild(grid);
  return wrap;
}

// ================================================================
// AI KEY
// ================================================================
function renderAIKey() {
  var hasKey = !!AIKEY.get();
  var existingKey = AIKEY.get();
  var wrap = div('');

  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'üîë IA & API KEY'));
  t.appendChild(div('page-sub', 'Configure o cerebro de IA ‚Äî Gemini e GRATUITO'));
  hdr.appendChild(t);
  if (hasKey) {
    var badge = div('', null, { display:'flex', alignItems:'center', gap:'8px', padding:'8px 14px', background:'var(--glow-green)', border:'1px solid rgba(50,215,75,.25)', borderRadius:'10px' });
    badge.innerHTML = '<span class="ai-dot on"></span><span style="font-size:13px;color:var(--green);font-weight:600">IA Ativa ‚Äî ' + (ST.aiCfg.provider === 'gemini' ? 'Gemini Free' : ST.aiCfg.provider === 'openai' ? 'OpenAI' : 'Anthropic') + '</span>';
    hdr.appendChild(badge);
  }
  wrap.appendChild(hdr);

  var hero = div('key-hero');
  hero.innerHTML = '<div class="key-hero-icon">üîë</div><div class="key-hero-title">Conecte sua IA</div><div class="key-hero-sub">Escolha o provedor e cole sua chave. O Gemini do Google e 100% gratuito e funciona perfeitamente para analise financeira.</div>';
  wrap.appendChild(hero);

  var PROVIDERS = {
    anthropic: { name:'Anthropic Claude', icon:'üß†', desc:'Alta qualidade para analise. Pago.', link:'https://console.anthropic.com/', models:[{id:'claude-sonnet-4-20250514',label:'Claude Sonnet 4 (recomendado)'},{id:'claude-haiku-4-5-20251001',label:'Claude Haiku 4.5 (economico)'}] },
    openai:    { name:'OpenAI GPT', icon:'‚ö°', desc:'GPT-4o muito capaz. Pago.', link:'https://platform.openai.com/api-keys', models:[{id:'gpt-4o',label:'GPT-4o (recomendado)'},{id:'gpt-4o-mini',label:'GPT-4o mini (economico)'}] },
    gemini:    { name:'Google Gemini ‚≠ê GRATIS', icon:'‚ôä', desc:'Gemini 2.0 Flash ‚Äî GRATUITO. Tier livre generoso, sem cartao. Perfeito para comecar.', link:'https://aistudio.google.com/app/apikey', models:[{id:'gemini-2.0-flash',label:'Gemini 2.0 Flash (gratis - recomendado)'},{id:'gemini-2.0-flash-lite',label:'Gemini 2.0 Flash Lite (mais leve)'},{id:'gemini-1.5-pro',label:'Gemini 1.5 Pro (pago)'}] }
  };

  var provCard = div('card card-blue');
  provCard.appendChild(div('card-title', '1 ‚Äî ESCOLHA O PROVEDOR'));

  var provGrid = div('prov-grid');
  provGrid.style.gridTemplateColumns = 'repeat(3,1fr)';
  ['anthropic','openai','gemini'].forEach(function(pid) {
    var info = PROVIDERS[pid];
    var pc = div('prov-card' + (ST.aiCfg.provider===pid ? ' on':''));
    if (pid === 'gemini') pc.style.borderColor = ST.aiCfg.provider==='gemini' ? 'var(--blue)' : 'rgba(50,215,75,.3)';
    pc.innerHTML = '<div class="prov-logo">' + info.icon + '</div><div class="prov-name">' + info.name + '</div><div class="prov-desc">' + info.desc + '</div>';
    var lnk = el('a', { class:'ks-link', href:info.link, target:'_blank', rel:'noopener' }, '‚Üí Obter chave gratis');
    pc.appendChild(lnk);
    pc.addEventListener('click', function() {
      var nc = { provider:pid, model:info.models[0].id };
      stateSet({ aiCfg:nc }); storeSet('cio_ai_cfg', nc); render();
    });
    provGrid.appendChild(pc);
  });
  provCard.appendChild(provGrid);

  var modelFg = div('fg');
  modelFg.appendChild(el('label', {}, 'MODELO'));
  var modelSel = el('select', { class:'select', onchange:function(e) {
    var nc = Object.assign({}, ST.aiCfg, { model:e.target.value });
    stateSet({ aiCfg:nc }); storeSet('cio_ai_cfg', nc);
  }});
  var models = PROVIDERS[ST.aiCfg.provider] ? PROVIDERS[ST.aiCfg.provider].models : PROVIDERS.gemini.models;
  models.forEach(function(m) {
    var opt = el('option', { value:m.id }, m.label);
    if (m.id === ST.aiCfg.model) opt.selected = true;
    modelSel.appendChild(opt);
  });
  modelFg.appendChild(modelSel);
  provCard.appendChild(modelFg);
  wrap.appendChild(provCard);

  // Steps simplificados
  var stepsCard = div('card card-blue');
  stepsCard.appendChild(div('card-title', '2 ‚Äî COMO PEGAR A CHAVE GEMINI GRATIS (2 minutos)'));
  var steps = div('key-steps');
  [
    ['01','Abra o Google AI Studio','Acesse aistudio.google.com/app/apikey com sua conta Google.'],
    ['02','Clique em Create API Key','Escolha qualquer projeto ou crie um novo. E gratuito.'],
    ['03','Copie a chave','A chave come√ßa com AIza... Copie ela inteira.'],
    ['04','Cole aqui e salve','Cole no campo abaixo, clique Testar e depois Salvar.']
  ].forEach(function(s) {
    var ks = div('key-step');
    ks.appendChild(div('ks-num', s[0]));
    ks.appendChild(div('ks-title', s[1]));
    ks.appendChild(div('ks-desc', s[2]));
    steps.appendChild(ks);
  });
  stepsCard.appendChild(steps);
  wrap.appendChild(stepsCard);

  // Input da chave
  var inputCard = div('card card-blue');
  inputCard.appendChild(div('card-title', '3 ‚Äî COLE SUA CHAVE AQUI'));
  if (existingKey && !ST.keyInput) {
    var activeBanner = div('banner banner-ok');
    activeBanner.innerHTML = '‚úì Chave ativa: <span style="font-family:monospace;font-size:12px">' + existingKey.slice(0,12) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + existingKey.slice(-4) + '</span>';
    activeBanner.style.marginBottom = '14px';
    inputCard.appendChild(activeBanner);
  }

  var msgEl = div('banner banner-ok'); msgEl.style.display='none';
  var keyFg = div('fg');
  keyFg.appendChild(el('label', {}, 'API KEY'));
  var keyWrap = div('key-input-wrap');
  var keyInput = el('input', { type:ST.showKey?'text':'password', class:'input',
    placeholder: existingKey ? 'Deixe em branco para manter atual' : 'AIza... (Gemini) ou sk-ant-... (Anthropic)',
    oninput: function(e) { ST.keyInput = e.target.value; }
  });
  if (ST.keyInput) keyInput.value = ST.keyInput;
  var eyeBtn = el('button', { class:'key-eye', onclick:function() {
    ST.showKey = !ST.showKey; keyInput.type = ST.showKey?'text':'password'; eyeBtn.textContent = ST.showKey?'üôà':'üëÅÔ∏è';
  }}, ST.showKey?'üôà':'üëÅÔ∏è');
  append(keyWrap, keyInput, eyeBtn);
  append(keyFg, keyWrap);
  inputCard.appendChild(keyFg);

  var actRow = div('', null, { display:'flex', gap:'10px', flexWrap:'wrap' });
  var testBtn = btn('btn-primary', '‚ñ∂ Testar Conexao', function() {
    var key = ST.keyInput || existingKey;
    if (!key) { msgEl.className='banner banner-err'; msgEl.textContent='Cole uma chave primeiro.'; msgEl.style.display='flex'; return; }
    testBtn.disabled=true; testBtn.textContent='‚öôÔ∏è Testando...';
    var prevKey = AIKEY.get(); AIKEY.set(key);
    callAI('Responda apenas com JSON valido.', '{"ping":true}', 50).then(function() {
      msgEl.className='banner banner-ok'; msgEl.textContent='‚úì Chave valida! IA conectada com ' + (ST.aiCfg.provider==='gemini'?'Gemini Free':ST.aiCfg.provider==='openai'?'OpenAI':'Anthropic');
    }).catch(function(e) {
      AIKEY.set(prevKey); msgEl.className='banner banner-err'; msgEl.textContent='‚úó Erro: ' + e.message;
    }).then(function() { msgEl.style.display='flex'; testBtn.disabled=false; testBtn.textContent='‚ñ∂ Testar Conexao'; });
  });
  var saveBtn = btn('btn-green btn', 'üíæ Salvar Chave', function() {
    var key = ST.keyInput || existingKey;
    if (!key) { msgEl.className='banner banner-err'; msgEl.textContent='Nenhuma chave para salvar.'; msgEl.style.display='flex'; return; }
    AIKEY.set(key); ST.keyInput = '';
    msgEl.className='banner banner-ok'; msgEl.textContent='‚úì Chave salva! Pronto para gerar o Plano do Dia.';
    msgEl.style.display='flex'; render();
  });
  actRow.appendChild(testBtn); actRow.appendChild(saveBtn);
  if (existingKey) {
    actRow.appendChild(btn('btn-secondary', 'üóë Remover', function() {
      AIKEY.clear(); ST.keyInput=''; render();
    }));
  }
  append(inputCard, actRow, msgEl);
  wrap.appendChild(inputCard);
  return wrap;
}

// ================================================================
// PROFILES
// ================================================================
function renderProfiles() {
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'üõ°Ô∏è MEU PERFIL'));
  t.appendChild(div('page-sub', 'Escolha o perfil que representa seu apetite por risco'));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  var cards = div('profile-cards');
  ['CONSERVADOR','SEGURO','ARROJADO'].forEach(function(k) {
    var cfg = RISK_PROFILES[k];
    var pc = div('profile-card');
    pc.style.borderColor = ST.riskProfile===k ? cfg.color : 'var(--border)';
    pc.style.background = ST.riskProfile===k ? 'rgba(255,255,255,.06)' : 'var(--glass-1)';

    var nameEl = p(''); nameEl.style.cssText = 'font-size:24px;font-weight:700;color:' + cfg.color + ';margin-bottom:8px';
    nameEl.textContent = cfg.label;
    pc.appendChild(nameEl);
    var descEl = p(''); descEl.style.cssText = 'font-size:14px;color:var(--t2);line-height:1.6;margin-bottom:16px';
    descEl.textContent = cfg.desc;
    pc.appendChild(descEl);

    var allowedTitle = p(''); allowedTitle.style.cssText = 'font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-weight:700';
    allowedTitle.textContent = 'Pode investir em:';
    pc.appendChild(allowedTitle);
    var allowedWrap = div(''); allowedWrap.style.marginBottom='12px';
    cfg.allowed.forEach(function(c) {
      var tg = span('tag', c);
      tg.style.cssText = 'margin-right:4px;margin-bottom:4px;display:inline-block;border-color:' + cfg.color + '44;color:' + cfg.color;
      allowedWrap.appendChild(tg);
    });
    pc.appendChild(allowedWrap);

    if (cfg.blocked.length) {
      var blockedTitle = p(''); blockedTitle.style.cssText = 'font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-weight:700';
      blockedTitle.textContent = 'Evita:';
      pc.appendChild(blockedTitle);
      var blockedWrap = div('');
      cfg.blocked.forEach(function(c) {
        var tg = span('tag', c);
        tg.style.cssText = 'margin-right:4px;margin-bottom:4px;display:inline-block;border-color:rgba(255,69,58,.3);color:var(--red)';
        blockedWrap.appendChild(tg);
      });
      pc.appendChild(blockedWrap);
    }

    if (ST.riskProfile===k) {
      var activeLbl = p(''); activeLbl.style.cssText = 'font-size:12px;color:' + cfg.color + ';font-weight:700;margin-top:12px';
      activeLbl.textContent = '‚úì PERFIL ATIVO';
      pc.appendChild(activeLbl);
    } else {
      var selBtn = btn('btn-secondary', 'Selecionar este perfil', function() { setState({ riskProfile:k }); });
      selBtn.style.marginTop = '12px';
      pc.appendChild(selBtn);
    }
    pc.addEventListener('click', function() { setState({ riskProfile:k }); });
    cards.appendChild(pc);
  });
  wrap.appendChild(cards);
  return wrap;
}

// ================================================================
// SUPABASE
// ================================================================
var SUPABASE_SQL = [
'-- CIO DIGITAL v3.0 Schema',
'CREATE TABLE IF NOT EXISTS morning_briefs (',
'  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,',
'  created_at TIMESTAMPTZ DEFAULT NOW(),',
'  risk_profile TEXT, pipeline_mode TEXT,',
'  brief_json JSONB, snapshot_json JSONB,',
'  agent_bundle JSONB, username TEXT);',
'',
'CREATE TABLE IF NOT EXISTS portfolio_snapshots (',
'  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,',
'  created_at TIMESTAMPTZ DEFAULT NOW(),',
'  allocations JSONB NOT NULL, username TEXT);',
'',
'CREATE TABLE IF NOT EXISTS audit_logs (',
'  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,',
'  created_at TIMESTAMPTZ DEFAULT NOW(),',
'  username TEXT, action TEXT NOT NULL,',
'  status TEXT NOT NULL, notes TEXT);',
'',
'CREATE TABLE IF NOT EXISTS app_config (',
'  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,',
'  updated_at TIMESTAMPTZ DEFAULT NOW(),',
'  key TEXT UNIQUE NOT NULL, value TEXT NOT NULL);'
].join('\n');

function renderSupabase() {
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'üóÑÔ∏è BANCO DE DADOS'));
  t.appendChild(div('page-sub', 'Supabase ‚Äî Salvar historico de briefs'));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  var dbSt = ST.dbStatus;
  var statusEl = div('db-status ' + (ST.sbClient ? (dbSt==='ok'?'db-ok':'db-err') : 'db-off'));
  statusEl.textContent = ST.sbClient ? (dbSt==='ok'?'‚óè Conectado':'‚úó Erro') : '‚óã Nao configurado';
  wrap.appendChild(statusEl);

  var tabBar = div('tab-bar');
  [['config','‚öô Config'],['schema','üóÉ SQL'],['history','üìÇ Historico']].forEach(function(tab) {
    var tb = el('button', { class:'tab-btn'+(ST.sbTab===tab[0]?' on':''), onclick:function() {
      stateSet({ sbTab:tab[0] });
      if (tab[0]==='history' && ST.sbClient) ST.sbClient.getBriefs(20).then(function(b) { setState({ sbBriefs:b||[] }); }).catch(render);
      else render();
    }}, tab[1]);
    tabBar.appendChild(tb);
  });
  wrap.appendChild(tabBar);

  if (ST.sbTab === 'config') {
    var localCfg = Object.assign({}, ST.sbCfg);
    var msgEl = div('banner banner-ok'); msgEl.style.display='none';
    var cfgCard = div('card card-blue');
    cfgCard.appendChild(div('card-title', 'CREDENCIAIS SUPABASE'));
    var desc = p(''); desc.style.cssText='font-size:13px;color:var(--t3);margin-bottom:16px;line-height:1.7';
    desc.textContent = 'Opcional ‚Äî para salvar historico dos planos gerados. Acesse app.supabase.com ‚Üí projeto ‚Üí Settings ‚Üí API.';
    cfgCard.appendChild(desc);
    var urlFg = div('fg'); urlFg.appendChild(el('label',{},'URL do Projeto'));
    var urlIn = el('input',{class:'input',type:'text',placeholder:'https://xxx.supabase.co',value:localCfg.url||'',oninput:function(e){localCfg.url=e.target.value;}});
    urlFg.appendChild(urlIn); cfgCard.appendChild(urlFg);
    var keyFg = div('fg'); keyFg.appendChild(el('label',{},'Anon Key'));
    var keyIn = el('input',{class:'input',type:'password',placeholder:'eyJhbGci...',value:localCfg.anonKey||'',oninput:function(e){localCfg.anonKey=e.target.value;}});
    keyFg.appendChild(keyIn); cfgCard.appendChild(keyFg);
    var btns = div('',null,{display:'flex',gap:'10px',flexWrap:'wrap',marginBottom:'14px'});
    var testBtn = btn('btn-primary','‚ñ∂ Testar',function() {
      if (!localCfg.url||!localCfg.anonKey) {msgEl.className='banner banner-err';msgEl.textContent='Preencha URL e Key.';msgEl.style.display='flex';return;}
      testBtn.disabled=true;testBtn.textContent='Testando...';
      createSB(localCfg.url,localCfg.anonKey).ping().then(function(){
        msgEl.className='banner banner-ok';msgEl.textContent='‚úì Conectado!';
      }).catch(function(e){
        msgEl.className='banner banner-err';msgEl.textContent='‚úó Erro: '+e.message;
      }).then(function(){msgEl.style.display='flex';testBtn.disabled=false;testBtn.textContent='‚ñ∂ Testar';});
    });
    var saveBtn = btn('btn-green btn','üíæ Salvar',function() {
      var nc = Object.assign({},localCfg,{enabled:true});
      storeSet('cio_sb',nc);stateSet({sbCfg:nc});
      initSupabase().then(function(){msgEl.className='banner banner-ok';msgEl.textContent='‚úì Salvo!';msgEl.style.display='flex';setTimeout(render,600);});
    });
    append(btns,testBtn,saveBtn);
    if (ST.sbClient) {
      btns.appendChild(btn('btn-secondary','Desabilitar',function(){
        var nc=Object.assign({},localCfg,{enabled:false});
        storeSet('cio_sb',nc);setState({sbCfg:nc,sbClient:null,dbStatus:null});
      }));
    }
    append(cfgCard,btns,msgEl);
    wrap.appendChild(cfgCard);
  }

  if (ST.sbTab === 'schema') {
    var schCard = div('card card-blue');
    var schHdr = div('',null,{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'});
    schHdr.appendChild(div('card-title','SQL SCHEMA'));
    var cpBtn = el('button',{class:'copy-btn',onclick:function(){
      navigator.clipboard.writeText(SUPABASE_SQL).then(function(){cpBtn.textContent='‚úì Copiado!';setTimeout(function(){cpBtn.textContent='Copiar SQL';},2000);});
    }},'Copiar SQL');
    schHdr.appendChild(cpBtn);
    schCard.appendChild(schHdr);
    schCard.appendChild(el('pre',{class:'sql-block'},SUPABASE_SQL));
    wrap.appendChild(schCard);
  }

  if (ST.sbTab === 'history') {
    var histCard = div('card card-blue');
    var histHdr = div('',null,{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'});
    histHdr.appendChild(div('card-title','HISTORICO DE BRIEFS'));
    histHdr.appendChild(btn('btn-primary','‚Ü∫ Atualizar',function(){
      if(!ST.sbClient){alert('Conecte o Supabase.');return;}
      ST.sbClient.getBriefs(20).then(function(b){setState({sbBriefs:b||[]});}).catch(function(e){alert(e.message);});
    }));
    histCard.appendChild(histHdr);
    if (!ST.sbClient) histCard.appendChild(div('banner banner-warn','Conecte o Supabase para ver historico.'));
    else if (!ST.sbBriefs.length) histCard.appendChild(div('empty-state','<div class="empty-icon">üìÇ</div><div class="empty-title">Sem historico</div><div class="empty-sub">Gere um brief para comecar.</div>'));
    else {
      var tbl = el('table',{class:'data-table'});
      var thead = el('thead',{},el('tr',{},[el('th',{},'Data'),el('th',{},'Perfil'),el('th',{},'Modo'),el('th',{},'JSON')]));
      var tbody = el('tbody');
      ST.sbBriefs.forEach(function(b) {
        var tr = el('tr'); tr.style.cursor='pointer';
        tr.appendChild(el('td',{style:{fontSize:'12px'}},new Date(b.created_at).toLocaleString('pt-BR')));
        var ptd = el('td'); ptd.style.cssText='font-weight:700;font-size:12px;color:'+(b.risk_profile==='CONSERVADOR'?'var(--green)':b.risk_profile==='SEGURO'?'var(--amber)':'var(--red)');
        ptd.textContent=b.risk_profile; tr.appendChild(ptd);
        tr.appendChild(el('td',{style:{fontSize:'12px'}},b.pipeline_mode));
        var cpTd=el('td'); var cpB=el('button',{class:'copy-btn',onclick:function(e){e.stopPropagation();navigator.clipboard.writeText(JSON.stringify(b.brief_json,null,2));}},'>Copy');
        cpTd.appendChild(cpB); tr.appendChild(cpTd);
        tr.addEventListener('click',function(){setState({histSelected:ST.histSelected&&ST.histSelected.id===b.id?null:b});});
        tbody.appendChild(tr);
      });
      tbl.appendChild(thead);tbl.appendChild(tbody);histCard.appendChild(tbl);
      if (ST.histSelected) {
        var det=div('',null,{marginTop:'16px'});
        var pre=el('pre',{style:{background:'rgba(0,0,0,.4)',border:'1px solid var(--border)',borderRadius:'10px',padding:'14px',fontSize:'11px',color:'var(--t2)',lineHeight:'1.6',overflow:'auto',maxHeight:'280px',whiteSpace:'pre-wrap'}});
        pre.textContent=JSON.stringify(ST.histSelected.brief_json,null,2);
        det.appendChild(pre);histCard.appendChild(det);
      }
    }
    wrap.appendChild(histCard);
  }
  return wrap;
}

// ================================================================
// AI COSTS
// ================================================================
function renderAICosts() {
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'üí° PIPELINE & IA'));
  t.appendChild(div('page-sub', 'Configuracao dos agentes e custos estimados'));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  var pipeCard = div('card card-blue');
  pipeCard.appendChild(div('card-title', 'MODO DO PIPELINE'));
  var pToggle = div('pipe-toggle'); pToggle.style.marginBottom='16px';
  append(pToggle,
    el('button',{class:'pipe-btn'+(ST.pipeline==='daily'?' on':''),onclick:function(){setState({pipeline:'daily'});}}, '‚ö° Rapido (4 agentes)'),
    el('button',{class:'pipe-btn'+(ST.pipeline==='deep'?' on':''),onclick:function(){setState({pipeline:'deep'});}}, 'üî¨ Completo (10 agentes)')
  );
  pipeCard.appendChild(pToggle);
  var pipeInfo = div('');
  pipeInfo.style.cssText = 'display:flex;gap:20px;flex-wrap:wrap';
  [
    ['Pipeline Rapido', DAILY_PIPELINE.join(' ‚Üí ')],
    ['Pipeline Completo', DEEP_PIPELINE.join(' ‚Üí ')]
  ].forEach(function(row) {
    var c = div('',null,{flex:'1',minWidth:'200px'});
    var lbl = p(''); lbl.style.cssText='font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-weight:700';
    lbl.textContent = row[0];
    var val = p(''); val.style.cssText='font-size:12px;color:var(--t2);font-family:JetBrains Mono,monospace;line-height:1.8';
    val.textContent = row[1];
    append(c,lbl,val); pipeInfo.appendChild(c);
  });
  pipeCard.appendChild(pipeInfo);
  wrap.appendChild(pipeCard);

  var infoCard = div('card card-blue');
  infoCard.appendChild(div('card-title', 'CONFIGURACAO ATUAL'));
  [
    ['Provedor', ST.aiCfg.provider==='gemini'?'Google Gemini (Gratuito)':ST.aiCfg.provider==='openai'?'OpenAI GPT':'Anthropic Claude'],
    ['Modelo', ST.aiCfg.model || 'Nao configurado'],
    ['Max tokens/chamada', '1800'],
    ['Fontes de mercado', 'Binance + ExchangeRate + Gold-API + BCB PTAX'],
    ['Dados em tempo real', 'Cripto (Binance), Cambio (ExchangeRate), Metais (Gold-API), PTAX BCB']
  ].forEach(function(row) {
    var r = div('info-row');
    r.appendChild(span('info-label', row[0]));
    r.appendChild(span('info-val', row[1]));
    infoCard.appendChild(r);
  });
  wrap.appendChild(infoCard);
  return wrap;
}

// ================================================================
// LOGS
// ================================================================
function renderLogs() {
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', 'üìã HISTORICO'));
  t.appendChild(div('page-sub', ST.logs.length + ' registros nesta sessao'));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  var card = div('card card-blue');
  var tbl = el('table',{class:'data-table'});
  var thead = el('thead',{},el('tr',{},[el('th',{},'HORARIO'),el('th',{},'ACAO'),el('th',{},'STATUS'),el('th',{},'NOTAS')]));
  var tbody = el('tbody');
  if (!ST.logs.length) {
    tbody.appendChild(el('tr',{},el('td',{colspan:'4',style:{textAlign:'center',padding:'32px',color:'var(--t3)'}},'Nenhum registro ainda.')));
  } else {
    ST.logs.forEach(function(l) {
      var tr = el('tr');
      tr.appendChild(el('td',{style:{fontSize:'12px'}},new Date(l.ts).toLocaleTimeString('pt-BR')));
      tr.appendChild(el('td',{style:{color:'var(--amber)',fontSize:'12px'}},l.action));
      var stColors = {ok:'var(--green)',warn:'var(--amber)',fail:'var(--red)'};
      tr.appendChild(el('td',{style:{color:stColors[l.status]||'var(--t2)',fontSize:'12px',fontWeight:'700'}},l.status.toUpperCase()));
      tr.appendChild(el('td',{style:{fontSize:'11px',color:'var(--t3)',maxWidth:'200px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},l.notes));
      tbody.appendChild(tr);
    });
  }
  append(tbl,thead,tbody);
  card.appendChild(tbl);
  wrap.appendChild(card);
  return wrap;
}

// ================================================================
// SETTINGS
// ================================================================
function renderSettings() {
  var wrap = div('');
  var hdr = div('page-header');
  var t = div('');
  t.appendChild(div('page-title', '‚öôÔ∏è CONFIGURACOES'));
  t.appendChild(div('page-sub', 'Sistema e seguranca'));
  hdr.appendChild(t);
  wrap.appendChild(hdr);

  var sysCard = div('card card-blue');
  sysCard.appendChild(div('card-title', 'SISTEMA'));
  [
    ['Versao', APP_VERSION],
    ['Usuario', ST.user?ST.user.username:''],
    ['Perfil', RISK_PROFILES[ST.riskProfile].label],
    ['IA', ST.aiCfg.provider + ' ‚Äî ' + ST.aiCfg.model],
    ['Supabase', ST.sbClient?'Conectado':'Nao configurado'],
    ['Ativos monitorados', Object.keys(ASSET_LABELS).length + ' pares de mercado']
  ].forEach(function(row) {
    var r = div('info-row');
    r.appendChild(span('info-label', row[0]));
    r.appendChild(span('info-val', row[1]));
    sysCard.appendChild(r);
  });
  wrap.appendChild(sysCard);

  var f = { old:'', nw:'', cf:'' };
  var pwMsg = p(''); pwMsg.style.cssText = 'font-size:13px;margin-top:8px;min-height:18px';
  var pwCard = div('card card-blue');
  pwCard.appendChild(div('card-title', 'TROCAR SENHA'));
  [['Senha atual','old'],['Nova senha (min. 8 chars)','nw'],['Confirmar nova senha','cf']].forEach(function(row) {
    var fg = div('fg'); fg.appendChild(el('label',{},row[0]));
    var inp = el('input',{class:'input',type:'password',oninput:function(e){f[row[1]]=e.target.value;}});
    fg.appendChild(inp); pwCard.appendChild(fg);
  });
  var saveBtn = btn('btn-primary','Alterar Senha',function() {
    if (!f.old||!f.nw||!f.cf) {pwMsg.textContent='Preencha todos.';pwMsg.style.color='var(--red)';return;}
    if (f.nw!==f.cf) {pwMsg.textContent='Senhas nao coincidem.';pwMsg.style.color='var(--red)';return;}
    if (f.nw.length<8) {pwMsg.textContent='Minimo 8 caracteres.';pwMsg.style.color='var(--red)';return;}
    if (f.old!=='dbsa1981') {pwMsg.textContent='Senha atual incorreta.';pwMsg.style.color='var(--red)';return;}
    pwMsg.textContent='‚úì Senha alterada.';pwMsg.style.color='var(--green)';
  });
  append(pwCard,saveBtn,pwMsg);
  wrap.appendChild(pwCard);
  return wrap;
}

// ================================================================
// BOOT
// ================================================================
render();

</script>
</body>
</html>