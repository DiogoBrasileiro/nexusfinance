<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>CIO DIGITAL ‚Äî Mesa de Opera√ß√µes</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#07090d;--bg2:#0c1018;--bg3:#131920;--bg4:#1a2230;--bd:#1e2938;--bd2:#263347;--tx:#dde6f0;--tx2:#7a8fa8;--tx3:#3d5068;--ac:#00c8f0;--ac2:#0099bb;--ac3:#006080;--gold:#e8a820;--gr:#2ea84a;--rd:#e84040;--am:#c88820;--pu:#7c4dcc}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:14px;min-height:100vh}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:2px}
input,select,button{font-family:'DM Sans',sans-serif}
/* LAYOUT */
.app{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;overflow-y:auto}
.main{margin-left:220px;flex:1;padding:28px;min-height:100vh}
/* LOGO */
.sb-logo{padding:18px 16px 14px;border-bottom:1px solid var(--bd)}
.sb-name{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--ac);letter-spacing:3px}
.sb-ver{font-size:8px;color:var(--tx3);letter-spacing:2px;text-transform:uppercase;margin-top:3px}
.sb-aistat{display:flex;align-items:center;gap:5px;margin-top:7px}
.ai-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.ai-dot.on{background:var(--gr);box-shadow:0 0 5px var(--gr)}
.ai-dot.off{background:var(--rd)}
.ai-label{font-size:9px;letter-spacing:.5px}
/* NAV */
.sb-nav{flex:1;padding:10px 0}
.nav-section{margin-bottom:4px}
.nav-title{font-size:8px;color:var(--tx3);letter-spacing:2px;text-transform:uppercase;padding:7px 16px 2px}
.nav-item{display:flex;align-items:center;gap:8px;padding:8px 16px;color:var(--tx2);font-size:12px;cursor:pointer;transition:all .12s;border-left:2px solid transparent;user-select:none}
.nav-item:hover{color:var(--tx);background:rgba(255,255,255,.025)}
.nav-item.active{color:var(--ac);border-left-color:var(--ac);background:rgba(0,200,240,.06)}
.nav-icon{width:16px;text-align:center;font-size:13px}
/* SIDEBAR BOTTOM */
.sb-bottom{padding:12px;border-top:1px solid var(--bd)}
.no-key-badge{padding:7px 10px;background:rgba(232,64,64,.12);border:1px solid rgba(232,64,64,.3);border-radius:7px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:7px}
.nkb-text{font-size:10px;color:var(--rd);font-weight:700}
.nkb-sub{font-size:9px;color:var(--tx3)}
.key-ok-badge{padding:6px 10px;background:rgba(46,168,74,.08);border:1px solid rgba(46,168,74,.2);border-radius:7px;margin-bottom:8px;display:flex;align-items:center;gap:7px}
.user-area{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.user-av{width:28px;height:28px;background:linear-gradient(135deg,var(--ac),var(--pu));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#000;flex-shrink:0}
.user-name{font-size:11px;color:var(--tx2);font-weight:500}
.user-role{font-size:9px;color:var(--tx3)}
.btn-logout{width:100%;padding:7px;background:transparent;border:1px solid var(--bd);border-radius:6px;color:var(--tx3);font-size:11px;cursor:pointer;transition:all .15s}
.btn-logout:hover{border-color:var(--rd);color:var(--rd)}
/* PAGE HEADER */
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:22px;gap:16px;flex-wrap:wrap}
.page-title{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px}
.page-sub{font-size:11px;color:var(--tx2);margin-top:2px}
/* BUTTONS */
.btn-primary{padding:9px 18px;background:linear-gradient(135deg,var(--ac),var(--ac2));color:#000;border:none;border-radius:7px;font-weight:700;font-size:12px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary:hover{opacity:.9}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-primary.green{background:linear-gradient(135deg,var(--gr),#1a7a35);color:#fff}
.btn-secondary{padding:7px 14px;background:transparent;border:1px solid var(--bd);color:var(--tx2);border-radius:7px;font-size:11px;cursor:pointer;transition:all .12s}
.btn-secondary:hover{border-color:var(--bd2);color:var(--tx)}
/* BANNERS */
.banner{padding:9px 14px;border-radius:7px;font-size:11px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.banner.warn{background:rgba(200,136,32,.1);border:1px solid rgba(200,136,32,.25);color:var(--gold)}
.banner.err{background:rgba(232,64,64,.1);border:1px solid rgba(232,64,64,.25);color:var(--rd)}
.banner.ok{background:rgba(46,168,74,.1);border:1px solid rgba(46,168,74,.25);color:var(--gr)}
/* CARDS */
.card{background:var(--bg2);border:1px solid var(--bd);border-radius:11px;padding:18px;position:relative;overflow:hidden;margin-bottom:14px}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--card-color,var(--ac)),transparent)}
.card-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.card-badge{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--tx3);background:var(--bg3);padding:2px 7px;border-radius:3px}
.card-title{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--tx2)}
.card-inner{background:var(--bg3);border-radius:8px;padding:14px;margin-bottom:10px}
/* GRID */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.col-full{grid-column:1/-1}
/* FORM */
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:9px;color:var(--tx2);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px}
.form-input{width:100%;padding:10px 13px;background:var(--bg3);border:1px solid var(--bd);border-radius:7px;color:var(--tx);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;transition:border-color .2s}
.form-input:focus{border-color:var(--ac)}
.form-input.valid{border-color:var(--gr)}
.form-input.invalid{border-color:var(--rd)}
.form-select{width:100%;padding:9px 12px;background:var(--bg3);border:1px solid var(--bd);border-radius:7px;color:var(--tx);font-size:12px;outline:none;cursor:pointer}
.form-hint{font-size:10px;color:var(--tx3);margin-top:4px}
/* TOGGLE */
.toggle{width:36px;height:20px;background:var(--bd2);border-radius:10px;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;border:none}
.toggle.on{background:var(--ac)}
.toggle::after{content:'';position:absolute;width:14px;height:14px;background:white;border-radius:50%;top:3px;left:3px;transition:left .2s}
.toggle.on::after{left:19px}
/* PROFILE SELECTOR */
.profile-row{display:flex;gap:6px}
.profile-btn{padding:6px 12px;border-radius:5px;font-size:10px;font-weight:700;letter-spacing:.5px;cursor:pointer;border:1px solid var(--bd);background:transparent;color:var(--tx2);transition:all .15s}
.profile-btn.C.active{border-color:#22c55e;color:#22c55e;background:rgba(34,197,94,.1)}
.profile-btn.S.active{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,.1)}
.profile-btn.A.active{border-color:#ef4444;color:#ef4444;background:rgba(239,68,68,.1)}
/* PIPELINE TOGGLE */
.pipe-toggle{display:flex;background:var(--bg3);border:1px solid var(--bd);border-radius:7px;overflow:hidden}
.pipe-btn{padding:7px 13px;font-size:11px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--tx2)}
.pipe-btn.active{background:var(--ac3);color:var(--ac)}
/* LOADING SPINNER */
.spinner-wrap{display:flex;flex-direction:column;align-items:center;padding:60px 20px}
.spinner{width:36px;height:36px;border:2px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}
.progress-item{display:flex;align-items:center;gap:8px;padding:3px 0;font-size:11px;transition:color .2s}
.progress-item.done{color:var(--gr)}
.progress-item.running{color:var(--ac)}
.progress-item.pending{color:var(--tx3)}
/* EMPTY STATE */
.empty-state{text-align:center;padding:60px 20px}
.empty-icon{font-size:40px;margin-bottom:12px;opacity:.2}
.empty-title{font-size:15px;color:var(--tx2);margin-bottom:6px}
.empty-sub{font-size:11px;color:var(--tx3);max-width:340px;margin:0 auto;line-height:1.6}
/* SNAPSHOT BAR */
.snap-bar{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:18px}
.snap-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.snap-label{font-size:9px;color:var(--tx3);letter-spacing:2px;text-transform:uppercase;font-weight:700}
.snap-grid{display:flex;gap:8px;flex-wrap:wrap}
.snap-item{background:var(--bg3);border-radius:7px;padding:10px;min-width:100px}
.snap-sym{font-size:9px;color:var(--tx3);letter-spacing:1px;margin-bottom:3px}
.snap-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600}
.snap-chg{font-size:9px;font-family:'JetBrains Mono',monospace;margin-top:2px}
.pos{color:var(--gr)}.neg{color:var(--rd)}
/* OPP CARD */
.opp-card{background:var(--bg3);border:1px solid var(--bd);border-radius:9px;padding:14px;margin-bottom:10px}
.opp-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.opp-class{font-size:9px;color:var(--ac);font-weight:700;letter-spacing:1.5px;text-transform:uppercase}
.opp-action{padding:2px 8px;border-radius:3px;font-size:8px;font-weight:700;letter-spacing:1px}
.act-monitor{background:rgba(200,136,32,.15);color:var(--gold);border:1px solid rgba(200,136,32,.3)}
.act-simul{background:rgba(0,200,240,.1);color:var(--ac);border:1px solid rgba(0,200,240,.3)}
.opp-thesis{font-size:12px;font-weight:500;margin-bottom:8px;line-height:1.4;color:var(--tx)}
.opp-detail{font-size:10px;color:var(--tx2);margin-bottom:3px}
.opp-detail strong{color:var(--tx3);text-transform:uppercase;font-size:8px;letter-spacing:.5px;display:block}
.opp-risks{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.risk-tag{padding:2px 6px;background:rgba(232,64,64,.1);border:1px solid rgba(232,64,64,.2);border-radius:3px;font-size:9px;color:var(--rd)}
.conf-badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:3px;font-size:8px;font-weight:700;margin-top:6px}
.conf-high{background:rgba(46,168,74,.1);color:var(--gr);border:1px solid rgba(46,168,74,.2)}
.conf-med{background:rgba(200,136,32,.1);color:var(--am);border:1px solid rgba(200,136,32,.2)}
.conf-low{background:rgba(232,64,64,.1);color:var(--rd);border:1px solid rgba(232,64,64,.2)}
/* TERMOMETER */
.sema{display:flex;align-items:center;gap:5px;margin-bottom:12px}
.sema-dot{width:12px;height:12px;border-radius:50%;opacity:.2;transition:all .3s}
.sema-dot.on{opacity:1;box-shadow:0 0 8px currentColor}
.sema-verde{background:var(--gr);color:var(--gr)}
.sema-amarelo{background:var(--am);color:var(--am)}
.sema-vermelho{background:var(--rd);color:var(--rd)}
.sema-label{font-size:11px;font-weight:700;margin-left:4px}
.thermo-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.thermo-item{background:var(--bg3);border-radius:6px;padding:10px}
.thermo-lbl{font-size:8px;color:var(--tx3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px}
.thermo-val{font-size:13px;font-weight:700}
/* CHECKLIST */
.check-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.check-section-title{display:flex;align-items:center;gap:6px;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px}
.check-item{display:flex;align-items:flex-start;gap:6px;padding:5px 0;font-size:11px;color:var(--tx2);border-bottom:1px solid rgba(255,255,255,.03)}
.check-item:last-child{border-bottom:none}
/* TAG */
.tag{padding:1px 6px;border-radius:3px;font-size:9px;background:var(--bg4);border:1px solid var(--bd2);color:var(--tx3)}
/* TABLE */
.data-table{width:100%;border-collapse:collapse}
.data-table th{text-align:left;padding:8px 10px;font-size:8px;color:var(--tx3);letter-spacing:1.5px;text-transform:uppercase;border-bottom:1px solid var(--bd)}
.data-table td{padding:9px 10px;font-size:11px;color:var(--tx2);border-bottom:1px solid rgba(255,255,255,.03);font-family:'JetBrains Mono',monospace}
.data-table tr:hover td{background:rgba(255,255,255,.015)}
/* AGENT GRID */
.agent-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:14px}
.agent-card{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:16px;position:relative}
.agent-card.online::after{content:'ONLINE';position:absolute;top:12px;right:12px;font-size:8px;font-weight:700;letter-spacing:1px;color:var(--gr);background:rgba(46,168,74,.1);border:1px solid rgba(46,168,74,.2);padding:2px 7px;border-radius:3px}
.agent-name{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--ac);margin-bottom:3px}
.agent-ver{font-size:9px;color:var(--tx3);margin-bottom:7px}
.agent-desc{font-size:11px;color:var(--tx2);line-height:1.5;margin-bottom:8px}
.agent-styles{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px}
.agent-style{padding:1px 6px;border-radius:3px;font-size:9px;background:var(--bg4);border:1px solid var(--bd2);color:var(--pu)}
.agent-pipes{display:flex;gap:3px;margin-bottom:10px}
.pipe-tag{padding:1px 6px;border-radius:3px;font-size:8px;font-weight:700}
.pipe-daily{background:rgba(0,200,240,.1);color:var(--ac);border:1px solid rgba(0,200,240,.2)}
.pipe-deep{background:rgba(124,77,204,.1);color:var(--pu);border:1px solid rgba(124,77,204,.2)}
.agent-result{margin-top:10px;padding:8px;background:var(--bg);border:1px solid var(--bd);border-radius:6px;font-size:9px;color:var(--tx2);font-family:'JetBrains Mono',monospace;line-height:1.5;max-height:110px;overflow-y:auto}
/* PROFILE CARDS */
.profile-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.profile-card{background:var(--bg2);border:2px solid var(--bd);border-radius:11px;padding:18px;cursor:pointer;transition:all .2s}
/* FILTER BAR */
.filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px}
.filter-btn{padding:5px 12px;border-radius:20px;font-size:11px;cursor:pointer;border:1px solid var(--bd);background:transparent;color:var(--tx2);transition:all .12s}
.filter-btn.active{border-color:var(--ac);color:var(--ac);background:rgba(0,200,240,.07)}
/* SLIDER */
.slider-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.slider-row label{font-size:11px;color:var(--tx2);width:130px;flex-shrink:0}
.slider-row input[type=range]{flex:1;accent-color:var(--ac)}
.slider-val{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--ac);width:36px;text-align:right}
.alloc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:18px}
.alloc-card{background:var(--bg2);border:1px solid var(--bd);border-radius:9px;padding:14px}
.alloc-cls{font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.alloc-pct{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;color:var(--ac)}
.alloc-bar{height:2px;background:var(--bd);border-radius:1px;margin-top:6px}
.alloc-fill{height:100%;background:var(--ac);border-radius:1px}
/* DISCLAIMER */
.disclaimer{background:rgba(200,136,32,.05);border:1px solid rgba(200,136,32,.15);border-radius:7px;padding:10px 14px;font-size:10px;color:var(--am);line-height:1.5;margin-top:20px;display:flex;gap:8px}
/* SQL BLOCK */
.sql-block{background:var(--bg);border:1px solid var(--bd);border-radius:8px;padding:14px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--tx2);line-height:1.8;overflow:auto;white-space:pre;max-height:300px}
/* COPY BTN */
.copy-btn{padding:4px 10px;font-size:9px;background:transparent;border:1px solid var(--bd);color:var(--tx2);border-radius:4px;cursor:pointer;transition:all .12s}
.copy-btn:hover{border-color:var(--ac);color:var(--ac)}
/* KEY PAGE */
.key-hero{text-align:center;padding:28px 20px 22px;background:var(--bg2);border:1px solid var(--bd);border-radius:12px;margin-bottom:18px;position:relative;overflow:hidden}
.key-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(0,200,240,.07),transparent 65%);pointer-events:none}
.key-hero-icon{font-size:44px;margin-bottom:10px}
.key-hero-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:3px;color:var(--ac);margin-bottom:6px}
.key-hero-sub{font-size:11px;color:var(--tx2);max-width:400px;margin:0 auto;line-height:1.7}
.provider-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.prov-card{background:var(--bg3);border:2px solid var(--bd);border-radius:10px;padding:15px;cursor:pointer;transition:all .2s}
.prov-card.selected{border-color:var(--ac);background:rgba(0,200,240,.06)}
.prov-logo{font-size:22px;margin-bottom:7px}
.prov-name{font-size:13px;font-weight:700;color:var(--tx);margin-bottom:3px}
.prov-desc{font-size:10px;color:var(--tx3);line-height:1.5}
.key-steps{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:16px}
.key-step{background:var(--bg3);border:1px solid var(--bd);border-radius:9px;padding:13px}
.ks-num{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--ac);margin-bottom:5px}
.ks-title{font-size:12px;font-weight:600;color:var(--tx);margin-bottom:4px}
.ks-desc{font-size:10px;color:var(--tx3);line-height:1.6}
.ks-link{font-size:10px;color:var(--ac);text-decoration:none;display:inline-block;margin-top:4px}
.ks-link:hover{text-decoration:underline}
.key-input-wrap{position:relative}
.key-input-wrap .form-input{padding-right:44px}
.key-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--tx3);cursor:pointer;font-size:14px}
/* LOGIN */
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);background-image:radial-gradient(ellipse at 15% 60%,rgba(0,200,240,.05),transparent 55%),radial-gradient(ellipse at 85% 20%,rgba(124,77,204,.04),transparent 50%)}
.login-card{width:380px;padding:44px 38px;background:var(--bg2);border:1px solid var(--bd);border-radius:14px;box-shadow:0 0 80px rgba(0,200,240,.06),0 24px 60px rgba(0,0,0,.5)}
.login-logo{text-align:center;margin-bottom:32px}
.login-name{font-family:'Bebas Neue',sans-serif;font-size:42px;color:var(--ac);letter-spacing:5px;line-height:1}
.login-line{width:60px;height:2px;background:linear-gradient(90deg,transparent,var(--ac),transparent);margin:8px auto}
.login-sub{font-size:9px;color:var(--tx3);letter-spacing:3px;text-transform:uppercase}
.login-fg{margin-bottom:14px}
.login-fg label{display:block;font-size:9px;color:var(--tx2);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px}
.login-fg input{width:100%;padding:11px 14px;background:var(--bg3);border:1px solid var(--bd);border-radius:8px;color:var(--tx);font-family:'JetBrains Mono',monospace;font-size:13px;outline:none;transition:all .2s}
.login-fg input:focus{border-color:var(--ac);box-shadow:0 0 0 3px rgba(0,200,240,.1)}
.login-btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--ac),var(--ac2));color:#000;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s}
.login-btn:hover{opacity:.9}
.login-btn:disabled{opacity:.4;cursor:not-allowed}
.login-err{color:var(--rd);font-size:11px;margin-top:8px;text-align:center}
.login-note{margin-top:18px;padding:10px 14px;background:rgba(200,136,32,.06);border:1px solid rgba(200,136,32,.15);border-radius:7px;font-size:10px;color:var(--tx3);line-height:1.6;text-align:center}
/* HISTORY TABLE */
.hist-row{cursor:pointer}
.hist-row:hover td{background:rgba(0,200,240,.03)!important}
/* SUPABASE STATUS */
.db-status{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;margin-bottom:14px;font-size:11px}
.db-ok{background:rgba(46,168,74,.1);border:1px solid rgba(46,168,74,.25);color:var(--gr)}
.db-err{background:rgba(232,64,64,.1);border:1px solid rgba(232,64,64,.25);color:var(--rd)}
.db-off{background:rgba(255,255,255,.04);border:1px solid var(--bd);color:var(--tx3)}
/* PIPE STEP */
.plan-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.plan-card{background:var(--bg3);border-radius:8px;padding:12px}
.plan-cls{font-size:10px;color:var(--ac);font-weight:700;text-transform:uppercase;letter-spacing:1px}
.plan-posture{font-size:9px;padding:1px 7px;border-radius:3px;font-weight:700;float:right}
.plan-def{background:rgba(232,64,64,.15);color:var(--rd)}
.plan-neu{background:rgba(200,136,32,.15);color:var(--am)}
.plan-ofe{background:rgba(46,168,74,.15);color:var(--gr)}
/* RESPONSIVE */
@media(max-width:700px){.sidebar{display:none}.main{margin-left:0}.grid-2{grid-template-columns:1fr}.profile-cards{grid-template-columns:1fr}.provider-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app"></div>
<script>
// ============================================================
// STATE & CONSTANTS
// ============================================================
const APP_VERSION = "2.1.0";

const RISK_PROFILES = {
  CONSERVADOR:{label:"Conservador",color:"#22c55e",bg:"#052e16",allowed:["Renda Fixa","Tesouro","LCI/LCA","Fundos DI"],blocked:["Cripto","Alavancagem","Derivativos"],max_risk:"baixo",min_conf:"alta",mode:"MONITORAR",desc:"Preserva√ß√£o de capital. Foco em liquidez e controle."},
  SEGURO:{label:"Seguro",color:"#f59e0b",bg:"#451a03",allowed:["Renda Fixa","FIIs","A√ß√µes Blue Chip","C√¢mbio"],blocked:["Cripto","Alavancagem"],max_risk:"medio",min_conf:"media",mode:"MONITORAR",desc:"Equil√≠brio risco/retorno com travas claras."},
  ARROJADO:{label:"Arrojado",color:"#ef4444",bg:"#450a0a",allowed:["A√ß√µes","FIIs","Cripto","C√¢mbio","Derivativos","BDRs"],blocked:[],max_risk:"alto",min_conf:"baixa",mode:"SIMULAR",desc:"Busca de alpha. Aceita volatilidade com controle de posi√ß√µes."}
};

const DAILY_PIPELINE = ["MACRO_ORACLE","RISK_SHIELD","DERIVATIVES_HEDGE","ORCHESTRATOR_CIO"];
const DEEP_PIPELINE = ["MACRO_ORACLE","BRASIL_ANALYST","QUANT_SIGNAL","EQUITY_STOCK_MASTER","REAL_ASSETS_CREDIT","RISK_SHIELD","DERIVATIVES_HEDGE","EXECUTION_DESK","LEGAL_TAX_OPTIMIZER","ORCHESTRATOR_CIO"];

const AGENTS = {
  MACRO_ORACLE:{id:"MACRO_ORACLE",desc:"Macro global, bancos centrais, regime risk-on/off.",styles:["Druckenmiller","Dalio","Soros"],pipeline:["daily","deep"]},
  BRASIL_ANALYST:{id:"BRASIL_ANALYST",desc:"Copom, Selic, IPCA, fiscal e impactos BR.",styles:["Arm√≠nio Fraga","P√©rsio Arida","Andr√© Lara Resende"],pipeline:["deep"]},
  QUANT_SIGNAL:{id:"QUANT_SIGNAL",desc:"Sinais quant: momentum, revers√£o, volatilidade.",styles:["Jim Simons","Cliff Asness","L√≥pez de Prado"],pipeline:["deep"]},
  EQUITY_STOCK_MASTER:{id:"EQUITY_STOCK_MASTER",desc:"A√ß√µes por setor/√≠ndice. Sem ticker por padr√£o.",styles:["Peter Lynch","Philip Fisher","Terry Smith"],pipeline:["deep"]},
  REAL_ASSETS_CREDIT:{id:"REAL_ASSETS_CREDIT",desc:"FIIs, im√≥veis, cr√©dito privado (CRI/CRA).",styles:["Sam Zell","Schwarzman","Bruce Flatt"],pipeline:["deep"]},
  RISK_SHIELD:{id:"RISK_SHIELD",desc:"CRO: stress test, drawdown, liquidez. Em d√∫vida, rejeita.",styles:["Howard Marks","Aaron Brown","Bookstaber"],pipeline:["daily","deep"]},
  DERIVATIVES_HEDGE:{id:"DERIVATIVES_HEDGE",desc:"Prote√ß√£o assim√©trica e antifragilidade por classe.",styles:["Nassim Taleb","Spitznagel","Boaz Weinstein"],pipeline:["daily","deep"]},
  EXECUTION_DESK:{id:"EXECUTION_DESK",desc:"Execu√ß√£o: liquidez, slippage, impacto, timing.",styles:["Citadel Securities","Virtu Financial","Jane Street"],pipeline:["deep"]},
  LEGAL_TAX_OPTIMIZER:{id:"LEGAL_TAX_OPTIMIZER",desc:"Compliance, tributa√ß√£o. N√£o substitui advogado.",styles:["Big4","Baker McKenzie","Withers Worldwide"],pipeline:["deep"]},
  ORCHESTRATOR_CIO:{id:"ORCHESTRATOR_CIO",desc:"CIO Final. Sintetiza todos os agentes no Morning Brief.",styles:["Ray Dalio","Paul Tudor Jones","Soros"],pipeline:["daily","deep"]}
};

const MOCK_SNAPSHOT = {
  ts:new Date().toISOString(),
  prices:{BTCUSDT:{last:95240,chg24h_pct:1.8},USDBRL:{last:5.74,chg24h_pct:-0.3},IBOV:{last:128500,chg24h_pct:0.6}},
  macro_br:{selic:10.75,ipca_yoy:4.87,usdbrl:5.74},
  events:[
    {when:"Hoje 14h00",title:"IPCA-15 acima do esperado: 0,62% vs 0,55%",impact:"high"},
    {when:"Hoje 15h30",title:"Fed: ata refor√ßa postura hawkish para 2025",impact:"high"},
    {when:"Amanh√£ 09h00",title:"Copom: divulga√ß√£o de ata",impact:"med"}
  ],
  news:[
    {title:"China anuncia pacote fiscal adicional de USD 300bi",source:"Reuters",time:"08:00",tags:["macro","commodities"]},
    {title:"BCB mant√©m guidance hawkish; Selic est√°vel em 10,75%",source:"Valor",time:"07:30",tags:["macro","renda_fixa"]}
  ],
  quality:{source:"mock_demo",partial:false,notes:["dados de demonstra√ß√£o"]}
};

// ============================================================
// STORAGE
// ============================================================
const Store = {
  get:(k,def=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):def;}catch{return def;}},
  set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}},
  getStr:(k,def="")=>{try{return localStorage.getItem(k)||def;}catch{return def;}},
  setStr:(k,v)=>{try{localStorage.setItem(k,v);}catch{}}
};

// ============================================================
// APP STATE
// ============================================================
let STATE = {
  page:"dashboard",
  logged:false,
  user:null,
  riskProfile:"SEGURO",
  pipelineMode:"daily",
  brief:null,
  generating:false,
  progress:[],
  agentOutputs:{},
  snapshot:null,
  portfolio:Store.get("cio_portfolio",{"Renda Fixa":40,"A√ß√µes":25,"FIIs":20,"C√¢mbio":10,"Cripto":5}),
  logs:[],
  config:Store.get("cio_config",{dataServiceUrl:"",defaultAssets:"BTCUSDT,USDBRL,IBOV",horizon:"medio"}),
  supabaseCfg:Store.get("cio_sb",{url:"",anonKey:"",enabled:false}),
  aiCfg:Store.get("cio_ai_cfg",{provider:"anthropic",model:"claude-sonnet-4-20250514"}),
  dbStatus:null,
  sbClient:null,
  showKeyText:false,
  keyInput:"",
  keyTestResult:null,
  keySaved:false,
  sbTestResult:null,
  sbBriefs:[],
  sbTab:"config",
  agentTestResults:{},
  agentTesting:null,
  histSelected:null,
  eventsFilter:"Todos",
  aiCostsTab:"daily"
};

function setState(partial,skipRender=false){
  Object.assign(STATE,partial);
  if(!skipRender)render();
}

// ============================================================
// SUPABASE CLIENT
// ============================================================
function createSB(url,anonKey){
  if(!url||!anonKey)return null;
  const h={"Content-Type":"application/json","apikey":anonKey,"Authorization":`Bearer ${anonKey}`};
  const rpc=async(path,method="GET",body=null)=>{
    const res=await fetch(`${url}/rest/v1${path}`,{method,headers:{...h,"Prefer":method==="POST"?"return=representation":"return=minimal"},body:body?JSON.stringify(body):undefined});
    if(!res.ok){const e=await res.text();throw new Error(`SB ${method} ${path}: ${e}`);}
    const t=await res.text();return t?JSON.parse(t):null;
  };
  return{
    saveBrief:d=>rpc("/morning_briefs","POST",d),
    getBriefs:(n=20)=>rpc(`/morning_briefs?order=created_at.desc&limit=${n}`),
    savePortfolio:d=>rpc("/portfolio_snapshots","POST",d),
    getPortfolio:()=>rpc("/portfolio_snapshots?order=created_at.desc&limit=1"),
    saveLog:d=>rpc("/audit_logs","POST",d),
    getLogs:(n=80)=>rpc(`/audit_logs?order=created_at.desc&limit=${n}`),
    upsertConfig:async(key,value)=>{
      const ex=await rpc(`/app_config?key=eq.${key}`);
      if(ex?.length)return rpc(`/app_config?key=eq.${key}`,"PATCH",{value:JSON.stringify(value)});
      return rpc("/app_config","POST",{key,value:JSON.stringify(value)});
    },
    getConfig:k=>rpc(`/app_config?key=eq.${k}&limit=1`),
    ping:()=>rpc("/morning_briefs?limit=1")
  };
}

// ============================================================
// AI API
// ============================================================
const AI_KEY = {
  get:()=>Store.getStr("cio_ai_key",""),
  set:k=>Store.setStr("cio_ai_key",k),
  clear:()=>{try{localStorage.removeItem("cio_ai_key");}catch{}}
};

async function callAI(system,userMsg,maxTokens=1800){
  const key=AI_KEY.get();
  if(!key)throw new Error("API_KEY_MISSING");
  const cfg=STATE.aiCfg;

  if(cfg.provider==="openai"){
    const res=await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",headers:{"Content-Type":"application/json","Authorization":`Bearer ${key}`},
      body:JSON.stringify({model:cfg.model||"gpt-4o",max_tokens:maxTokens,messages:[{role:"system",content:system},{role:"user",content:userMsg}]})
    });
    if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e?.error?.message||`HTTP ${res.status}`);}
    const d=await res.json();
    const t=d.choices?.[0]?.message?.content||"";
    try{return JSON.parse(t.replace(/```json|```/g,"").trim());}catch{return{raw:t,parse_error:true};}
  }

  // Default: Anthropic
  const res=await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",
    headers:{"Content-Type":"application/json","x-api-key":key,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
    body:JSON.stringify({model:cfg.model||"claude-sonnet-4-20250514",max_tokens:maxTokens,system,messages:[{role:"user",content:userMsg}]})
  });
  if(!res.ok){
    const e=await res.json().catch(()=>({}));
    if(res.status===401)throw new Error("Chave inv√°lida ou expirada (401).");
    if(res.status===429)throw new Error("Limite de requisi√ß√µes atingido (429). Aguarde.");
    throw new Error(e?.error?.message||`HTTP ${res.status}`);
  }
  const d=await res.json();
  const t=d.content?.[0]?.text||"";
  try{return JSON.parse(t.replace(/```json|```/g,"").trim());}catch{return{raw:t,parse_error:true};}
}

function validateKey(key,provider){
  if(!key||key.length<20)return{ok:false,msg:"Chave muito curta."};
  if(provider==="anthropic"&&!key.startsWith("sk-ant-"))return{ok:false,msg:"Chaves Anthropic come√ßam com sk-ant-..."};
  if(provider==="openai"&&!key.startsWith("sk-"))return{ok:false,msg:"Chaves OpenAI come√ßam com sk-..."};
  return{ok:true,msg:"Formato v√°lido ‚úì"};
}

// ============================================================
// RISK POLICY ENGINE
// ============================================================
function applyPolicy(opps,profile){
  const cfg=RISK_PROFILES[profile];
  return(opps||[]).filter(o=>{
    if(cfg.blocked.some(b=>(o.classe||"").includes(b)))return false;
    if(cfg.max_risk==="baixo"&&["alto","medio"].includes(o.risco_nivel))return false;
    if(cfg.min_conf==="alta"&&o.confianca!=="alta")return false;
    if(cfg.min_conf==="media"&&o.confianca==="baixa")return false;
    return true;
  }).map(o=>({...o,acao:cfg.mode}));
}

// ============================================================
// LOGGING
// ============================================================
async function addLog(action,status,notes=""){
  const entry={id:Date.now(),ts:new Date().toISOString(),user:STATE.user?.username||"sys",action,status,notes};
  STATE.logs=[entry,...STATE.logs.slice(0,99)];
  if(STATE.sbClient){try{await STATE.sbClient.saveLog({username:entry.user,action,status,notes});}catch{}}
}

// ============================================================
// AGENT PROMPTS
// ============================================================
function buildPrompt(agentId,snap,profile,horizon,prev){
  const ag=AGENTS[agentId];
  const base=`Retorne SOMENTE JSON v√°lido. Sem markdown. Voc√™ √© ${agentId}.\nstyles_active: ${JSON.stringify(ag.styles)}.\nREGRAS: sem inventar dados; null se insuficiente; sa√≠da compacta (m√°x 1800 chars); sem chain-of-thought.`;

  const prompts={
    MACRO_ORACLE:{s:base+"\nFilosofia: top-down, fluxo de capital, juros, ciclos.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"MACRO_ORACLE","regime_macro":"risk-on|risk-off|transicao|incerto","thesis":["","",""],"alerts":["","",""],"by_class":{"renda_fixa":[],"acoes":[],"fiis":[],"cambio":[],"cripto":[],"alternativos":[]},"data_needed":[],"disclaimer":"Conte√∫do educacional."}`},
    BRASIL_ANALYST:{s:base+"\nFilosofia: mercado dom√©stico BR, Copom, curva, fiscal.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"BRASIL_ANALYST","thesis":["","",""],"alerts":["","",""],"by_class":{"renda_fixa":[],"acoes":[],"fiis":[],"cambio":[],"cripto":[],"alternativos":[]},"selic_outlook":"","ipca_outlook":"","disclaimer":"Conte√∫do educacional."}`},
    QUANT_SIGNAL:{s:base+"\nFilosofia: sinais estat√≠sticos, regimes de mercado.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"QUANT_SIGNAL","signals_by_class":{"renda_fixa":[{"signal":"","strength":0}],"acoes":[{"signal":"","strength":0}],"fiis":[{"signal":"","strength":0}],"cambio":[{"signal":"","strength":0}],"cripto":[{"signal":"","strength":0}]},"volatility_stress":"baixo|medio|alto","guardrails":[],"disclaimer":"Conte√∫do educacional."}`},
    EQUITY_STOCK_MASTER:{s:base+"\nFilosofia: an√°lise setorial, nunca tickers individuais.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"EQUITY_STOCK_MASTER","thesis":["","",""],"alerts":["","",""],"by_class":{"acoes":[],"fiis":[]},"setores_destaque":[],"setores_evitar":[],"disclaimer":"Conte√∫do educacional."}`},
    REAL_ASSETS_CREDIT:{s:base+"\nFilosofia: ativos reais e il√≠quidos, spread, liquidez.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"REAL_ASSETS_CREDIT","thesis":["","",""],"alerts":["","",""],"by_class":{"fiis":[],"alternativos":[]},"hidden_risks":[],"disclaimer":"Conte√∫do educacional."}`},
    RISK_SHIELD:{s:base+"\nFilosofia: encontrar o que d√° ERRADO. Em d√∫vida, rejeite.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"RISK_SHIELD","thesis":["","",""],"alerts":["","",""],"risks_top5":[{"risk":"","prob":"baixa|media|alta","impact":"baixo|medio|alto","mitigation":[""]}],"go_no_go":"go|no_go|precisa_dados","disclaimer":"Conte√∫do educacional."}`},
    DERIVATIVES_HEDGE:{s:base+"\nFilosofia: prote√ß√£o contra cauda, antifragilidade.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"DERIVATIVES_HEDGE","thesis":["","",""],"alerts":["","",""],"hedge_by_class":{"acoes":[],"cambio":[],"cripto":[],"renda_fixa":[]},"anti_ruin_rules":[],"when_not_to_trade":[],"disclaimer":"Conte√∫do educacional."}`},
    EXECUTION_DESK:{s:base+"\nFilosofia: minimizar slippage, respeitar liquidez.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"EXECUTION_DESK","thesis":["","",""],"alerts":["","",""],"execution_playbook":{"acoes":[],"cambio":[],"cripto":[],"renda_fixa":[]},"avoid_mistakes":[],"disclaimer":"Conte√∫do educacional."}`},
    LEGAL_TAX_OPTIMIZER:{s:base+"\nFilosofia: estruturar com seguran√ßa, evitar risco jur√≠dico/tribut√°rio.",u:`INPUT:${JSON.stringify({snap,profile,horizon,prev})}\nRetorne:{"agent":"LEGAL_TAX_OPTIMIZER","thesis":["","",""],"alerts":["","",""],"compliance_checklist":[],"tax_alerts":[],"observacao":"N√£o substitui contador/advogado.","disclaimer":"Conte√∫do educacional."}`},
    ORCHESTRATOR_CIO:{s:base+"\nFilosofia: s√≠ntese objetiva. Sem ticker por padr√£o. Sem promessas.",u:`BUNDLE:${JSON.stringify(prev)}\nSNAPSHOT:${JSON.stringify(snap)}\nPERFIL:${profile}|HORIZONTE:${horizon}\nRetorne:{"agent":"ORCHESTRATOR_CIO","morning_brief":{"radar_30s":"","resumo_6_bullets":["","","","","",""],"risks_top5":["","","","",""],"opportunities_top5":["","","","",""],"plan_by_class":{"renda_fixa":{"postura":"defensiva|neutra|ofensiva","actions":[],"alerts":[]},"acoes":{"postura":"","actions":[],"alerts":[]},"fiis":{"postura":"","actions":[],"alerts":[]},"cambio":{"postura":"","actions":[],"alerts":[]},"cripto":{"postura":"","actions":[],"alerts":[]},"alternativos":{"postura":"","actions":[],"alerts":[]}},"termometro":{"volatilidade":"baixo|medio|alto","liquidez":"boa|atencao|ruim","correlacao":"normal|alta|perigosa","stress_macro":"baixo|medio|alto","semaforo":"verde|amarelo|vermelho","nota":""},"checklist_do_dia":{"fazer":["","",""],"evitar":["","",""]},"opportunities_cards":[{"classe":"","tese":"","gatilho":"","invalidacao":"","riscos":["","",""],"confianca":"alta|media|baixa","risco_nivel":"baixo|medio|alto","acao":"MONITORAR|SIMULAR"}]},"disclaimer":"Conte√∫do educacional. N√£o √© recomenda√ß√£o individual."}`}
  };
  const p=prompts[agentId];
  return p?{system:p.s,user:p.u}:{system:base,user:`Agente ${agentId}: analise o snapshot e retorne JSON compacto. INPUT:${JSON.stringify({snap,profile})}`};
}

// ============================================================
// PIPELINE RUNNER
// ============================================================
async function runPipeline(){
  if(!AI_KEY.get()){setState({page:"ai_key"});return;}
  setState({generating:true,brief:null,agentOutputs:{},progress:[]});

  // Fetch snapshot
  let snap=MOCK_SNAPSHOT;
  setState({progress:[{label:"DATA SERVICE ‚Äî Buscando snapshot...",status:"running"}]});
  if(STATE.config.dataServiceUrl){
    try{
      const res=await fetch(`${STATE.config.dataServiceUrl}/snapshot?symbols=${STATE.config.defaultAssets}&include=macro,events,news`);
      if(res.ok)snap=await res.json();
    }catch(e){addLog("FETCH_SNAPSHOT","warn",e.message);}
  }
  setState({snapshot:snap,progress:[{label:"‚úì Snapshot recebido",status:"done"}]});
  await addLog("FETCH_SNAPSHOT","ok",snap.quality?.source||"mock");

  const pipeline=STATE.pipelineMode==="daily"?DAILY_PIPELINE:DEEP_PIPELINE;
  const bundle={};
  const prog=[{label:"‚úì Snapshot recebido",status:"done"}];

  for(let i=0;i<pipeline.length;i++){
    const agId=pipeline[i];
    prog.push({label:`${agId} ‚Äî analisando...`,status:"running"});
    setState({progress:[...prog]});
    await new Promise(r=>setTimeout(r,200));

    try{
      const prev=Object.fromEntries(Object.entries(bundle).map(([k,v])=>[k,{thesis:v.thesis,alerts:v.alerts}]));
      const prompt=buildPrompt(agId,snap,STATE.riskProfile,STATE.config.horizon,agId==="ORCHESTRATOR_CIO"?bundle:prev);
      const result=await callAI(prompt.system,prompt.user,1800);
      bundle[agId]=result;
      setState({agentOutputs:{...STATE.agentOutputs,[agId]:result}},true);
      await addLog(`AGENT_${agId}`,result.parse_error?"warn":"ok","");
    }catch(e){
      bundle[agId]={agent:agId,error:e.message};
      await addLog(`AGENT_${agId}`,"fail",e.message);
    }

    prog[prog.length-1]={label:`‚úì ${agId}`,status:"done"};
    setState({progress:[...prog]});
    await new Promise(r=>setTimeout(r,100));
  }

  const cio=bundle["ORCHESTRATOR_CIO"];
  let brief=null;
  if(cio?.morning_brief){
    brief=cio.morning_brief;
    if(brief.opportunities_cards)brief.opportunities_cards=applyPolicy(brief.opportunities_cards,STATE.riskProfile);
    // Save to Supabase
    if(STATE.sbClient){
      try{
        const saved=await STATE.sbClient.saveBrief({risk_profile:STATE.riskProfile,pipeline_mode:STATE.pipelineMode,brief_json:brief,snapshot_json:snap,agent_bundle:bundle,username:STATE.user?.username||"admin"});
        await addLog("BRIEF_SAVED_DB","ok",saved?.[0]?.id||"");
      }catch(e){await addLog("BRIEF_SAVED_DB","warn",e.message);}
    }
  }else{
    brief={_error:true,_raw:cio};
  }

  await addLog("GENERATE_BRIEF","ok",`mode:${STATE.pipelineMode} profile:${STATE.riskProfile} agents:${pipeline.length}`);
  setState({generating:false,brief});
}

// ============================================================
// SUPABASE INIT
// ============================================================
async function initSupabase(){
  const cfg=STATE.supabaseCfg;
  if(!cfg.enabled||!cfg.url||!cfg.anonKey){setState({sbClient:null,dbStatus:null});return;}
  const client=createSB(cfg.url,cfg.anonKey);
  setState({sbClient:client,dbStatus:"syncing"},true);
  try{
    const[cfgRow,portRow,logsRow]=await Promise.allSettled([
      client.getConfig("app_main_config"),
      client.getPortfolio(),
      client.getLogs(60)
    ]);
    if(cfgRow.status==="fulfilled"&&cfgRow.value?.[0]?.value){
      const parsed=JSON.parse(cfgRow.value[0].value);
      STATE.config={...STATE.config,...parsed};
    }
    if(portRow.status==="fulfilled"&&portRow.value?.[0]?.allocations){
      STATE.portfolio=portRow.value[0].allocations;
    }
    if(logsRow.status==="fulfilled"&&logsRow.value?.length){
      STATE.logs=logsRow.value.map(l=>({id:l.id,ts:l.created_at,user:l.username,action:l.action,status:l.status,notes:l.notes||""}));
    }
    setState({dbStatus:"ok"});
  }catch(e){setState({dbStatus:"error"});console.warn("Supabase init:",e.message);}
}

// ============================================================
// HTML HELPERS
// ============================================================
function h(tag,attrs,inner){
  const el=document.createElement(tag);
  if(attrs)Object.entries(attrs).forEach(([k,v])=>{
    if(k==="class")el.className=v;
    else if(k.startsWith("on"))el.addEventListener(k.slice(2).toLowerCase(),v);
    else if(k==="style"&&typeof v==="object")Object.assign(el.style,v);
    else if(k==="disabled"&&v)el.disabled=true;
    else if(k==="checked"&&v)el.checked=true;
    else if(k==="value"&&(tag==="input"||tag==="select"||tag==="textarea"))el.value=v;
    else if(v!==null&&v!==undefined&&v!==false)el.setAttribute(k,v);
  });
  if(typeof inner==="string")el.innerHTML=inner;
  else if(Array.isArray(inner))inner.filter(Boolean).forEach(c=>typeof c==="string"?el.appendChild(document.createTextNode(c)):c&&el.appendChild(c));
  else if(inner&&inner.nodeType)el.appendChild(inner);
  return el;
}
function div(cls, a, b) {
  // Suporta:
  // div("classe", children)
  // div("classe", attrs, children)
  let attrs = {};
  let inner = null;

  const isAttrsObject = (x) =>
    x && typeof x === "object" && !Array.isArray(x) && !x.nodeType;

  if (b === undefined) {
    inner = a;
  } else {
    attrs = isAttrsObject(a) ? a : {};
    inner = b;
  }

  return h("div", { class: cls, ...attrs }, inner);
}
function span(cls,txt){return h("span",{class:cls},txt);}
function btn(cls,txt,onclick,disabled=false){return h("button",{class:cls,onClick:onclick,disabled},txt);}

// ============================================================
// RENDER ENGINE
// ============================================================
function render(){
  const root=document.getElementById("app");
  root.innerHTML="";

  if(!STATE.logged){root.appendChild(renderLogin());return;}

  const app=div("app",[renderSidebar(),div("main",[renderPage()])]);
  root.appendChild(app);
}

// ============================================================
// LOGIN
// ============================================================
function renderLogin(){
  const wrap=div("login-wrap",[]);
  const card=div("login-card",[
    div("login-logo",[
      div("login-name","CIO DIGITAL"),
      div("login-line",""),
      div("login-sub","Family Office ¬∑ Mesa de Opera√ß√µes")
    ])
  ]);

  let uVal="",pVal="";
  const errEl=div("login-err","");
  const btnEl=btn("login-btn","Entrar",async()=>{
    btnEl.disabled=true;btnEl.textContent="Autenticando...";
    await new Promise(r=>setTimeout(r,500));
    if(uVal==="diogobrasileiro"&&pVal==="dbsa1981"){
      setState({logged:true,user:{username:uVal,role:"admin"}},true);
      await initSupabase();
      render();
    }else{errEl.textContent="Credenciais inv√°lidas.";btnEl.disabled=false;btnEl.textContent="Entrar";}
  });

  const uf=div("login-fg",[h("label",{},"Usu√°rio"),h("input",{class:"form-input",type:"text",autocomplete:"username",oninput:e=>{uVal=e.target.value;},onKeydown:e=>{if(e.key==="Enter")btnEl.click();}})]);
  const pf=div("login-fg",[h("label",{},"Senha"),h("input",{class:"form-input",type:"password",autocomplete:"current-password",oninput:e=>{pVal=e.target.value;},onKeydown:e=>{if(e.key==="Enter")btnEl.click();}})]);

  card.appendChild(uf);card.appendChild(pf);card.appendChild(btnEl);card.appendChild(errEl);
  card.appendChild(div("login-note","‚ö†Ô∏è Plataforma educacional e anal√≠tica. N√£o constitui recomenda√ß√£o individual. Todo investimento tem risco."));
  wrap.appendChild(card);return wrap;
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar(){
  const hasKey=!!AI_KEY.get();
  const dbSt=STATE.dbStatus;

  const logoSection=div("sb-logo",[
    div("sb-name","CIO DIGITAL"),
    div("sb-ver",`v${APP_VERSION} ¬∑ Mesa de Opera√ß√µes`),
    div("sb-aistat",[
      div(`ai-dot ${hasKey?"on":"off"}`,""),
      span("ai-label",hasKey?`IA Ativa ¬∑ ${STATE.aiCfg.provider==="openai"?"OpenAI":"Anthropic"}`:"IA n√£o configurada")
    ]),
    STATE.sbClient?div("sb-aistat",[
      div(`ai-dot ${dbSt==="ok"?"on":"off"}`,""),
      span("ai-label",dbSt==="ok"?"Supabase Online":dbSt==="syncing"?"Sincronizando...":"DB Offline")
    ]):null
  ]);

  const NAV=[
    {s:"Mesa",items:[{id:"dashboard",i:"‚ö°",l:"Morning Brief"},{id:"events",i:"üì°",l:"Eventos"},{id:"opportunities",i:"üéØ",l:"Oportunidades"},{id:"portfolio",i:"üìä",l:"Portf√≥lio"}]},
    {s:"An√°lise",items:[{id:"agents",i:"ü§ñ",l:"Agentes"},{id:"agent_outputs",i:"üß†",l:"Outputs IA"}]},
    {s:"Config",items:[{id:"ai_key",i:"üîë",l:"IA & API Key"},{id:"profiles",i:"üõ°Ô∏è",l:"Perfis & Regras"},{id:"data_apis",i:"üîå",l:"Dados & APIs"},{id:"supabase",i:"üóÑÔ∏è",l:"Banco de Dados"},{id:"ai_costs",i:"üí°",l:"Pipeline & Custos"}]},
    {s:"Admin",items:[{id:"logs",i:"üìã",l:"Logs & Auditoria"},{id:"settings",i:"‚öôÔ∏è",l:"Configura√ß√µes"}]}
  ];

  const navEl=div("sb-nav",NAV.map(sec=>div("nav-section",[
    div("nav-title",sec.s),
    ...sec.items.map(it=>{
      const ni=div(`nav-item${STATE.page===it.id?" active":""}`,`<span class="nav-icon">${it.i}</span>${it.l}`);
      ni.addEventListener("click",()=>setState({page:it.id}));
      return ni;
    })
  ])));

  const bottomEl=div("sb-bottom",[
    !hasKey?h("div",{class:"no-key-badge",onClick:()=>setState({page:"ai_key"})},[
      div("nkb-text","üîë API KEY NECESS√ÅRIA"),
      div("nkb-sub","Clique para configurar")
    ]):div("key-ok-badge",[
      div("ai-dot on",""),
      span("ai-label","IA Conectada")
    ]),
    div("user-area",[
      div("user-av",(STATE.user?.username||"A")[0].toUpperCase()),
      div("",[div("user-name",STATE.user?.username||""),div("user-role",(STATE.user?.role||"").toUpperCase())])
    ]),
    btn("btn-logout","Sair",()=>{setState({logged:false,user:null,brief:null,snapshot:null,sbClient:null,dbStatus:null,page:"dashboard"});})
  ]);

  return div("sidebar",[logoSection,navEl,bottomEl]);
}

// ============================================================
// PAGE ROUTER
// ============================================================
function renderPage(){
  const pages={
    dashboard:renderDashboard,
    events:renderEvents,
    opportunities:renderOpportunities,
    portfolio:renderPortfolio,
    agents:renderAgents,
    agent_outputs:renderAgentOutputs,
    ai_key:renderAIKey,
    profiles:renderProfiles,
    data_apis:renderDataAPIs,
    supabase:renderSupabase,
    ai_costs:renderAICosts,
    logs:renderLogs,
    settings:renderSettings
  };
  const fn=pages[STATE.page]||renderDashboard;
  return fn();
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(){
  const hasKey=!!AI_KEY.get();
  const wrap=div("",[]);

  // Header
  const today=new Date().toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"});
  const hdr=div("page-header",[
    div("",[div("page-title","MORNING BRIEF"),div("page-sub",`${today} ¬∑ Modo: ${STATE.pipelineMode==="daily"?"Di√°rio (4 agentes)":"Deep Dive (10 agentes)")`)]),
    div("",{style:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:"8px"}},[
      div("profile-row",Object.entries(RISK_PROFILES).map(([k,v])=>{
        const b=btn(`profile-btn ${k[0]}${STATE.riskProfile===k?" active":""}`,v.label,()=>setState({riskProfile:k}));
        return b;
      })),
      div("pipe-toggle",[
        h("button",{class:`pipe-btn${STATE.pipelineMode==="daily"?" active":""}`,onClick:()=>setState({pipelineMode:"daily"})},"‚ö° Di√°rio"),
        h("button",{class:`pipe-btn${STATE.pipelineMode==="deep"?" active":""}`,onClick:()=>setState({pipelineMode:"deep"})},"üî¨ Deep Dive")
      ]),
      div("",{style:{display:"flex",gap:"8px"}},[
        STATE.brief&&!STATE.brief._error?btn("btn-secondary","‚¨á Exportar JSON",()=>{
          const blob=new Blob([JSON.stringify({brief:STATE.brief,snapshot:STATE.snapshot,ts:new Date().toISOString()},null,2)],{type:"application/json"});
          const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`morning-brief-${new Date().toISOString().slice(0,10)}.json`;a.click();
        }):null,
        btn(`btn-primary${STATE.generating?" disabled":""}`,STATE.generating?"‚öôÔ∏è Processando...":"‚ö° Gerar Morning Brief",STATE.generating?()=>{}:runPipeline,STATE.generating)
      ])
    ])
  ]);
  wrap.appendChild(hdr);

  if(!hasKey){
    const b=div("banner err",["üîë API Key n√£o configurada. ",h("strong",{},"V√° em IA & API Key"),` para conectar o c√©rebro do sistema.`]);
    b.style.cursor="pointer";b.addEventListener("click",()=>setState({page:"ai_key"}));
    wrap.appendChild(b);
  }
  if(!STATE.config.dataServiceUrl)wrap.appendChild(div("banner warn","‚ö†Ô∏è Data Service n√£o configurado ‚Äî usando dados de demonstra√ß√£o."));

  // Snapshot bar
  if(STATE.snapshot)wrap.appendChild(renderSnapshotBar(STATE.snapshot));

  // Generating
  if(STATE.generating){
    const sp=div("spinner-wrap",[
      div("spinner",""),
      h("p",{style:{color:"var(--tx2)",fontSize:"12px",marginBottom:"12px"}},`Pipeline ${STATE.pipelineMode==="daily"?"di√°rio":"deep dive"} em execu√ß√£o...`),
      div("",STATE.progress.map(p=>div(`progress-item ${p.status}`,`${p.status==="done"?"‚úì":p.status==="running"?"‚óâ":"‚óã"} ${p.label}`)))
    ]);
    wrap.appendChild(sp);
    return wrap;
  }

  // No brief
  if(!STATE.brief){
    wrap.appendChild(div("empty-state",[div("empty-icon","‚ö°"),div("empty-title","Nenhum brief gerado"),div("empty-sub","Selecione perfil e modo, depois clique em Gerar Morning Brief.")]));
    wrap.appendChild(renderDisclaimer());
    return wrap;
  }

  if(STATE.brief._error){
    wrap.appendChild(div("banner err","Erro ao parsear resposta do CIO. Verifique Outputs IA."));
    wrap.appendChild(renderDisclaimer());
    return wrap;
  }

  const mb=STATE.brief;
  const grid=div("grid-2",[]);

  // Block 1: Radar
  const b1=div("card col-full",{style:{"--card-color":"#00c8f0"}},[
    div("card-header",[span("card-badge","01"),span("card-title","RADAR 30S")]),
    h("p",{style:{fontSize:"15px",lineHeight:"1.7",fontWeight:"300"}},mb.radar_30s||"‚Äî")
  ]);
  grid.appendChild(b1);

  // Block 3: Termometro
  const t=mb.termometro||{};
  const semCls={verde:"sema-verde",amarelo:"sema-amarelo",vermelho:"sema-vermelho"};
  const thermCard=div("card",{style:{"--card-color":"#e8a820"}},[
    div("card-header",[span("card-badge","03"),span("card-title","TERM√îMETRO DE RISCO")]),
    div("sema",[
      ...["verde","amarelo","vermelho"].map(c=>div(`sema-dot ${semCls[c]}${t.semaforo===c?" on":""}`,""))
      ,h("span",{class:"sema-label",style:{color:t.semaforo==="verde"?"var(--gr)":t.semaforo==="vermelho"?"var(--rd)":"var(--am)"}},t.semaforo?.toUpperCase()||"‚Äî")
    ]),
    div("thermo-grid",[
      ...([["Volatilidade",t.volatilidade],["Liquidez",t.liquidez],["Correla√ß√£o",t.correlacao],["Stress Macro",t.stress_macro]]).map(([l,v])=>{
        const c={baixo:"var(--gr)",boa:"var(--gr)",normal:"var(--gr)",medio:"var(--am)",atencao:"var(--am)",alta:"var(--am)",alto:"var(--rd)",ruim:"var(--rd)",perigosa:"var(--rd)"}[v]||"var(--am)";
        return div("thermo-item",[div("thermo-lbl",l),h("div",{class:"thermo-val",style:{color:c}},(v||"‚Äî").toUpperCase())]);
      })
    ]),
    t.nota?h("p",{style:{fontSize:"10px",color:"var(--tx2)",marginTop:"8px"}},t.nota):null
  ]);
  grid.appendChild(thermCard);

  // Block 2: Bullets
  const bullets=mb.resumo_6_bullets||[];
  const b2=div("card col-full",{style:{"--card-color":"#7c4dcc"}},[
    div("card-header",[span("card-badge","02"),span("card-title",`RESUMO ‚Äî ${bullets.length} PONTOS-CHAVE`)]),
    ...bullets.map((b,i)=>div("",{style:{display:"flex",gap:"10px",padding:"6px 0",borderBottom:i<bullets.length-1?"1px solid rgba(255,255,255,.04)":"none"}},[
      h("span",{style:{color:"var(--ac)",fontFamily:"'JetBrains Mono',monospace",fontSize:"10px",flexShrink:"0"}},String(i+1).padStart(2,"0")),
      h("span",{style:{fontSize:"12px",color:"var(--tx2)",lineHeight:"1.5"}},b)
    ]))
  ]);
  grid.appendChild(b2);

  // Block 4: Opportunities
  const opps=mb.opportunities_cards||[];
  const b4=div("card col-full",{style:{"--card-color":"#2ea84a"}},[
    div("card-header",[span("card-badge","04"),span("card-title",`OPORTUNIDADES ¬∑ ${RISK_PROFILES[STATE.riskProfile]?.label}`)]),
    opps.length===0?h("p",{style:{fontSize:"11px",color:"var(--tx3)"}},"Nenhuma oportunidade aprovada para o perfil atual. Foco em monitoramento."):
    div("",opps.map(renderOppCard))
  ]);
  grid.appendChild(b4);

  // Block 5: Risks
  const risks=mb.risks_top5||[];
  const b5=div("card",{style:{"--card-color":"#e84040"}},[
    div("card-header",[span("card-badge","05"),span("card-title","RISCOS TOP 5")]),
    ...risks.map((r,i)=>div("",{style:{display:"flex",gap:"8px",padding:"5px 0",borderBottom:"1px solid rgba(255,255,255,.04)"}},[
      h("span",{style:{color:"var(--rd)",fontSize:"10px",fontFamily:"'JetBrains Mono',monospace",flexShrink:"0"}},`${i+1}.`),
      h("span",{style:{fontSize:"11px",color:"var(--tx2)"}},r)
    ]))
  ]);
  grid.appendChild(b5);

  // Block 6: Checklist
  const cl=mb.checklist_do_dia||{};
  const b6=div("card",{style:{"--card-color":"#22c55e"}},[
    div("card-header",[span("card-badge","06"),span("card-title","CHECKLIST DO DIA")]),
    div("check-grid",[
      div("",[div("check-section-title",`<span style="color:var(--gr)">‚úì</span> FAZER`),(cl.fazer||[]).map(item=>div("check-item",[h("span",{style:{color:"var(--gr)",flexShrink:"0"}},"‚Ä∫"),document.createTextNode(" "+item)]))]),
      div("",[div("check-section-title",`<span style="color:var(--rd)">‚úó</span> EVITAR`),(cl.evitar||[]).map(item=>div("check-item",[h("span",{style:{color:"var(--rd)",flexShrink:"0"}},"‚Ä∫"),document.createTextNode(" "+item)]))])
    ])
  ]);
  grid.appendChild(b6);

  // Block 7: Plan by class
  const plan=mb.plan_by_class||{};
  if(Object.keys(plan).length){
    const b7=div("card col-full",{style:{"--card-color":"#00bcd4"}},[
      div("card-header",[span("card-badge","07"),span("card-title","PLANO POR CLASSE")]),
      div("plan-grid",Object.entries(plan).map(([cls,data])=>{
        const postureClass=data.postura==="ofensiva"?"plan-ofe":data.postura==="defensiva"?"plan-def":"plan-neu";
        return div("plan-card",[
          h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}},[
            span("plan-cls",cls.replace(/_/g," ")),
            h("span",{class:`plan-posture ${postureClass}`},(data.postura||"").toUpperCase())
          ]),
          ...(data.actions||[]).map(a=>h("div",{style:{fontSize:"10px",color:"var(--tx2)",padding:"1px 0"}},`‚Ä∫ ${a}`)),
          ...(data.alerts||[]).map(a=>h("div",{style:{fontSize:"10px",color:"var(--am)",padding:"1px 0"}},`‚ö† ${a}`))
        ]);
      }))
    ]);
    grid.appendChild(b7);
  }

  wrap.appendChild(grid);
  wrap.appendChild(renderDisclaimer());
  return wrap;
}

function renderSnapshotBar(snap){
  const items=[];
  Object.entries(snap.prices||{}).forEach(([sym,d])=>{
    items.push(div("snap-item",[
      div("snap-sym",sym),
      div("snap-val",(d.last||0).toLocaleString("pt-BR")),
      d.chg24h_pct!=null?div(`snap-chg ${d.chg24h_pct>=0?"pos":"neg"}`,`${d.chg24h_pct>=0?"+":""}${d.chg24h_pct?.toFixed(2)}%`):null
    ]));
  });
  Object.entries(snap.macro_br||{}).forEach(([k,v])=>{
    if(v!=null)items.push(div("snap-item",[div("snap-sym",k.toUpperCase().replace(/_/g," ")),div("snap-val",typeof v==="number"?v.toLocaleString("pt-BR"):String(v))]));
  });
  return div("snap-bar",[
    div("snap-header",[span("snap-label","SNAPSHOT DE MERCADO"),h("span",{class:`tag`,style:{color:snap.quality?.partial?"var(--am)":"var(--gr)"}},snap.quality?.partial?"‚ö† PARCIAL":"‚úì OK")]),
    div("snap-grid",items)
  ]);
}

function renderOppCard(o){
  const confCls=o.confianca==="alta"?"conf-high":o.confianca==="media"?"conf-med":"conf-low";
  const actCls=(o.acao||"MONITORAR")==="SIMULAR"?"act-simul":"act-monitor";
  return div("opp-card",[
    div("opp-top",[span("opp-class",o.classe||o.class||""),h("span",{class:`opp-action ${actCls}`},o.acao||"MONITORAR")]),
    div("opp-thesis",o.tese||o.thesis||""),
    o.gatilho?div("opp-detail",[h("strong",{},"GATILHO"),document.createTextNode(o.gatilho)]):null,
    o.invalidacao?div("opp-detail",[h("strong",{},"INVALIDA√á√ÉO"),document.createTextNode(o.invalidacao)]):null,
    (o.riscos||[]).length?div("opp-risks",(o.riscos||[]).map(r=>span("risk-tag",r))):null,
    h("span",{class:`conf-badge ${confCls}`},(o.confianca||"").toUpperCase()+" CONFIAN√áA")
  ]);
}

function renderDisclaimer(){
  return div("disclaimer",["<span>‚ö†Ô∏è</span><span><strong>Conte√∫do educacional.</strong> N√£o constitui recomenda√ß√£o individual de compra/venda. Todo investimento tem risco. Decis√µes s√£o de responsabilidade do investidor.</span>"]);
}

// ============================================================
// EVENTS
// ============================================================
function renderEvents(){
  const snap=STATE.snapshot||MOCK_SNAPSHOT;
  const cats=["Todos","Macro Global","Brasil","Cripto","Geopol√≠tica","Corporativo"];
  const wrap=div("",[div("page-header",[div("",[div("page-title","EVENTOS DO DIA"),div("page-sub","Calend√°rio e not√≠cias do snapshot atual")])])]);
  const fb=div("filter-bar",cats.map(c=>{
    const b=btn(`filter-btn${STATE.eventsFilter===c?" active":""}`,c,()=>setState({eventsFilter:c}));return b;
  }));
  wrap.appendChild(fb);

  const events=div("",[h("p",{style:{fontSize:"9px",color:"var(--tx3)",letterSpacing:"2px",textTransform:"uppercase",fontWeight:"700",marginBottom:"10px"}},"EVENTOS"),...(snap.events||[]).map(ev=>{
    const ic=ev.impact==="high"?"background:rgba(232,64,64,.15);color:var(--rd)":ev.impact==="med"?"background:rgba(200,136,32,.15);color:var(--am)":"background:rgba(46,168,74,.15);color:var(--gr)";
    return div("card",{style:{"--card-color":"var(--bd2)"}},[
      div("",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}},[
        h("p",{style:{fontSize:"13px",fontWeight:"500",lineHeight:"1.4",marginBottom:"7px"}},ev.title),
        h("span",{style:{padding:"2px 6px",borderRadius:"3px",fontSize:"8px",fontWeight:"700",letterSpacing:"1px",flexShrink:"0",marginLeft:"8px",marginTop:"2px",cssText:ic}},ev.impact?.toUpperCase())
      ]),
      div("",{style:{display:"flex",justifyContent:"space-between"}},[h("span",{style:{fontSize:"9px",color:"var(--tx3)"}},`üìÖ ${ev.when}`)])
    ]);
  })]);
  wrap.appendChild(events);

  const news=div("",[h("p",{style:{fontSize:"9px",color:"var(--tx3)",letterSpacing:"2px",textTransform:"uppercase",fontWeight:"700",marginBottom:"10px",marginTop:"10px"}},"NOT√çCIAS"),...(snap.news||[]).map(n=>div("card",{style:{"--card-color":"var(--bd2)"}},[
    h("p",{style:{fontSize:"12px",fontWeight:"500",lineHeight:"1.4",marginBottom:"7px"}},n.title),
    div("",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},[
      h("span",{style:{fontSize:"9px",color:"var(--tx3)"}},`üìå ${n.source} ¬∑ ${n.time}`),
      div("",(n.tags||[]).map(t=>h("span",{style:{padding:"1px 5px",background:"var(--bg4)",border:"1px solid var(--bd2)",borderRadius:"3px",fontSize:"9px",color:"var(--tx3)",marginLeft:"3px"}},t)))
    ])
  ]))]);
  wrap.appendChild(news);
  return wrap;
}

// ============================================================
// OPPORTUNITIES
// ============================================================
function renderOpportunities(){
  const opps=STATE.brief?.opportunities_cards||[];
  const wrap=div("",[div("page-header",[div("",[div("page-title","OPORTUNIDADES"),div("page-sub",`Aprovadas pelo Risk Policy Engine ¬∑ Perfil: ${RISK_PROFILES[STATE.riskProfile]?.label}`)])])]);
  if(!opps.length)wrap.appendChild(div("empty-state",[div("empty-icon","üéØ"),div("empty-title","Nenhuma oportunidade aprovada"),div("empty-sub","Gere um Morning Brief ou aguarde candidatos qualificados para o perfil atual.")]));
  else opps.forEach(o=>wrap.appendChild(renderOppCard(o)));
  wrap.appendChild(renderDisclaimer());
  return wrap;
}

// ============================================================
// PORTFOLIO
// ============================================================
function renderPortfolio(){
  const total=Object.values(STATE.portfolio).reduce((a,b)=>a+b,0);
  const wrap=div("",[div("page-header",[div("",[div("page-title","PORTF√ìLIO"),div("page-sub",`Aloca√ß√£o por classe ¬∑ Soma: ${total}%`)])])]);

  const sliders=div("card",[
    h("p",{style:{fontSize:"11px",color:"var(--tx2)",marginBottom:"14px"}},"Ajuste a aloca√ß√£o por classe (%):"),
    ...Object.keys(STATE.portfolio).map(cls=>{
      const row=div("slider-row",[
        h("label",{style:{fontSize:"11px",color:"var(--tx2)",width:"130px",flexShrink:"0"}},cls),
        h("input",{type:"range",min:"0",max:"100",value:String(STATE.portfolio[cls]),style:{flex:"1",accentColor:"var(--ac)"},oninput:async(e)=>{
          const p={...STATE.portfolio,[cls]:+e.target.value};
          setState({portfolio:p},true);
          valEl.textContent=e.target.value+"%";
          Store.set("cio_portfolio",p);
          // Debounced portfolio save to Supabase
          if(STATE.sbClient){
            clearTimeout(window._ptimer);
            window._ptimer=setTimeout(async()=>{try{await STATE.sbClient.savePortfolio({allocations:p,username:STATE.user?.username||"admin"});}catch{}},2000);
          }
        }}),
      ]);
      const valEl=h("span",{class:"slider-val"},STATE.portfolio[cls]+"%");
      row.appendChild(valEl);
      return row;
    }),
    total!==100?h("p",{style:{fontSize:"10px",color:"var(--am)",marginTop:"6px"}},`‚ö†Ô∏è Soma atual: ${total}% (recomendado: 100%)`):null
  ]);
  wrap.appendChild(sliders);

  wrap.appendChild(div("alloc-grid",Object.entries(STATE.portfolio).map(([cls,v])=>div("alloc-card",[
    div("alloc-cls",cls),div("alloc-pct",`${v}%`),div("alloc-bar",[h("div",{class:"alloc-fill",style:{width:`${v}%`}},"")])
  ]))));

  return wrap;
}

// ============================================================
// AGENTS
// ============================================================
function renderAgents(){
  const wrap=div("",[div("page-header",[div("",[div("page-title","AGENTES"),div("page-sub",`${Object.keys(AGENTS).length} especialistas ativos`)])])]);
  const grid=div("agent-grid",Object.values(AGENTS).map(ag=>{
    const card=div("agent-card online",[
      div("agent-name",ag.id),div("agent-ver","v2.0"),div("agent-desc",ag.desc),
      div("agent-styles",ag.styles.map(s=>span("agent-style",s))),
      div("agent-pipes",[
        ag.pipeline.includes("daily")?span("pipe-tag pipe-daily","‚ö° Di√°rio"):null,
        ag.pipeline.includes("deep")?span("pipe-tag pipe-deep","üî¨ Deep Dive"):null
      ])
    ]);
    const resultEl=div("",{});
    const testBtn=btn("btn-secondary","‚ñ∂ Testar Agente",async()=>{
      if(!AI_KEY.get()){alert("Configure a API Key primeiro em IA & API Key.");return;}
      testBtn.disabled=true;testBtn.textContent="Testando...";
      try{
        const snap=STATE.snapshot||MOCK_SNAPSHOT;
        const p=buildPrompt(ag.id,snap,STATE.riskProfile,STATE.config.horizon,{});
        const result=await callAI(p.system,p.user,600);
        resultEl.className="agent-result";
        resultEl.textContent=JSON.stringify(result,null,1).slice(0,300)+"...";
        await addLog(`TEST_${ag.id}`,"ok","");
      }catch(e){resultEl.className="agent-result";resultEl.style.color="var(--rd)";resultEl.textContent=e.message;await addLog(`TEST_${ag.id}`,"fail",e.message);}
      testBtn.disabled=false;testBtn.textContent="‚ñ∂ Testar Agente";
    });
    card.appendChild(resultEl);card.appendChild(testBtn);
    return card;
  }));
  wrap.appendChild(grid);
  return wrap;
}

// ============================================================
// AGENT OUTPUTS
// ============================================================
function renderAgentOutputs(){
  const wrap=div("",[div("page-header",[div("",[div("page-title","OUTPUTS IA"),div("page-sub","Resultado bruto de cada agente do √∫ltimo pipeline")])])]);
  const outputs=STATE.agentOutputs;
  if(!Object.keys(outputs).length){wrap.appendChild(div("empty-state",[div("empty-icon","üß†"),div("empty-title","Sem outputs"),div("empty-sub","Gere um Morning Brief para ver os outputs de cada agente.")]));return wrap;}

  const pipeline=STATE.pipelineMode==="daily"?DAILY_PIPELINE:DEEP_PIPELINE;
  const grid=div("",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:"12px"}});
  pipeline.filter(id=>outputs[id]).forEach(id=>{
    const out=outputs[id];
    let expanded=false;
    const detailEl=div("",{});
    const card=div("",{style:{background:"var(--bg2)",border:"1px solid var(--bd)",borderRadius:"9px",padding:"14px",cursor:"pointer"}},[
      div("",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}},[
        h("span",{style:{fontFamily:"'JetBrains Mono',monospace",fontSize:"11px",color:"var(--ac)",fontWeight:"600"}},id),
        h("span",{style:{fontSize:"9px",color:out.parse_error?"var(--rd)":"var(--gr)",fontWeight:"700"}},out.parse_error?"‚ö† PARSE ERR":"‚úì OK")
      ]),
      (out.thesis||[]).slice(0,2).map(t=>h("div",{style:{fontSize:"10px",color:"var(--tx2)",lineHeight:"1.5",padding:"1px 0"}},`‚Ä∫ ${t}`)),
      detailEl
    ]);
    card.addEventListener("click",()=>{
      expanded=!expanded;
      detailEl.innerHTML="";
      if(expanded){
        const pre=h("pre",{style:{background:"var(--bg)",border:"1px solid var(--bd)",borderRadius:"6px",padding:"8px",fontSize:"9px",color:"var(--tx2)",lineHeight:"1.6",overflow:"auto",maxHeight:"200px",marginTop:"10px",whiteSpace:"pre-wrap"}},JSON.stringify(out,null,2));
        detailEl.appendChild(pre);
      }
    });
    grid.appendChild(card);
  });
  wrap.appendChild(grid);
  return wrap;
}

// ============================================================
// AI KEY PAGE
// ============================================================
function renderAIKey(){
  const hasKey=!!AI_KEY.get();
  const existingKey=AI_KEY.get();
  const masked=existingKey?existingKey.slice(0,10)+"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"+existingKey.slice(-4):"";
  const wrap=div("",[]);

  const hdr=div("page-header",[
    div("",[div("page-title","IA & API KEY"),div("page-sub","Configure o c√©rebro de IA que alimenta todos os 10 agentes")]),
    hasKey?div("",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 14px",background:"rgba(46,168,74,.1)",border:"1px solid rgba(46,168,74,.25)",borderRadius:"8px"}},[div("ai-dot on",""),h("span",{style:{fontSize:"11px",color:"var(--gr)",fontWeight:"600"}},`IA Ativa ¬∑ ${STATE.aiCfg.provider==="openai"?"OpenAI":"Anthropic"}`)]):null
  ]);
  wrap.appendChild(hdr);

  wrap.appendChild(div("key-hero",[
    div("key-hero-icon","üîë"),
    div("key-hero-title","Conecte seu C√©rebro de IA"),
    div("key-hero-sub","A API key √© usada para todos os agentes da mesa: macro, risco, hedge, execu√ß√£o, quant e s√≠ntese. Sua chave fica salva apenas no seu browser ‚Äî nunca enviada a terceiros.")
  ]));

  // Provider selector
  const provCard=div("card",[
    h("p",{class:"card-title",style:{marginBottom:"14px"}},"1 ‚Äî ESCOLHA O PROVEDOR"),
    div("provider-grid",[
      ...["anthropic","openai"].map(pid=>{
        const info={
          anthropic:{name:"Anthropic Claude",icon:"üß†",desc:"Claude Sonnet / Opus / Haiku. Melhor para an√°lise financeira complexa.",link:"https://console.anthropic.com/",models:[{id:"claude-sonnet-4-20250514",label:"Claude Sonnet 4 (recomendado)"},{id:"claude-opus-4-5",label:"Claude Opus 4.5 (m√°xima qualidade)"},{id:"claude-haiku-4-5-20251001",label:"Claude Haiku 4.5 (econ√¥mico)"}]},
          openai:{name:"OpenAI GPT",icon:"‚ö°",desc:"GPT-4o e GPT-4o-mini. Alternativa robusta.",link:"https://platform.openai.com/api-keys",models:[{id:"gpt-4o",label:"GPT-4o (recomendado)"},{id:"gpt-4o-mini",label:"GPT-4o mini (econ√¥mico)"},{id:"gpt-4-turbo",label:"GPT-4 Turbo"}]}
        }[pid];
        const pc=div(`prov-card${STATE.aiCfg.provider===pid?" selected":""}`,{style:{cursor:"pointer"}},[
          div("prov-logo",info.icon),div("prov-name",info.name),div("prov-desc",info.desc),
          h("a",{class:"ks-link",href:info.link,target:"_blank",rel:"noopener"},"‚Üí Obter chave aqui")
        ]);
        pc.addEventListener("click",()=>{
          const newCfg={...STATE.aiCfg,provider:pid,model:info.models[0].id};
          setState({aiCfg:newCfg},true);Store.set("cio_ai_cfg",newCfg);render();
        });
        return pc;
      })
    ]),
    div("form-group",[
      div("form-label","MODELO"),
      h("select",{class:"form-select",value:STATE.aiCfg.model,onChange:e=>{
        const newCfg={...STATE.aiCfg,model:e.target.value};setState({aiCfg:newCfg},true);Store.set("cio_ai_cfg",newCfg);
      }},({anthropic:[{id:"claude-sonnet-4-20250514",label:"Claude Sonnet 4 (recomendado)"},{id:"claude-opus-4-5",label:"Claude Opus 4.5 (m√°xima qualidade)"},{id:"claude-haiku-4-5-20251001",label:"Claude Haiku 4.5 (econ√¥mico)"}],openai:[{id:"gpt-4o",label:"GPT-4o (recomendado)"},{id:"gpt-4o-mini",label:"GPT-4o mini (econ√¥mico)"},{id:"gpt-4-turbo",label:"GPT-4 Turbo"}]}[STATE.aiCfg.provider]||[]).map(m=>`<option value="${m.id}">${m.label}</option>`).join(""))
    ])
  ]);
  wrap.appendChild(provCard);

  // Steps
  wrap.appendChild(div("card",[
    h("p",{class:"card-title",style:{marginBottom:"14px"}},"2 ‚Äî COMO OBTER SUA CHAVE"),
    div("key-steps",[
      ...[["01","Acesse o console","Crie conta no provedor escolhido.",null],["02","Crie uma API Key","V√° em API Keys ‚Üí Create new secret key. Copie imediatamente.",null],["03","Cole abaixo","A chave come√ßa com sk-ant-... (Anthropic) ou sk-... (OpenAI).",null],["04","Teste e salve","Clique em Testar para validar antes de salvar.",null]].map(([n,t,d,_])=>div("key-step",[div("ks-num",n),div("ks-title",t),div("ks-desc",d)]))
    ])
  ]));

  // Key input
  let keyVal=STATE.keyInput||"";
  let showTxt=STATE.showKeyText||false;
  const msgEl=div("banner ok",{style:{display:"none",marginTop:"12px"}},"");
  const fmtEl=div("",{style:{fontSize:"10px",marginTop:"4px"}});

  const keyInput=h("input",{type:showTxt?"text":"password",class:"form-input",placeholder:existingKey?"Deixe em branco para manter atual":`sk-ant-api‚Ä¢‚Ä¢‚Ä¢ ou sk-‚Ä¢‚Ä¢‚Ä¢`,value:keyVal,style:{paddingRight:"44px"},oninput:e=>{keyVal=e.target.value;STATE.keyInput=keyVal;const fmt=keyVal?validateKey(keyVal,STATE.aiCfg.provider):null;fmtEl.style.color=fmt?.ok?"var(--gr)":"var(--rd)";fmtEl.textContent=fmt?fmt.msg:"";}});

  const eyeBtn=btn("key-eye",showTxt?"üôà":"üëÅÔ∏è",()=>{showTxt=!showTxt;STATE.showKeyText=showTxt;keyInput.type=showTxt?"text":"password";eyeBtn.textContent=showTxt?"üôà":"üëÅÔ∏è";});

  const inputWrap=div("key-input-wrap",[keyInput,eyeBtn]);

  const testBtn=btn("btn-primary","‚ñ∂ Testar Conex√£o",async()=>{
    const key=keyVal||existingKey;if(!key){msgEl.className="banner err";msgEl.style.display="flex";msgEl.innerHTML="Cole uma chave antes de testar.";return;}
    testBtn.disabled=true;testBtn.textContent="‚öôÔ∏è Testando...";
    const prev=AI_KEY.get();AI_KEY.set(key);
    try{
      await callAI("Retorne SOMENTE JSON v√°lido.","Responda: {\"ok\":true}",50);
      msgEl.className="banner ok";msgEl.innerHTML=`‚úì Conex√£o bem-sucedida com ${STATE.aiCfg.provider==="openai"?"OpenAI":"Anthropic"}!`;
    }catch(e){
      AI_KEY.set(prev);msgEl.className="banner err";msgEl.innerHTML=`‚úó Erro: ${e.message}`;
    }
    msgEl.style.display="flex";testBtn.disabled=false;testBtn.textContent="‚ñ∂ Testar Conex√£o";
  });

  let savedLabel=false;
  const saveBtn=btn("btn-primary green","üíæ Salvar Chave",()=>{
    const key=keyVal||existingKey;if(!key){msgEl.className="banner err";msgEl.innerHTML="Nenhuma chave para salvar.";msgEl.style.display="flex";return;}
    AI_KEY.set(key);STATE.keyInput="";
    setState({aiCfg:{...STATE.aiCfg,hasKey:true}},true);
    msgEl.className="banner ok";msgEl.innerHTML=`‚úì Chave salva! Sistema usando ${STATE.aiCfg.provider==="openai"?"OpenAI":"Anthropic"} ¬∑ ${STATE.aiCfg.model}`;msgEl.style.display="flex";
    render(); // Re-render sidebar indicator
  });
  const clearBtn=btn("btn-secondary","üóë Remover Chave",()=>{AI_KEY.clear();STATE.keyInput="";msgEl.className="banner warn";msgEl.innerHTML="Chave removida.";msgEl.style.display="flex";render();});

  const inputCard=div("card",[
    h("p",{class:"card-title",style:{marginBottom:"14px"}},"3 ‚Äî COLE SUA CHAVE"),
    existingKey&&!keyVal?div("banner ok",{style:{marginBottom:"14px"}},[`‚úì Chave ativa: `,h("code",{style:{fontFamily:"monospace",fontSize:"10px"}},masked)]):null,
    div("form-group",[div("form-label","API KEY"),inputWrap,fmtEl]),
    div("",{style:{display:"flex",gap:"10px",flexWrap:"wrap",marginBottom:"0"}},[testBtn,saveBtn,existingKey?clearBtn:null]),
    msgEl
  ]);
  wrap.appendChild(inputCard);

  // Security
  wrap.appendChild(div("card",[
    h("p",{class:"card-title",style:{marginBottom:"14px"}},"SEGURAN√áA & PRIVACIDADE"),
    div("",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px"}},
      [["üîí Armazenamento local","Chave salva no localStorage do seu browser. Nunca enviada a servidores do CIO DIGITAL."],
       ["üöÄ Uso direto","Chamadas v√£o direto do seu browser para a API do provedor. Nenhum intermedi√°rio."],
       ["üõ°Ô∏è Boas pr√°ticas","Use uma chave dedicada para este app e configure limites de gasto no console do provedor."],
       ["üí∞ Custo estimado","Pipeline di√°rio: ~4 chamadas por gera√ß√£o. Deep Dive: ~10 chamadas. Tokens por chamada: ‚â§1800."]
      ].map(([t,d])=>div("card-inner",[h("p",{style:{fontSize:"12px",fontWeight:"600",color:"var(--tx)",marginBottom:"4px"}},t),h("p",{style:{fontSize:"10px",color:"var(--tx3)",lineHeight:"1.6"}},d)]))
    )
  ]));

  return wrap;
}

// ============================================================
// PROFILES PAGE
// ============================================================
function renderProfiles(){
  const wrap=div("",[div("page-header",[div("",[div("page-title","PERFIS & REGRAS"),div("page-sub","Presets do Risk Policy Engine")])])]);
  wrap.appendChild(div("profile-cards",Object.entries(RISK_PROFILES).map(([k,cfg])=>{
    const pc=div("profile-card",{style:{background:STATE.riskProfile===k?cfg.bg:"var(--bg2)",borderColor:STATE.riskProfile===k?cfg.color:"var(--bd)"}},[
      h("p",{style:{fontFamily:"'Bebas Neue',sans-serif",fontSize:"20px",letterSpacing:"2px",color:cfg.color,marginBottom:"6px"}},cfg.label),
      h("p",{style:{fontSize:"11px",color:"var(--tx2)",marginBottom:"14px",lineHeight:"1.5"}},cfg.desc),
      h("p",{style:{fontSize:"9px",color:"var(--tx3)",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"5px"}},"Permitido"),
      div("",{style:{display:"flex",flexWrap:"wrap",gap:"3px",marginBottom:"10px"}},cfg.allowed.map(c=>h("span",{style:{padding:"1px 6px",borderRadius:"3px",fontSize:"9px",border:`1px solid ${cfg.color}44`,color:cfg.color,background:"transparent"}},c))),
      cfg.blocked.length?[h("p",{style:{fontSize:"9px",color:"var(--tx3)",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"4px"}},"Bloqueado"),div("",{style:{display:"flex",flexWrap:"wrap",gap:"3px",marginBottom:"10px"}},cfg.blocked.map(c=>h("span",{style:{padding:"1px 6px",borderRadius:"3px",fontSize:"9px",border:"1px solid rgba(232,64,64,.3)",color:"var(--rd)"}},c)))]:null,
      h("div",{style:{padding:"8px 10px",background:"rgba(255,255,255,.03)",borderRadius:"5px",fontSize:"9px",fontFamily:"'JetBrains Mono',monospace",lineHeight:"1.9"}},[
        h("span",{style:{color:"var(--tx3)"}},"Modo: "),h("span",{style:{color:cfg.color}},cfg.mode),"  ",
        h("span",{style:{color:"var(--tx3)"}},"Risco: "),h("span",{style:{color:cfg.color}},cfg.max_risk),"  ",
        h("span",{style:{color:"var(--tx3)"}},"Confian√ßa m√≠n: "),h("span",{style:{color:cfg.color}},cfg.min_conf)
      ]),
      STATE.riskProfile===k?h("p",{style:{fontSize:"9px",color:cfg.color,fontWeight:"700",marginTop:"10px"}},"‚úì PERFIL ATIVO"):null
    ]);
    pc.addEventListener("click",()=>setState({riskProfile:k}));
    return pc;
  })));
  return wrap;
}

// ============================================================
// DATA & APIs
// ============================================================
function renderDataAPIs(){
  const wrap=div("",[div("page-header",[div("",[div("page-title","DADOS & APIS"),div("page-sub","Configura√ß√£o do Data Service e fontes de mercado")])])]);
  let cfg={...STATE.config};
  const msgEl=div("banner ok",{style:{display:"none"}},"");

  const testBtn=btn("btn-primary","‚ñ∂ Testar /health",async()=>{
    if(!cfg.dataServiceUrl){alert("Configure a URL primeiro.");return;}
    testBtn.disabled=true;testBtn.textContent="Testando...";
    try{
      const res=await fetch(`${cfg.dataServiceUrl}/health`);
      const d=await res.json();
      msgEl.className="banner ok";msgEl.innerHTML=`‚úì Online ‚Äî ${JSON.stringify(d)}`;
    }catch(e){msgEl.className="banner err";msgEl.innerHTML=`‚úó Offline ‚Äî ${e.message}`;}
    msgEl.style.display="flex";testBtn.disabled=false;testBtn.textContent="‚ñ∂ Testar /health";
  });

  const saveBtn=btn("btn-primary green","üíæ Salvar",async()=>{
    setState({config:cfg},true);Store.set("cio_config",cfg);
    if(STATE.sbClient){try{await STATE.sbClient.upsertConfig("app_main_config",cfg);}catch{}}
    msgEl.className="banner ok";msgEl.innerHTML="‚úì Configura√ß√µes salvas!";msgEl.style.display="flex";
  });

  wrap.appendChild(div("card",[
    h("p",{class:"card-title",style:{marginBottom:"14px"}},"DATA SERVICE"),
    h("p",{style:{fontSize:"10px",color:"var(--tx3)",marginBottom:"14px",lineHeight:"1.7"}},'O Data Service √© um backend pr√≥prio que exp√µe /health e /snapshot. Se n√£o configurado, usa dados de demonstra√ß√£o.'),
    div("form-group",[div("form-label","DATA_SERVICE_BASE_URL"),h("input",{class:"form-input",type:"text",value:cfg.dataServiceUrl,placeholder:"https://seu-endpoint.run.app",oninput:e=>{cfg.dataServiceUrl=e.target.value;}})]),
    div("",{style:{display:"flex",gap:"10px",marginBottom:"14px"}},[testBtn]),
    msgEl
  ]));

  wrap.appendChild(div("card",[
    h("p",{class:"card-title",style:{marginBottom:"14px"}},"PREFER√äNCIAS"),
    div("form-group",[div("form-label","Ativos padr√£o (separados por v√≠rgula)"),h("input",{class:"form-input",type:"text",value:cfg.defaultAssets,placeholder:"BTCUSDT,USDBRL,IBOV",oninput:e=>{cfg.defaultAssets=e.target.value;}})]),
    div("form-group",[div("form-label","Horizonte padr√£o"),h("select",{class:"form-select",value:cfg.horizon,onChange:e=>{cfg.horizon=e.target.value;}},`<option value="curto">Curto prazo</option><option value="medio">M√©dio prazo</option><option value="longo">Longo prazo</option>`)]),
    saveBtn
  ]));

  return wrap;
}

// ============================================================
// SUPABASE PAGE
// ============================================================
const SUPABASE_SQL=`-- CIO DIGITAL v2.1 ‚Äî Supabase Schema
CREATE TABLE IF NOT EXISTS morning_briefs (id UUID DEFAULT gen_random_uuid() PRIMARY KEY, created_at TIMESTAMPTZ DEFAULT NOW(), risk_profile TEXT, pipeline_mode TEXT, brief_json JSONB, snapshot_json JSONB, agent_bundle JSONB, username TEXT DEFAULT 'admin');
CREATE TABLE IF NOT EXISTS portfolio_snapshots (id UUID DEFAULT gen_random_uuid() PRIMARY KEY, created_at TIMESTAMPTZ DEFAULT NOW(), allocations JSONB NOT NULL, username TEXT DEFAULT 'admin');
CREATE TABLE IF NOT EXISTS app_config (id UUID DEFAULT gen_random_uuid() PRIMARY KEY, updated_at TIMESTAMPTZ DEFAULT NOW(), key TEXT UNIQUE NOT NULL, value TEXT NOT NULL);
CREATE TABLE IF NOT EXISTS audit_logs (id UUID DEFAULT gen_random_uuid() PRIMARY KEY, created_at TIMESTAMPTZ DEFAULT NOW(), username TEXT, action TEXT NOT NULL, status TEXT NOT NULL, notes TEXT);
CREATE TABLE IF NOT EXISTS market_snapshots (id UUID DEFAULT gen_random_uuid() PRIMARY KEY, created_at TIMESTAMPTZ DEFAULT NOW(), snapshot_json JSONB NOT NULL, source TEXT);
CREATE TABLE IF NOT EXISTS agent_outputs (id UUID DEFAULT gen_random_uuid() PRIMARY KEY, created_at TIMESTAMPTZ DEFAULT NOW(), brief_id UUID REFERENCES morning_briefs(id) ON DELETE CASCADE, agent_id TEXT NOT NULL, output_json JSONB NOT NULL);
CREATE INDEX IF NOT EXISTS idx_briefs_created ON morning_briefs(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_logs_created ON audit_logs(created_at DESC);`;

function renderSupabase(){
  const cfg=STATE.supabaseCfg;
  let localCfg={...cfg};
  const wrap=div("",[div("page-header",[div("",[div("page-title","BANCO DE DADOS"),div("page-sub","Supabase ¬∑ Persist√™ncia e hist√≥rico completo")])])]);

  const dbSt=STATE.dbStatus;
  const stCls=STATE.sbClient?(dbSt==="ok"?"db-ok":dbSt==="syncing"?"":"db-err"):"db-off";
  const stTxt=STATE.sbClient?(dbSt==="ok"?"‚óè Conectado ao Supabase":dbSt==="syncing"?"‚óâ Sincronizando...":"‚úó Erro de conex√£o"):"‚óã Supabase n√£o configurado";
  wrap.appendChild(div(`db-status ${stCls}`,stTxt));

  // Tabs
  const tabs=["config","schema","history"];
  const tabLabels=["‚öô Configura√ß√£o","üóÉ SQL Schema","üìÇ Hist√≥rico"];
  const tabBar=div("pipe-toggle",tabs.map((t,i)=>{
    const b=h("button",{class:`pipe-btn${STATE.sbTab===t?" active":""}`,onClick:async()=>{
      setState({sbTab:t},true);
      if(t==="history"&&STATE.sbClient){
        try{const b=await STATE.sbClient.getBriefs(20);setState({sbBriefs:b||[]});}catch{}
      }else render();
    }},tabLabels[i]);return b;
  }));
  tabBar.style.marginBottom="18px";tabBar.style.width="fit-content";
  wrap.appendChild(tabBar);

  if(STATE.sbTab==="config"){
    const msgEl=div("banner ok",{style:{display:"none"}},"");
    const testBtn=btn("btn-primary","‚ñ∂ Testar Conex√£o",async()=>{
      if(!localCfg.url||!localCfg.anonKey){msgEl.className="banner err";msgEl.innerHTML="Preencha URL e Anon Key.";msgEl.style.display="flex";return;}
      testBtn.disabled=true;testBtn.textContent="Testando...";
      try{const c=createSB(localCfg.url,localCfg.anonKey);await c.ping();msgEl.className="banner ok";msgEl.innerHTML="‚úì Conex√£o bem-sucedida!";}
      catch(e){msgEl.className="banner err";msgEl.innerHTML=`‚úó Erro: ${e.message}`;}
      msgEl.style.display="flex";testBtn.disabled=false;testBtn.textContent="‚ñ∂ Testar Conex√£o";
    });
    const saveBtn=btn("btn-primary green","üíæ Salvar e Conectar",async()=>{
      const newCfg={...localCfg,enabled:true};
      Store.set("cio_sb",newCfg);setState({supabaseCfg:newCfg},true);
      await initSupabase();
      msgEl.className="banner ok";msgEl.innerHTML="‚úì Salvo! Reconectando ao banco de dados...";msgEl.style.display="flex";
      setTimeout(render,800);
    });
    const disBtn=STATE.sbClient?btn("btn-secondary","Desabilitar",()=>{const nc={...localCfg,enabled:false};Store.set("cio_sb",nc);setState({supabaseCfg:nc,sbClient:null,dbStatus:null});render();}):null;

    wrap.appendChild(div("card",[
      h("p",{class:"card-title",style:{marginBottom:"14px"}},"CREDENCIAIS SUPABASE"),
      h("p",{style:{fontSize:"10px",color:"var(--tx3)",marginBottom:"14px",lineHeight:"1.7"}},'Encontre em: app.supabase.com ‚Üí Projeto ‚Üí Settings ‚Üí API. Use apenas a anon (public) key.'),
      div("form-group",[div("form-label","Project URL"),h("input",{class:"form-input",type:"text",value:localCfg.url||"",placeholder:"https://xxxxxxxxxxxx.supabase.co",oninput:e=>{localCfg.url=e.target.value;}})]),
      div("form-group",[div("form-label","Anon Public Key (JWT)"),h("input",{class:"form-input",type:"password",value:localCfg.anonKey||"",placeholder:"eyJhbGci...",oninput:e=>{localCfg.anonKey=e.target.value;}})]),
      div("",{style:{display:"flex",gap:"10px",flexWrap:"wrap",marginBottom:"14px"}},[testBtn,saveBtn,disBtn]),
      msgEl
    ]));

    wrap.appendChild(div("card",[
      h("p",{class:"card-title",style:{marginBottom:"12px"}},"O QUE √â SALVO AUTOMATICAMENTE"),
      ...[["üåÖ Morning Briefs","Cada brief gerado salvo com snapshot, bundle e perfil.","AUTO"],["üìä Portf√≥lio","Aloca√ß√µes salvas 2s ap√≥s cada ajuste.","AUTO"],["üìã Logs de Auditoria","Cada a√ß√£o registrada com timestamp.","AUTO"],["‚öôÔ∏è Configura√ß√µes","Data Service URL, ativos, horizonte.","AUTO"]].map(([t,d,badge])=>
        div("",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}},[
          div("",[h("p",{style:{fontSize:"12px",color:"var(--tx)",marginBottom:"2px"}},t),h("p",{style:{fontSize:"10px",color:"var(--tx3)"}},d)]),
          h("span",{style:{fontSize:"9px",color:"var(--gr)",fontWeight:"700"}},badge)
        ])
      )
    ]));
  }

  if(STATE.sbTab==="schema"){
    const copyBtn=btn("copy-btn","Copiar SQL",()=>{navigator.clipboard.writeText(SUPABASE_SQL).then(()=>{copyBtn.textContent="‚úì Copiado!";setTimeout(()=>{copyBtn.textContent="Copiar SQL";},2000);});});
    wrap.appendChild(div("card",[
      div("",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}},[h("p",{class:"card-title"},"SQL PARA CRIAR AS TABELAS"),copyBtn]),
      h("p",{style:{fontSize:"10px",color:"var(--tx3)",marginBottom:"12px",lineHeight:"1.7"}},"1. Acesse app.supabase.com ‚Üí SQL Editor ‚Üí New Query\n2. Cole o SQL abaixo\n3. Clique em Run"),
      div("sql-block",SUPABASE_SQL)
    ]));
  }

  if(STATE.sbTab==="history"){
    const briefs=STATE.sbBriefs||[];
    wrap.appendChild(div("card",[
      div("",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"14px"}},[
        h("p",{class:"card-title"},"HIST√ìRICO DE MORNING BRIEFS"),
        btn("btn-primary","‚Ü∫ Atualizar",async()=>{if(!STATE.sbClient){alert("Conecte o Supabase primeiro.");return;}try{const b=await STATE.sbClient.getBriefs(20);setState({sbBriefs:b||[]});}catch(e){alert(e.message);}})
      ]),
      !STATE.sbClient?div("banner warn","Conecte o Supabase para ver o hist√≥rico."):
      briefs.length===0?div("empty-state",[div("empty-icon","üìÇ"),div("empty-title","Sem hist√≥rico"),div("empty-sub","Gere um Morning Brief para come√ßar.")]):
      h("table",{class:"data-table"},[
        h("thead",[h("tr",[h("th",{},"Data"),h("th",{},"Perfil"),h("th",{},"Modo"),h("th",{},"Usu√°rio"),h("th",{},"JSON")])]),
        h("tbody",briefs.map(b=>{
          const tr=h("tr",{class:"hist-row"},[
            h("td",{style:{fontSize:"10px"}},new Date(b.created_at).toLocaleString("pt-BR")),
            h("td",{},[h("span",{style:{color:b.risk_profile==="CONSERVADOR"?"var(--gr)":b.risk_profile==="SEGURO"?"var(--am)":"var(--rd)",fontWeight:"700",fontSize:"10px"}},b.risk_profile)]),
            h("td",{style:{fontSize:"10px"}},b.pipeline_mode==="daily"?"‚ö° Di√°rio":"üî¨ Deep Dive"),
            h("td",{style:{fontSize:"10px"}},b.username||"admin"),
            h("td",[btn("copy-btn","üìã Copiar",e=>{e.stopPropagation();navigator.clipboard.writeText(JSON.stringify(b.brief_json,null,2));})])
          ]);
          tr.addEventListener("click",()=>{
            setState({histSelected:STATE.histSelected?.id===b.id?null:b});
          });
          return tr;
        }))
      ]),
      STATE.histSelected?div("",{style:{marginTop:"14px"}},[
        h("p",{style:{fontSize:"10px",color:"var(--ac)",fontWeight:"700",marginBottom:"8px",textTransform:"uppercase",letterSpacing:"1px"}},`Brief ‚Äî ${new Date(STATE.histSelected.created_at).toLocaleString("pt-BR")}`),
        h("pre",{style:{background:"var(--bg)",border:"1px solid var(--bd)",borderRadius:"7px",padding:"12px",fontSize:"9px",color:"var(--tx2)",lineHeight:"1.6",overflow:"auto",maxHeight:"260px",whiteSpace:"pre-wrap"}},JSON.stringify(STATE.histSelected.brief_json,null,2))
      ]):null
    ]));
  }

  return wrap;
}

// ============================================================
// AI COSTS
// ============================================================
function renderAICosts(){
  const wrap=div("",[div("page-header",[div("",[div("page-title","PIPELINE & CUSTOS"),div("page-sub","Controle do pipeline agentic e uso de tokens")])])]);

  wrap.appendChild(div("card",[
    h("p",{class:"card-title",style:{marginBottom:"12px"}},"MODO DO PIPELINE"),
    div("pipe-toggle",{style:{marginBottom:"14px"}},[
      h("button",{class:`pipe-btn${STATE.pipelineMode==="daily"?" active":""}`,onClick:()=>setState({pipelineMode:"daily"})},"‚ö° Di√°rio (4 agentes)"),
      h("button",{class:`pipe-btn${STATE.pipelineMode==="deep"?" active":""}`,onClick:()=>setState({pipelineMode:"deep"})},"üî¨ Deep Dive (10 agentes)")
    ]),
    div("",{style:{display:"flex",gap:"16px",flexWrap:"wrap"}},[
      div("",[h("p",{style:{fontSize:"9px",color:"var(--ac)",fontWeight:"700",letterSpacing:"1.5px",textTransform:"uppercase",marginBottom:"8px"}},"‚ö° PIPELINE DI√ÅRIO"),...DAILY_PIPELINE.map((id,i)=>h("div",{style:{fontSize:"11px",color:"var(--tx2)",padding:"4px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}},[h("span",{style:{color:"var(--tx3)",fontFamily:"'JetBrains Mono',monospace",fontSize:"9px"}},`${i+1}. `),id]))]),
      div("",[h("p",{style:{fontSize:"9px",color:"var(--pu)",fontWeight:"700",letterSpacing:"1.5px",textTransform:"uppercase",marginBottom:"8px"}},"üî¨ DEEP DIVE"),...DEEP_PIPELINE.map((id,i)=>h("div",{style:{fontSize:"11px",color:"var(--tx2)",padding:"4px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}},[h("span",{style:{color:"var(--tx3)",fontFamily:"'JetBrains Mono',monospace",fontSize:"9px"}},`${i+1}. `),id]))])
    ])
  ]));

  wrap.appendChild(div("card",[
    h("p",{class:"card-title",style:{marginBottom:"12px"}},"INFORMA√á√ïES DO MODELO"),
    ...[["Modelo ativo",STATE.aiCfg.model||"N√£o configurado"],["Provedor",STATE.aiCfg.provider==="openai"?"OpenAI GPT":"Anthropic Claude"],["Max tokens/chamada","1800"],["Modo econ√¥mico","JSON compacto ¬∑ sem chain-of-thought"]].map(([l,v])=>
      div("",{style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}},[
        h("span",{style:{fontSize:"11px",color:"var(--tx2)"}},l),
        h("span",{style:{fontSize:"11px",color:"var(--ac)",fontFamily:"'JetBrains Mono',monospace"}},v)
      ])
    )
  ]));

  wrap.appendChild(div("card",[
    h("p",{class:"card-title",style:{marginBottom:"10px"}},"FILOSOFIA DO PIPELINE"),
    div("",{style:{padding:"12px 16px",background:"rgba(0,200,240,.06)",border:"1px solid rgba(0,200,240,.15)",borderRadius:"8px",fontSize:"11px",color:"var(--tx2)",lineHeight:"1.8"}},[
      h("strong",{},"Por que agentes sequenciais?")," Colocar m√∫ltiplas personas em um √∫nico prompt causa dilui√ß√£o de aten√ß√£o ‚Äî o modelo tenta equilibrar perspectivas conflitantes em vez de aprofundar cada an√°lise.",h("br",{}),"",
      h("strong",{},"Solu√ß√£o:"), " Cada agente recebe contexto compacto + resumos anteriores, foca em sua especialidade e passa o output adiante. Resultado: an√°lise mais profunda com menos tokens."
    ])
  ]));

  return wrap;
}

// ============================================================
// LOGS
// ============================================================
function renderLogs(){
  const wrap=div("",[div("page-header",[div("",[div("page-title","LOGS & AUDITORIA"),div("page-sub",`${STATE.logs.length} registros nesta sess√£o`)])])]);
  wrap.appendChild(div("card",[
    h("table",{class:"data-table"},[
      h("thead",[h("tr",[h("th",{},"HOR√ÅRIO"),h("th",{},"USU√ÅRIO"),h("th",{},"A√á√ÉO"),h("th",{},"STATUS"),h("th",{},"NOTAS")])]),
      h("tbody",STATE.logs.length===0?[h("tr",[h("td",{colspan:"5",style:{textAlign:"center",padding:"28px",color:"var(--tx3)"}},"Nenhum log ainda.")])]:
        STATE.logs.map(l=>h("tr",[
          h("td",{style:{fontSize:"10px"}},new Date(l.ts).toLocaleTimeString("pt-BR")),
          h("td",{style:{color:"var(--ac)",fontSize:"10px"}},l.user),
          h("td",{style:{color:"var(--gold)",fontSize:"10px"}},l.action),
          h("td",{style:{color:l.status==="ok"?"var(--gr)":l.status==="warn"?"var(--am)":"var(--rd)",fontSize:"10px"}},l.status.toUpperCase()),
          h("td",{style:{fontSize:"9px",color:"var(--tx3)",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},l.notes)
        ]))
      )
    ])
  ]));
  return wrap;
}

// ============================================================
// SETTINGS
// ============================================================
function renderSettings(){
  const wrap=div("",[div("page-header",[div("",[div("page-title","CONFIGURA√á√ïES"),div("page-sub","Sistema, seguran√ßa e prefer√™ncias")])])]);

  wrap.appendChild(div("card",[
    h("p",{class:"card-title",style:{marginBottom:"12px"}},"SISTEMA"),
    ...[["Vers√£o",APP_VERSION],["Idioma","pt-BR"],["Usu√°rio",STATE.user?.username||""],["Role",(STATE.user?.role||"").toUpperCase()],["IA",`${STATE.aiCfg.provider} ¬∑ ${STATE.aiCfg.model}`],["Supabase",STATE.sbClient?"Conectado":"N√£o configurado"]].map(([l,v])=>
      div("",{style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}},[
        h("span",{style:{fontSize:"11px",color:"var(--tx2)"}},l),
        h("span",{style:{fontSize:"11px",color:"var(--ac)",fontFamily:"'JetBrains Mono',monospace"}},v)
      ])
    )
  ]));

  // Password change
  let f={old:"",nw:"",cf:""};
  const pwMsg=div("",{style:{fontSize:"11px",marginTop:"8px"}});

  const pwCard=div("card",[
    h("p",{class:"card-title",style:{marginBottom:"12px"}},"TROCAR SENHA"),
    ...[["Senha atual","old","password"],["Nova senha (m√≠n. 8 chars)","nw","password"],["Confirmar nova senha","cf","password"]].map(([l,k,t])=>div("form-group",[div("form-label",l),h("input",{class:"form-input",type:t,oninput:e=>{f[k]=e.target.value;}})])),
    btn("btn-primary","Alterar Senha",()=>{
      if(!f.old||!f.nw||!f.cf){pwMsg.textContent="Preencha todos os campos.";pwMsg.style.color="var(--rd)";return;}
      if(f.nw!==f.cf){pwMsg.textContent="As senhas n√£o coincidem.";pwMsg.style.color="var(--rd)";return;}
      if(f.nw.length<8){pwMsg.textContent="M√≠nimo 8 caracteres.";pwMsg.style.color="var(--rd)";return;}
      if(f.old!=="dbsa1981"){pwMsg.textContent="Senha atual incorreta.";pwMsg.style.color="var(--rd)";return;}
      pwMsg.textContent="‚úì Senha alterada com sucesso.";pwMsg.style.color="var(--gr)";f={old:"",nw:"",cf:""};
    }),
    pwMsg,
    div("",{style:{marginTop:"14px",padding:"10px 12px",background:"rgba(0,200,240,.04)",borderRadius:"7px",fontSize:"9px",color:"var(--tx3)",lineHeight:"1.7"}},"üîí Produ√ß√£o: bcrypt (cost 12) ¬∑ JWT + refresh token ¬∑ Rate limiting ¬∑ Secret Manager para API keys ¬∑ HTTPS obrigat√≥rio")
  ]);
  wrap.appendChild(pwCard);
  return wrap;
}

// ============================================================
// BOOT
// ============================================================
render();
</script>
</body>
</html>
